/*! textae 4.0.6 11-07-2014 */
!function(a){var c=function(){var a=function(){var a={};return{bind:function(b,c){if(!_.isFunction(c))throw new Error("Only a function is bindable!");return a[b]=a[b]||[],a[b].push(c),this},unbind:function(b,c){return a[b]?(a[b]=_.reject(a[b],function(a){return a===c}),this):this},trigger:function(b,c){return a[b]&&a[b].forEach(function(a){a(c)}),c}}};return{ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||(console.log("POST data",c),$.ajax({type:"post",url:b,contentType:"application/json",data:c,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}})},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}(),extendBindable:function(b){return _.extend({},b,a())}}}(),d=function(a){var b=[];return{makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:Number(c[0]),end:Number(c[1])}},makeTypeId:function(a,c){return-1===b.indexOf(c)&&b.push(c),a+"-"+b.indexOf(c)},makeEntityDomId:function(b){return a.editorId+"__E"+b},makeParagraphId:function(b){return a.editorId+"__P"+b}}},e=function(a){var b=function(a,b){return a.all().filter(function(a){return a.begin<b.begin&&b.begin<a.end&&a.end<b.end||b.begin<a.begin&&a.begin<b.end&&b.end<a.end}).length>0},d=function(){var e,f=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)},g=function(a){var b={},c=function(){return Object.keys(b)},e=_.partial(f,a?a.charAt(0).toUpperCase():"",c),g=function(a){return a.id=a.id||e(),b[a.id]=a,a},h=function(a){return b[a]},i=function(){return _.map(b,_.identity)};return{add:function(b,c){var e=g(b);return _.isFunction(c)&&c(),d.trigger(a+".add",e)},concat:function(a){a&&a.forEach(g)},get:h,all:i,some:function(){return _.some(b)},types:function(){return i().map(function(a){return a.type})},changeType:function(b,c){var e=h(b);return e.type=c,d.trigger(a+".change",e),e},remove:function(c){var e=b[c];return e&&(delete b[c],d.trigger(a+".remove",e)),e},clear:function(){b={}}}},h=function(){var c=new g("span"),e=[],f=function(){var b={isChildOf:function(b){if(!b)return!1;var d=a.makeSpanId(b.begin,b.end);if(!c.get(d))throw new Error("maybeParent is removed. "+b.toStringOnlyThis());return b.begin<=this.begin&&this.end<=b.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+d.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children&&this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=e.indexOf(this),0===a||e[a-1].paragraph!==this.paragraph?null:e[a-1])},getTypes:function(){var b=this.id;return d.entity.all().filter(function(a){return b===a.span}).reduce(function(b,c){var d=a.makeTypeId(c.span,c.type),e=b.filter(function(a){return a.id===d});return e.length>0?e[0].entities.push(c.id):b.push({id:d,name:c.type,entities:[c.id]}),b},[])},getEntities:function(){return _.flatten(this.getTypes().map(function(a){return a.entities}))}};return function(c){return $.extend({},c,{id:a.makeSpanId(c.begin,c.end),paragraph:l.findParagraph(c)},b)}}(),h=function(){var a=c.all().sort(i),b=[];a.map(function(a,b,c){return $.extend(a,{children:[],left:0!==b?c[b-1]:null,right:b!==c.length-1?c[b+1]:null})}).forEach(function(a){var c=b[b.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(c)?(c.children.push(a),a.parent=c):(a.parent=null,b.push(a))}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},e=b},i=function(a,b){return a.begin-b.begin||b.end-a.end},j={add:function(a){return c.add(f(a),h)},concat:function(a){a&&(c.concat(a.map(f).filter(function(a,c,d){return!b({all:function(){return d.slice(0,c-1)}},a)})),h())},get:function(a){return c.get(a)},all:c.all,range:function(a,b){var d=c.get(a),e=c.get(b);if(i(d,e)>0){var f=d;d=e,e=f}return c.all().filter(function(a){return d.begin<=a.begin&&a.end<=e.end}).map(function(a){return a.id})},topLevel:function(){return e},multiEntities:function(){return c.all().filter(function(a){var b=a.getTypes().filter(function(a){return a.entities.length>1});return b.length>0})},remove:function(a){c.remove(a)},clear:function(){c.clear(),e=[]}};return j}(),i=function(){var a=new g("entity"),b=_.extend(a,{assosicatedRelations:function(a){return d.relation.all().filter(function(b){return b.obj===a||b.subj===a}).map(function(a){return a.id})}});return b}(),j=new g("relation"),k=new g("modification"),l=function(){var b;return{set:function(c){var d=0;b=c.split("\n").map(function(b,c){var e={id:a.makeParagraphId(c),begin:d,end:d+b.length};return d+=b.length+1,e})},get:function(){return b},findParagraph:function(a){var c=b.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return c.length>0?c[0]:null}}}(),m=c.extendBindable({span:h,entity:i,relation:j,modification:k,sourceDoc:"",reset:function(){var b=function(a){return e=a,a},c=function(a,b){var c=b.text;if(!c)throw"read failed.";return a.sourceDoc=c,l.set(c),m.trigger("change-text",{sourceDoc:c,paragraphs:l.get()}),b},f=function(b,c){var d=c.denotations;return b.span.clear(),b.entity.clear(),d&&(b.span.concat(d.map(function(a){return a.span})),b.entity.concat(d.map(function(b){return{id:b.id,span:a.makeSpanId(b.span.begin,b.span.end),type:b.obj}}))),c},g=function(a,b){var c=b.relations;return a.relation.clear(),c&&a.relation.concat(c.map(function(a){return{id:a.id,type:a.pred,subj:a.subj,obj:a.obj}})),b},h=function(a,b){var c=b.modifications;return a.modification.clear(),a.modification.concat(c),b};return function(a){var e=_.compose(_.partial(h,this),_.partial(g,this),_.partial(f,this),_.partial(c,this),b);try{e(a),m.trigger("all.change",d)}catch(i){throw alert(i),i}}}(),toJson:function(){var a=d.entity.all().filter(function(a){return d.span.get(a.span)}).map(function(a){var b=d.span.get(a.span);return{id:a.id,span:{begin:b.begin,end:b.end},obj:a.type}});return JSON.stringify($.extend(e,{denotations:a,relations:d.relation.all().map(function(a){return{id:a.id,pred:a.type,subj:a.subj,obj:a.obj}}),modifications:d.modification.all()}))},isBoundaryCrossingWithOtherSpans:_.partial(b,h),getModificationOf:function(a){return k.all().filter(function(b){return b.obj===a})}});return m}(),e=function(){var a=function(a){var b={},c=function(){f.trigger(a+".change")},d={name:a,add:function(d){b[d]=d,f.trigger(a+".select",d),c()},all:function(){return _.toArray(b)},has:function(a){return _.contains(b,a)},some:function(){return _.some(b)},single:function(){var a=d.all();return 1===a.length?a[0]:null},toggle:function(a){d.has(a)?d.remove(a):d.add(a)},remove:function(d){delete b[d],f.trigger(a+".deselect",d),c()},clear:function(){_.each(d.all(),d.remove),b={},c()}};return d},b=function(a){_.each(a,function(a){a.clear()})},d=function(a){return a.map(function(a){return a.some()}).reduce(function(a,b){return a||b})},e=["span","entity","relation"].map(function(b){return new a(b)}),f=c.extendBindable(_.extend(e.reduce(function(a,b){return a[b.name]=b,a},{}),{clear:_.partial(b,e),some:_.partial(d,e)}));return f}();return{annotationData:d,selectionModel:e,getReplicationSpans:function(a,b){var c=function(a){for(var b=String.prototype.indexOf.bind(d.sourceDoc,d.sourceDoc.substring(a.begin,a.end)),c=a.end-a.begin,e=[],f=0,g=b(f);-1!==g;g=b(f))e.push({begin:g,end:g+c}),f=g+c;return e},e=function(b){return b.begin===a.begin},f=function(a){var c=d.sourceDoc.charAt(a.begin-1),e=d.sourceDoc.charAt(a.end);return b.isDelimiter(c)&&b.isDelimiter(e)},g=function(a){return d.span.all().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0};return c(a).filter(function(a){return!e(a)&&f(a)&&!g(a)&&!d.isBoundaryCrossingWithOtherSpans(a)})}}},f=function(){var a=-1,b=-1,d=[],e=function(){return b>-1},f=function(){return b<d.length-1},g=function(){return b!=a},h=function(){i.trigger("change",{hasAnythingToSave:g(),hasAnythingToUndo:e(),hasAnythingToRedo:f()})},i=c.extendBindable({reset:function(){a=-1,b=-1,d=[],h()},push:function(a){d.splice(b+1,d.length-b,a),b++,h()},next:function(){return b++,h(),d[b]},prev:function(){var a=d[b];return b--,h(),a},saved:function(){a=b,h()},hasAnythingToSave:g,hasAnythingToUndo:e,hasAnythingToRedo:f});return i},h=function(a,b,c,d){var e=function(a){a.forEach(function(a){a.execute()})},f=function(){var c=function(a,b){b?console.log("[command.invoke]",a,b):console.log("[command.invoke]",a)},e=function(a,c,d){if(b.selectionModel[a]){var e=_.partial(b.selectionModel[a].add,d.id);c.delaySelect?_.delay(e,c.delaySelect):e()}},g=function(a,d,g){return{execute:function(){g=b.annotationData[a].add(g),d&&e(a,d,g),this.revert=_.partial(f[a+"RemoveCommand"],g.id),c("create a new "+a+": ",g)}}},h=function(a,d){return{execute:function(){var e=b.annotationData[a].get(d);b.annotationData[a].remove(d),this.revert=_.partial(g,a,!1,e),c("remove a "+a+": ",e)}}},i=function(a,d,e){return{execute:function(){var g=b.annotationData[a].get(d).type,h=b.annotationData[a].changeType(d,e);this.revert=_.partial(f[a+"ChangeTypeCommand"],d,g),c("change type of a "+a+". oldtype:"+g+" "+a+":",h)}}};return{spanCreateCommand:_.partial(g,"span",!0),spanRemoveCommand:_.partial(h,"span"),spanMoveCommand:function(d,e,g){return{execute:function(){var h=[],i=a.makeSpanId(e,g);b.annotationData.span.get(i)||(h.push(f.spanRemoveCommand(d)),h.push(f.spanCreateCommand({begin:e,end:g})),b.annotationData.span.get(d).getTypes().forEach(function(a){a.entities.forEach(function(b){h.push(f.entityCreateCommand({id:b,span:i,type:a.name}))})})),h.forEach(function(a){a.execute()});var j=a.parseSpanId(d);this.revert=_.partial(f.spanMoveCommand,i,j.begin,j.end),c("move a span, spanId:"+d+", newBegin:"+e+", newEnd:"+g)}}},spanReplicateCommand:function(a){var e=function(b){var d=function(a){return a.revert()},e=function(a){a.execute()},f={execute:function(){b.map(d).forEach(e),c("revert replicate a span, begin:"+a.begin+", end:"+a.end)}};return function(){return f}};return{execute:function(){var g=b.getReplicationSpans(a,d).map(f.spanCreateCommand);g.forEach(function(a){a.execute()}),this.revert=new e(g),c("replicate a span, begin:"+a.begin+", end:"+a.end)}}},entityCreateCommand:_.partial(g,"entity",!0),entityRemoveCommand:_.partial(h,"entity"),entityChangeTypeCommand:_.partial(i,"entity"),relationCreateCommand:_.partial(g,"relation",{delaySelect:100}),relationRemoveCommand:_.partial(h,"relation"),relationChangeTypeCommand:_.partial(i,"relation"),modificationCreateCommand:_.partial(g,"modification",!1),modificationRemoveCommand:_.partial(h,"modification")}}();return{invoke:function(a){a&&a.length>0&&(e(a),c.push(a))},undo:function(){var a=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};return function(){if(c.hasAnythingToUndo()){b.selectionModel.clear();var d=new a(c.prev());e(d)}}}(),redo:function(){c.hasAnythingToRedo()&&(b.selectionModel.clear(),e(c.next()))},factory:f}},i=function(a,c,d){var e=function(){var a=function(a){return a.addClass("ui-selected")},b=function(a){return a.removeClass("ui-selected")};return{addClass:a,removeClass:b}}(),f=function(){var b=function(a,b){var c={},d="something";return{setDefinedTypes:function(a){c=a},setDefaultType:function(a){d=a},getDefaultType:function(){return d||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},c=function(a,b){void 0!==b&&(a.setDefinedTypes(b.map(function(a){return a}).reduce(function(a,b){return a[b.name]=b,a},{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||""))},g=new b(d.annotationData.entity.types,"#77DDDD"),h=new b(d.annotationData.relation.types,"#555555"),i=function(){var b=function(b){var c=!1,d=function(a){return void 0===a?c:(c=a,void f())},e=function(){c=!c,f()},f=function(){a.tool.push(b,c)};return{name:b,value:d,toggle:e,propagate:f}},c=["replicate-auto","relation-edit-mode","negation","speculation"].map(b).reduce(function(a,b){return a[b.name]=b,a},{});return _.extend(c,{propagate:function(){_.each(this,function(a){a.propagate&&a.propagate()})}})}(),j=function(){var b={},c=function(a,c){b[a]=c},d=function(){a.tool.changeButtonState(a,b)};return{set:c,propagate:d}}(),k=function(){var a=d.selectionModel,b=function(a,b){return a()&&b()},c=function(a,b){return a()||b()},e=function(){return f.clipBoard.length>0},g=_.partial(c,a.span.some,a.entity.some),h=_.partial(c,a.entity.some,a.relation.some),i={replicate:a.span.single,entity:a.span.some,"delete":a.some,copy:g,paste:_.partial(b,e,a.span.some),pallet:h,"change-label":h,negation:h,speculation:h};return function(a){a.forEach(function(a){j.set(a,i[a]())})}}(),l=function(){var a=function(a,b){return b.length>0&&_.every(b,function(b){return _.contains(b,a)})},b=function(b,c){i[b.toLowerCase()].value(a(b,c))};return function(a){var c=a.all().map(function(a){return d.annotationData.getModificationOf(a).map(function(a){return a.pred})});b("Negation",c),b("Speculation",c)}}();return{clipBoard:[],modeAccordingToButton:i,buttonStateHelper:function(){var a=["replicate","entity","delete","copy","paste"],b=["pallet","change-label","negation","speculation","delete"],c=b.concat(["copy"]),e=_.compose(i.propagate,j.propagate),f=_.partial(_.compose,e);return{propagate:e,enabled:f(j.set),updateBySpan:f(_.partial(k,a)),updateByEntity:_.compose(e,_.partial(l,d.selectionModel.entity),_.partial(k,c)),updateByRelation:_.compose(e,_.partial(l,d.selectionModel.relation),_.partial(k,b))}}(),viewMode:function(){var b=function(b){a.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+b+"-mode")},c=function(a){f.modeAccordingToButton["relation-edit-mode"].value(a)},g=function(a){var b=p.selector.entity.get(a),c=b.parent(),d=c.prev();c.children().length===c.find(".ui-selected").length?e.addClass(d):e.removeClass(d),f.buttonStateHelper.updateByEntity()};return{marginBottomOfGrid:0,isTerm:function(){return a.hasClass("textae-editor_term-mode")},setTerm:function(){b("term"),c(!1),f.viewMode.marginBottomOfGrid=0,d.selectionModel.unbind("entity.select",g).unbind("entity.deselect",g).unbind("entity.change",g).bind("entity.select",g).bind("entity.deselect",g).bind("entity.change",f.buttonStateHelper.updateByEntity)},setInstance:function(){b("instance"),c(!1),f.viewMode.marginBottomOfGrid=2,d.selectionModel.unbind("entity.select",g).unbind("entity.deselect",g).unbind("entity.change",f.buttonStateHelper.updateByEntity).bind("entity.select",g).bind("entity.deselect",g).bind("entity.change",f.buttonStateHelper.updateByEntity)},setRelation:function(){b("relation"),c(!0),f.viewMode.marginBottomOfGrid=2,d.selectionModel.unbind("entity.select",g).unbind("entity.deselect",g).unbind("entity.change",f.buttonStateHelper.updateByEntity)},setEditable:function(b){b?a.addClass("textae-editor_editable"):(a.removeClass("textae-editor_editable"),f.buttonStateHelper.enabled("replicate-auto",!1),f.buttonStateHelper.enabled("relation-edit-mode",!1))}}}(),typeContainer:{entity:g,setDefinedEntityTypes:_.partial(c,g),relation:h,setDefinedRelationTypes:_.partial(c,h)}}}(),h=function(){var a={},b=function(b,c){return a[b]=c,c},c=function(b){return a[b]},d=function(b){delete a[b]},e=function(){a={}};return{set:b,get:c,remove:d,clear:e}},i=_.extend(new h,{isGridPrepared:function(a){var b=d.annotationData.entity.get(a).span;return i.get(b)}}),j=function(){var b=new h,c=function(a,c,d){var e=a+d;return b.get(e)?b.get(e):b.set(e,c(d))},e=_.partial(c,"TEXT_NODE",function(){return a.find(".textae-editor__body__text-box").offset()}),f=function(a){var b=p.selector.span.get(a);if(0===b.length)throw new Error("span is not renderd : "+a);var c=b.offset();return{top:c.top-e().top,left:c.left-e().left,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}},g=function(a){var b=d.annotationData.entity.get(a).span,c=p.selector.entity.get(a);if(0===c.length)throw new Error("entity is not rendered : "+a);var e=i.get(b),f=c.get(0);return{top:e.top+f.offsetTop,center:e.left+f.offsetLeft+c.outerWidth()/2}};return{reset:b.clear,getSpan:_.partial(c,"S",f),getEntity:_.partial(c,"E",g)}}(),k=new h,l=function(a){return k.get(a)},m=function(){var a=function(a,b){var c=i.get(a.id);return c&&c.top===b.top&&c.left===b.left?void 0:b},b=function(a){_.compact(_.flatten(a.getEntities().map(d.annotationData.entity.assosicatedRelations)).map(l)).forEach(function(a){a.arrangePosition()})},c=function(a){return a?p.selector.grid.get(a.id):void 0},e=function(a,d){return d?(c(a).css(d),i.set(a.id,d),b(a),a):void 0},g=function(a){var b=function(a){var b=j.getSpan(a.id);return{top:b.top-f.viewMode.marginBottomOfGrid-c(a).outerHeight(),left:b.left}},d=function(a){var b=function(a){var d=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return b(a)}));return c(a).outerHeight()+d+f.viewMode.marginBottomOfGrid},d=j.getSpan(a.id),e=b(a);return{top:d.top-f.viewMode.marginBottomOfGrid-e,left:d.left}};return 0===a.children.length?b(a):d(a)},h=function(a){return a&&a.hasClass("hidden")?a:void 0},k=function(a){a&&a.removeClass("hidden")},m=function(b){var d=_.compose(_.partial(e,b),_.partial(a,b));_.compose(k,h,c,d,g)(b)},n=function(a){a.children.forEach(function(a){n(a)}),a.getTypes().length>0&&m(a)},o=function(){j.reset(),d.annotationData.span.topLevel().forEach(function(a){_.defer(_.partial(n,a))})};return{reset:i.clear,remove:i.remove,updateDisplay:_.throttle(o,10)}}(),n=function(a){var b=p.selector.entity.get(a);e.addClass(b)},o=function(){var e=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},h=_.partial(e,a,"div","textae-editor__body"),o=function(){return e(h(),"div","textae-editor__body__annotation-box")},q=function(a){var b=function(){return e(h(),"div","textae-editor__body__text-box")},c=function(a){return a.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph-margin"><span class="textae-editor__body__text-box__paragraph">'+a+"</span></p>"}).join("\n")},d=function(a){var c={};return b().find(".textae-editor__body__text-box__paragraph").each(function(b,d){var e=$(d),f=$.extend({},a[b],{element:e});e.attr("id",f.id),c[f.id]=f}),c};b().html(c(a.sourceDoc)),f.paragraphs=d(a.paragraphs)},s=function(a){var b=function(a){a.span.topLevel().forEach(function(a){t.span.render(a)})},c=function(a){t.relation.reset(),a.relation.all().forEach(t.relation.render)};o().empty(),m.reset(),b(a),c(a)},t=function(){var e=function(a){return a.remove()},h=function(a){e(p.selector.grid.get(a)),m.remove(a)},o=function(){var a=function(a,b){var c=j.getSpan(b),d=$("<div>").attr("id","G"+b).addClass("textae-editor__grid").addClass("hidden").css({width:c.width});return a.append(d),d},b=function(b){o.render=_.partial(a,b)};return{init:b,render:null}}(),q=function(a){return d.annotationData.getModificationOf(a).map(function(a){return"textae-editor__"+a.pred.toLowerCase()}).join(" ")},s=function(){var a="textae-editor__negation textae-editor__speculation";return function(b,c){b.removeClass(a),b.addClass(q(c))}}(),t=function(){var a=function(a){var b=function(a,b){var c=a.begin-b,d=a.end-b;return{start:c,end:d}},c=function(a,b,c){if(a.start<0||b.length<a.end)throw new Error("oh my god! I cannot render this span. "+c.toStringOnlyThis()+", textNode "+b.textContent)},d=function(a,b){var c=document.createRange();return c.setStart(a,b.start),c.setEnd(a,b.end),c},e=function(a,e,f){var g=b(a,e);return c(g,f,a),d(f,g)},g=function(){return 3===this.nodeType},h=function(a){return a.contents().filter(g).get(0)},i=function(a){return f.paragraphs[a].element},j=function(a,b,c){var d=_.compose(h,a),f=d(c.id);return e(b,c.begin,f)},k=_.partial(j,p.selector.span.get),l=_.partial(j,i),m=a.getBigBrother();return m?e(a,m.end,document.getElementById(m.id).nextSibling):a.parent?k(a,a.parent):l(a,a.paragraph)},b=function(b,c){return a(b).surroundContents(c),b},c=function(a){var b=document.createElement("span");return b.setAttribute("id",a.id),b.setAttribute("title",a.id),b.setAttribute("class","textae-editor__span"),b},g=function(a){return b(a,c(a))},i=function(a){a.entities.forEach(_.compose(u.render,d.annotationData.entity.get))},j=function(a){return a.getTypes().forEach(i),a},k=function(a){return null!==document.getElementById(a.id)},l=function(a){return!a},m=function(a){for(var b=document.getElementById(a.id),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);e($(b)),c.normalize(),h(a.id)},n=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),m(a)};return a.children.filter(k).forEach(b),a},o=function(a){return a.children.filter(_.compose(l,k)).forEach(q),a},q=_.compose(o,j,g,n);return{render:q,remove:m}}(),u=function(){var a=function(a,b){return $("#"+c.makeTypeId(a,b))},b=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},g=function(a){return 0===d.annotationData.span.get(a).getTypes().length},i=function(c){var f=function(a){return 0===d.annotationData.span.get(c.span).getTypes().filter(function(b){return b.name===a}).length},g=e(p.selector.entity.get(c.id)).attr("type");f(g)?a(c.span,g).remove():b(a(c.span,g).find(".textae-editor__entity-pane"))},j=function(d){var e=function(b,d){var e=function(a){return String(a).indexOf("http")>-1},g=function(a){if(e(a)){var b=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi,c=b.exec(a);if(c)return c[9]?c[9].slice(1):c[6]?c[6]+(c[7]||""):c[5]?c[5].split("/").filter(function(a){return""!==a}).pop():c[3]}return a},h=function(a){return e(a)?a:f.typeContainer.entity.getUri(a)?f.typeContainer.entity.getUri(a):void 0},i=function(a,b){var d=c.makeTypeId(a,b),e=$("<div>").attr("id","P-"+d).addClass("textae-editor__entity-pane"),i=$("<div>").addClass("textae-editor__type-label").css({"background-color":f.typeContainer.entity.getColor(b)}),j=h(b);return j?i.append($('<a target="_blank"/>').attr("href",j).text(g(b))):i.text(g(b)),$("<div>").attr("id",d).addClass("textae-editor__type").append(i).append(e)},j=function(a){var b=p.selector.grid.get(a);return 0===b.length?o.render(a):b},k=a(b,d);return 0===k.length&&(k=i(b,d),j(b).append(k)),k},g=function(a){var b=$("<div>").attr("id",c.makeEntityDomId(a.id)).attr("title",a.id).attr("type",a.type).addClass("textae-editor__entity").css({"border-color":f.typeContainer.entity.getColor(a.type)});return b.addClass(q(a.id)),b};d.type=String(d.type);var h=e(d.span,d.type).find(".textae-editor__entity-pane").append(g(d));b(h)},k=function(a){i(a),j(a),d.selectionModel.entity.has(a.id)&&n(a.id)},l=function(a){var b=p.selector.entity.get(a.id);s(b,a.id)},m=function(a){g(a.span)?h(a.span):i(a)};return{render:j,change:k,changeModification:l,remove:m}}(),v=function(){var c,e=function(a){var b=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return b.setRenderMode(b.SVG),b.Defaults.Container=a,b},h=function(a){c=e(a)},m=function(a){var c=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"},e=d.annotationData.relation.get(a).type,h=f.typeContainer.relation.getColor(e);return{lineWidth:1,strokeStyle:c(h,1)}},n={cssClass:"textae-editor__relation__label",id:"label"},o=function(a){var b=a.getOverlay(n.id);if(!b)throw"no label overlay";return b},t=function(){var b={width:7,length:9,location:1,id:"normal-arrow"},e={width:14,length:18,location:1,id:"hover-arrow"},f=function(a){return{sourceId:d.annotationData.relation.get(a).subj,targetId:d.annotationData.relation.get(a).obj}},g=function(a){var b=f(a),c=j.getEntity(b.sourceId),d=j.getEntity(b.targetId),e=c.center,g=d.center,h=c.top,i=d.top,k=Math.abs(e-g),l=Math.abs(h-i),m=k*v.settings.xrate+l*v.settings.yrate+v.settings.c_offset;return m/=2.4},h=function(){var a=function(a){var b=f(a);return i.isGridPrepared(b.sourceId)&&i.isGridPrepared(b.targetId)},d=function(a,d){return c.connect({source:p.selector.entity.get(a.subj),target:p.selector.entity.get(a.obj),anchors:["TopCenter","TopCenter"],connector:["Bezier",d],paintStyle:new m(a.id),parameters:{id:a.id},cssClass:"textae-editor__relation",overlays:[["Arrow",b],["Label",_.extend({},n,{label:"["+a.id+"] "+a.type,cssClass:n.cssClass+" "+q(a.id)})]]})};return function(b){var c=!a(b.id),e=c?{}:{curviness:g(b.id)},f=d(b,e);return c&&f.setVisible(!1),f}}(),r=function(){var a=function(a){var c=function(a){var c=l(a);c.endpoints[0].repaint(),c.endpoints[1].repaint(),c.removeOverlay("normal-arrow"),c.setConnector(["Bezier",{curviness:g(a)}]),c.addOverlay(["Arrow",b]),c.isVisible()||c.setVisible(!0)},d=function(a){var c=function(c){c.removeOverlay(b.id),c.addOverlay(["Arrow",e]),c.setPaintStyle(_.extend(a(),{lineWidth:3}))},d=function(c){c.removeOverlay(e.id),c.addOverlay(["Arrow",b]),c.setPaintStyle(a())},f=function(a){new o(a).addClass("hover")},g=function(a){new o(a).removeClass("hover")},h=function(a){new o(a).addClass("ui-selected")},i=function(a){new o(a).removeClass("ui-selected")},j=function(a){a.addClass("ui-selected")},k=function(a){a.removeClass("ui-selected")};return{pointup:function(){this.hasClass("ui-selected")||(c(this),f(this))},pointdown:function(){this.hasClass("ui-selected")||(d(this),g(this))},select:function(){c(this),g(this),h(this),j(this)},deselect:function(){d(this),i(this),k(this)}}},f=function(a){this.bind("click",a),this.getOverlay(n.id).bind("click",function(b,c){a(b.component,c)})},h=_.partial(m,a);return _.extend({hasClass:function(a){return this.connector.canvas.classList.contains(a)},arrangePosition:_.debounce(_.partial(c,a),20),bindClickAction:f},new d(h))};return function(b){var c=b.getParameter("id");return _.extend(b,new a(c))}}(),s=function(){var a=function(a,b,c){a.bind("mouseenter",b).bind("mouseexit",c)},b=function(a){a.pointup()},c=function(a){a.pointdown()},d=function(a){return a.component};return function(e){return a(e,b,c),a(new o(e),_.compose(b,d),_.compose(c,d)),e}}(),t=function(a){var b=a.getParameter("id");return k.set(b,a),a},u=function(b){return a.trigger("textae.editor.jsPlumbConnection.add",b),b};return _.compose(u,t,s,r,h)}(),u=function(a){var b=l(a);if(!b)throw"no connect";return b},w=function(a){var b=new u(a.id),c=new o(b);c.setLabel("["+a.id+"] "+a.type),b.setPaintStyle(new m(a.id))},x=function(a){var b=new u(a.id),c=new o(b);s(c,a.id)},y=function(a){c.detach(l(a.id)),k.remove(a.id)};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},init:h,reset:function(){c.reset(),k.clear()},render:t,change:w,changeModification:x,remove:y}}();return{init:function(a){o.init(a),v.init(a)},span:t,entity:u,relation:v}}(),u=function(a){return a.id},v=_.partial(_.compose,m.updateDisplay),w=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},x=function(a,b){var c=d.annotationData[a].get(b.obj);return c&&(t[a].changeModification(c),f.buttonStateHelper["updateBy"+w(a)]()),b},y=_.partial(x,"entity"),z=_.partial(x,"relation"),A=_.compose(y,z);return{setModelHandler:function(){t.init(o()),d.annotationData.bind("change-text",q).bind("all.change",_.compose(d.selectionModel.clear,s)).bind("span.add",v(t.span.render)).bind("span.remove",v(t.span.remove)).bind("span.remove",_.compose(d.selectionModel.span.remove,u)).bind("entity.add",v(t.entity.render)).bind("entity.change",v(t.entity.change)).bind("entity.remove",v(t.entity.remove)).bind("entity.remove",_.compose(d.selectionModel.entity.remove,u)).bind("relation.add",t.relation.render).bind("relation.change",t.relation.change).bind("relation.remove",t.relation.remove).bind("relation.remove",_.compose(d.selectionModel.relation.remove,u)).bind("modification.add",A).bind("modification.remove",A)}}}(),p={selector:{span:{get:function(b){return a.find("#"+b)}},entity:{get:function(a){return $("#"+c.makeEntityDomId(a))}},grid:{get:function(b){return a.find("#G"+b)}}},manipulate:{dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}}},q=function(){var a=function(a,b){d.annotationData.entity.assosicatedRelations(b).map(l).forEach(a)};return{on:_.partial(a,function(a){a.pointup()}),off:_.partial(a,function(a){a.pointdown()})}}(),s=function(){var b=function(b){a.find(".textae-editor__body__text-box").css({"line-height":b+"px","margin-top":b/2+"px"})},c=function(a){var c=23,e=6,g=64,h=_.max(d.annotationData.span.all().map(function(b){var d=c+e,g=function(b){d+=b.getTypes().length*a+f.viewMode.marginBottomOfGrid,b.parent&&g(b.parent)};return g(b),d}).concat(g));b(h)};return{getLineHeight:function(){return parseInt(a.find(".textae-editor__body__text-box").css("line-height"))/16},changeLineHeight:b,calculateLineHeight:c,changeTypeGap:function(b){a.find(".textae-editor__type").css({height:18*b+18+"px","padding-top":18*b+"px"}),m.updateDisplay()},redraw:m.updateDisplay}}(),t=function(){var a=function(a){var b=p.selector.span.get(a);e.addClass(b)},b=function(a){var b=p.selector.span.get(a);e.removeClass(b)},c=function(a){var b=p.selector.entity.get(a);e.removeClass(b)},g=function(a){var b=function(a){a&&a.select()},c=_.compose(b,l);c(a)},h=function(a){var b=function(a){a&&a.deselect()},c=_.compose(b,l);c(a)};d.selectionModel.bind("span.select",a).bind("span.deselect",b).bind("span.change",f.buttonStateHelper.updateBySpan).bind("entity.select",n).bind("entity.deselect",c).bind("relation.select",g).bind("relation.deselect",h).bind("relation.change",f.buttonStateHelper.updateByRelation)
};return{init:_.compose(t,o.setModelHandler),viewModel:f,domUtil:p,hoverRelation:q,helper:s}},j=function(a,b,d,e,f,g){var h={BLOCK_THRESHOLD:100},i=null,j=function(){return function(a,b){i&&!b.processedByTextae&&i(a,b),b.processedByTextae=!0}}(),k=function(){l.viewHandler.hideDialogs(),a.tool.selectMe(),e.viewModel.buttonStateHelper.propagate()},l=function(){var j;return{editHandler:function(){var a=function(){return function(a){var b,c=function(b){return b.pred===a},g=function(a){return d.annotationData.getModificationOf(a).filter(c)},h=e.viewModel.modeAccordingToButton[a.toLowerCase()].value();b=h?getSelectedIdEditable().map(function(a){var b=g(a)[0];return f.factory.modificationRemoveCommand(b.id)}):_.reject(getSelectedIdEditable(),function(a){return g(a).length>0}).map(function(b){return f.factory.modificationCreateCommand({obj:b,pred:a})}),f.invoke(b)}}();return{replicate:function(){var a=d.selectionModel.span.single();a?f.invoke([f.factory.spanReplicateCommand(d.annotationData.span.get(a))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=d.selectionModel.span.all().map(function(a){return f.factory.entityCreateCommand({span:a,type:e.viewModel.typeContainer.entity.getDefaultType()})});f.invoke(a)},setEntityType:function(){var a=$(this).attr("label");return j(a),!1},newLabel:function(){if(d.selectionModel.entity.some()||d.selectionModel.relation.some()){var a=prompt("Please enter a new label","");a&&j(a)}},negation:_.partial(a,"Negation"),speculation:_.partial(a,"Speculation"),removeSelectedElements:function(){var a=function(){var a=[],b=[],c=[];return{addSpanId:function(b){a.push(b)},addEntityId:function(a){b.push(a)},addRelations:function(a){c=c.concat(a)},getAll:function(){return _.uniq(c).map(f.factory.relationRemoveCommand).concat(_.uniq(b).map(function(a){return f.factory.entityRemoveCommand(a)}),_.uniq(a).map(f.factory.spanRemoveCommand))}}}(),b=function(b){a.addEntityId(b),a.addRelations(d.annotationData.entity.assosicatedRelations(b))};d.selectionModel.span.all().forEach(function(c){a.addSpanId(c),d.annotationData.span.get(c).getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),d.selectionModel.entity.all().forEach(function(a){b(a)}),a.addRelations(d.selectionModel.relation.all()),f.invoke(a.getAll())},copyEntities:function(){e.viewModel.clipBoard=_.uniq(function(){return _.flatten(d.selectionModel.span.all().map(function(a){return d.annotationData.span.get(a).getEntities()}))}().concat(d.selectionModel.entity.all()))},pasteEntities:function(){var a=_.flatten(d.selectionModel.span.all().map(function(a){return e.viewModel.clipBoard.map(function(b){return f.factory.entityCreateCommand({span:a,type:d.annotationData.entity.get(b).type})})}));f.invoke(a)}}}(),viewHandler:function(){var k={},m=function(){var c=function(a,b,c){var d=a();if(d.length>0){var e=d.map(function(a){return b(a,c)});f.invoke(e)}},m=function(){return a.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("mouseup",".textae-editor__entity")};return{relationEdit:function(){var a=function(a){if(d.selectionModel.entity.some()){var b=d.selectionModel.entity.all()[0],c=$(a.target).attr("title");b===c?d.selectionModel.entity.remove(b):(d.selectionModel.entity.add(c),_.defer(function(){if(f.invoke([f.factory.relationCreateCommand({subj:b,obj:c,type:e.viewModel.typeContainer.relation.getDefaultType()})]),a.ctrlKey||a.metaKey)d.selectionModel.entity.remove(c);else{if(a.shiftKey)return e.domUtil.manipulate.dismissBrowserSelection(),d.selectionModel.entity.remove(b),d.selectionModel.entity.add(c),!1;d.selectionModel.entity.remove(b),d.selectionModel.entity.remove(c)}}))}else d.selectionModel.clear(),d.selectionModel.entity.add($(a.target).attr("title"));return!1},b=function(a,b){var c=a.getParameter("id");b.ctrlKey||b.metaKey?d.selectionModel.relation.toggle(c):(d.selectionModel.clear(),d.selectionModel.relation.add(c))},g=function(){return!1};return function(){m().on("mouseup",".textae-editor__entity",a).on("mouseup",".textae-editor__relation, .textae-editor__relation__label",g).on("mouseup",".textae-editor__body",l.viewHandler.cancelSelect),k.typeContainer=e.viewModel.typeContainer.relation,getSelectedIdEditable=d.selectionModel.relation.all,j=_.partial(c,getSelectedIdEditable,f.factory.relationChangeTypeCommand),i=b}}(),noRelationEdit:function(){var a=function(){var a=function(a){var b,c=$(a).parent(),f=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=e.viewModel.paragraphs[f].begin;else{if(!c.hasClass("textae-editor__span"))return void console.log(f);b=d.annotationData.span.get(f).begin}for(var g=a.parentElement.childNodes,h=0;g[h]!=a;h++)b+="#text"==g[h].nodeName?g[h].nodeValue.length:$("#"+g[h].id).text().length;return b},c=function(b){var c=a(b.focusNode);return c+=b.focusOffset},i=function(b){var c=a(b.anchorNode);return c+b.anchorOffset},j=function(a){for(var b=a;g.isNonEdgeCharacter(d.annotationData.sourceDoc.charAt(b));)b++;for(;b>0&&!g.isDelimiter(d.annotationData.sourceDoc.charAt(b))&&!g.isDelimiter(d.annotationData.sourceDoc.charAt(b-1));)b--;return b},k=function(a){for(var b=a;g.isNonEdgeCharacter(d.annotationData.sourceDoc.charAt(b-1));)b--;for(;!g.isDelimiter(d.annotationData.sourceDoc.charAt(b))&&b<d.annotationData.sourceDoc.length;)b++;return b},m=function(a){for(var b=a;b<d.annotationData.sourceDoc.length&&(g.isNonEdgeCharacter(d.annotationData.sourceDoc.charAt(b))||!g.isDelimiter(d.annotationData.sourceDoc.charAt(b-1)));)b++;return b},n=function(a){for(var b=a;b>0&&(g.isNonEdgeCharacter(d.annotationData.sourceDoc.charAt(b-1))||!g.isDelimiter(d.annotationData.sourceDoc.charAt(b)));)b--;return b},o=function(a,c){if(d.annotationData.isBoundaryCrossingWithOtherSpans({begin:a,end:c}))return void e.domUtil.manipulate.dismissBrowserSelection();var g=b.makeSpanId(a,c);if(d.annotationData.span.get(g))return void e.domUtil.manipulate.dismissBrowserSelection();var i=[f.factory.spanCreateCommand({begin:a,end:c})];e.viewModel.modeAccordingToButton["replicate-auto"].value()&&c-a<=h.BLOCK_THRESHOLD&&i.push(f.factory.spanReplicateCommand({begin:a,end:c})),f.invoke(i),e.domUtil.manipulate.dismissBrowserSelection()},p=function(a){if(a.anchorNode.parentElement.id!==a.focusNode.parentElement.id)return console.log(a.anchorNode.parentElement.id,a.focusNode.parentElement.id),!1;var b=i(a),f=c(a);if(b>f){var h=b;b=f,f=h}var l=d.annotationData.sourceDoc.substring(b,f);return g.nonEdgeCharacters.forEach(function(a){l=l.replace(a,"")}),0===l.length?(e.domUtil.manipulate.dismissBrowserSelection(),!0):(d.selectionModel.clear(),o(j(b),k(f)),!0)},q=function(a,c,d){return a!==b.makeSpanId(c,d)?[f.factory.spanMoveCommand(a,c,d)]:void 0},r=function(a,b){var e=[],g=c(b),h=b.getRangeAt(0),i=document.createRange();if(i.selectNode(b.anchorNode),h.compareBoundaryPoints(Range.START_TO_START,i)<0){var l=j(g);e=q(a,l,d.annotationData.span.get(a).end)}else{var m=k(g);e=q(a,d.annotationData.span.get(a).begin,m)}f.invoke(e)},s=function(a,e){var g=[],h=c(e),i=e.getRangeAt(0),j=document.createRange();j.selectNode(e.focusNode);var k,o=function(a){return[f.factory.spanRemoveCommand(a)]};if(i.compareBoundaryPoints(Range.START_TO_START,j)>0){var p=n(h);p>d.annotationData.span.get(a).begin?(k=b.makeSpanId(d.annotationData.span.get(a).begin,p),g=d.annotationData.span.get(k)?o(a):q(a,d.annotationData.span.get(a).begin,p)):(d.selectionModel.span.add(a),l.editHandler.removeSelectedElements())}else{var r=m(h);r<d.annotationData.span.get(a).end?(k=b.makeSpanId(r,d.annotationData.span.get(a).end),g=d.annotationData.span.get(k)?o(a):q(a,r,d.annotationData.span.get(a).end)):(d.selectionModel.span.add(a),l.editHandler.removeSelectedElements())}f.invoke(g)},t=function(a){var b=d.selectionModel.span.single();if(b){var c=d.annotationData.span.get(b);return c.begin<a&&a<c.end}return!1},u=function(a){if(a.anchorNode.parentNode.parentNode===a.focusNode.parentNode)return d.selectionModel.clear(),r(a.anchorNode.parentNode.id,a),e.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(i(a))){var b=d.selectionModel.span.all()[0];return e.domUtil.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id?(r(b,a),e.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be expanded to make a boundary crossing."),e.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},v=function(a){if(a.anchorNode.parentNode===a.focusNode.parentNode.parentNode)return d.selectionModel.clear(),s(a.focusNode.parentNode.id,a),e.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(c(a))){var b=d.selectionModel.span.all()[0];return a.focusNode.parentNode.id===b?(s(b,a),e.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be shrinked to make a boundary crossing."),e.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},w=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),e.domUtil.manipulate.dismissBrowserSelection()};return{createSpanIfOneParent:p,expandIfable:u,shrinkIfable:v,overParagraph:w}}(),n=function(b){return 3!==b.anchorNode.nodeType||3!==b.focusNode.nodeType?!0:a.createSpanIfOneParent(b)?!1:a.expandIfable(b)?!1:(a.overParagraph(),!1)},o=function(){var a=window.getSelection();return a.isCollapsed?(l.viewHandler.cancelSelect(),!0):n(a)},p=function(b){return 3!==b.anchorNode.nodeType||3!==b.focusNode.nodeType?!0:a.createSpanIfOneParent(b)?!1:a.expandIfable(b)?!1:a.shrinkIfable(b)?!1:(a.overParagraph(),!1)},q=function(a){var b=window.getSelection();if(b.isCollapsed){var c=d.selectionModel.span.single();if(a.shiftKey&&c){var e=$(this).attr("id");d.selectionModel.clear(),d.annotationData.span.range(c,e).forEach(function(a){d.selectionModel.span.add(a)})}else a.ctrlKey||a.metaKey?d.selectionModel.span.toggle(a.target.id):(d.selectionModel.clear(),d.selectionModel.span.add(a.target.id));return!1}return p(b)},r=function(a,b,c){var e=function(a){a.each(function(){d.selectionModel.entity.add($(this).attr("title"))})},f=function(a){a.each(function(){d.selectionModel.entity.remove($(this).attr("title"))})};return a?b.hasClass("ui-selected")?f(c):e(c):(d.selectionModel.clear(),e(c)),!1},s=function(a){var b=$(a.target);return r(a.ctrlKey||a.metaKey,b,b.next().children())},t=function(a){var b=$(a.target);return a.ctrlKey||a.metaKey?d.selectionModel.entity.toggle(b.attr("title")):(d.selectionModel.clear(),d.selectionModel.entity.add(b.attr("title"))),!1},u=function(a){var b=$(a.target);return r(a.ctrlKey||a.metaKey,b.prev(),b.children())};return function(){m().on("mouseup",".textae-editor__body",o).on("mouseup",".textae-editor__span",q).on("mouseup",".textae-editor__type-label",s).on("mouseup",".textae-editor__entity-pane",u).on("mouseup",".textae-editor__entity",t),k.typeContainer=e.viewModel.typeContainer.entity,getSelectedIdEditable=d.selectionModel.entity.all,j=_.partial(c,getSelectedIdEditable,f.factory.entityChangeTypeCommand),i=null}}(),noEdit:function(){m(),k.typeContainer=null,j=null,i=null}}}(),n=function(){var a=function(){l.viewHandler.hideDialogs(),d.selectionModel.clear()},b={toTerm:function(){a(),m.noRelationEdit(),e.viewModel.viewMode.setTerm(),e.viewModel.viewMode.setEditable(!0),e.helper.redraw(),n=f.termCentric},toInstance:function(){a(),m.noRelationEdit(),e.viewModel.viewMode.setInstance(),e.viewModel.viewMode.setEditable(!0),e.helper.redraw(),n=f.instanceRelation},toRelation:function(){a(),m.relationEdit(),e.viewModel.viewMode.setRelation(),e.viewModel.viewMode.setEditable(!0),e.helper.redraw(),n=f.relationEdit},toViewTerm:function(){a(),m.noEdit(),e.viewModel.viewMode.setTerm(),e.viewModel.viewMode.setEditable(!1),e.helper.redraw(),n=f.viewTerm},toViewInstance:function(){a(),m.noEdit(),e.viewModel.viewMode.setInstance(),e.viewModel.viewMode.setEditable(!1),e.helper.redraw(),n=f.viewInstance}},c=function(){e.helper.redraw()},f={termCentric:_.extend({},b,{name:"Term Centric",toTerm:c}),instanceRelation:_.extend({},b,{name:"Instance / Relation",toInstance:c}),relationEdit:_.extend({},b,{name:"Relation Edit",toRelation:c}),viewTerm:_.extend({},b,{name:"View Only",toTerm:c,toInstance:b.toViewInstance,toRelation:c,toViewTerm:c}),viewInstance:_.extend({},b,{name:"View Only",toTerm:b.toViewTerm,toInstance:c,toRelation:c,toViewInstance:c})};return{init:function(){b.toTerm()}}}(),o=function(){$(window).trigger("resize")},p=function(a){return _.debounce(a,300)},q=function(a){return 16*a},r=p(_.compose(o,e.helper.changeLineHeight,q)),s=p(e.helper.changeTypeGap),t=function(a){n["to"+a]&&n["to"+a]()};return{init:function(){n.init()},showPallet:function(){var a=function(a){return function(){l.viewHandler.hidePallet(),a.call(this)}},b=function(b){var c=function(c){var d=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:c}).change(a(function(){return b.setDefaultType($(this).attr("label")),!1}));return c===b.getDefaultType()&&d.attr({title:"default type",checked:"checked"}),d},d=function(a){return a?$("<a>").attr({href:a,target:"_blank"}).append($("<span>").addClass("textae-editor__entity-pallet__link")):void 0},e=function(a){return a?$("<td>").append(a):$("<td>")},f=_.compose(e,c),g=function(a){return $("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",a).text(a)},h=_.compose(e,d,b.getUri);return b.getSortedNames().map(function(a){var c=f(a),d=g(a),e=h(a);return $("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":b.getColor(a)}).append([c,d,e])})},c=function(b){return $("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__entity-pallet__entity-type__label",a(b)).hide()},d=function(a){var b=$(".textae-editor__entity-pallet");return 0!==b.length?b.find("table").empty().end().css("width","auto"):($("body").append(a),a)},e=function(a){return a.find("table").append(b(k.typeContainer)).end()},f=function(a){return a.outerHeight()+"px"===a.css("max-height")?a.css("overflow-y","scroll"):a.css("overflow-y","")},g=_.compose(f,e,d,c);return function(a){k.typeContainer&&k.typeContainer.getSortedNames().length>0&&g(l.editHandler.setEntityType).css(a).show()}}(),hidePallet:function(){$(".textae-editor__entity-pallet").hide()},hideDialogs:function(){l.viewHandler.hidePallet(),a.tool.cancel()},redraw:function(){e.helper.redraw()},cancelSelect:function(){l.viewHandler.hideDialogs(),d.selectionModel.clear(),e.domUtil.manipulate.dismissBrowserSelection()},selectLeftSpan:function(){var a=d.selectionModel.span.single();if(a){var b=d.annotationData.span.get(a);d.selectionModel.clear(),b.left&&d.selectionModel.span.add(b.left.id)}},selectRightSpan:function(){var a=d.selectionModel.span.single();if(a){var b=d.annotationData.span.get(a);d.selectionModel.clear(),b.right&&d.selectionModel.span.add(b.right.id)}},showSettingDialog:function(){var b;return function(){var d=function(){return $("<div>").addClass("textae-editor__setting-dialog")},f=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Line Height').append($("<input>").attr({type:"number",step:1,min:3,max:10,value:e.helper.getLineHeight()}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){r($(this).val())})},g=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Instance/Relation View').append($("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view"))).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?n.toInstance():n.toTerm()})},h=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Type Gap').append($("<input>").attr({type:"number",step:1,min:0,max:5}).addClass("textae-editor__setting-dialog__type_gap"))).on("change",".textae-editor__setting-dialog__type_gap",function(){b=$(this).val(),s(b)})},i=function(b){return c.getDialog(a.editorId,"textae.dialog.setting","Chage Settings",b,!0)},j=function(a){return a.find(".textae-editor__setting-dialog__term-centric-view").prop({checked:e.viewModel.viewMode.isTerm()?null:"checked"}).end()},k=function(a){return a.find(".textae-editor__setting-dialog__type_gap").prop({value:b?b:e.viewModel.viewMode.isTerm()?0:1}).end()},l=function(a){return a.open()};_.compose(l,k,j,i,h,g,f,d)()}}(),toggleRelationEditMode:function(){e.viewModel.modeAccordingToButton["relation-edit-mode"].value()?n.toInstance():n.toRelation()},setViewMode:t,bindChangeViewMode:function(){var a=function(a){d.annotationData.relation.some()||d.annotationData.span.multiEntities().length>0?(t(a+"Instance"),e.helper.calculateLineHeight(36)):(t(a+"Term"),e.helper.calculateLineHeight(18))};return function(b){var c="edit"===b?"":"View";d.annotationData.bind("all.change",_.partial(a,c))}}()}}()}}();return{jsPlumbConnectionAdded:function(a,b){b.bindClickAction(j)},editorSelected:k,userEvent:l}},k=function(a,b){var d="",e=function(a){var b=function(){this.addClass("textae-editor_wait")},c=function(){this.removeClass("textae-editor_wait")};return{startWait:b.bind(a),endWait:c.bind(a)}}(a),f=function(a){return function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea}}(a),g=function(a){""!==a&&(f().html('(Target: <a href="'+a+'">'+a+"</a>)"),d=a)},h=function(a){e.startWait(),c.ajaxAccessor.getAsync(a,function(b){j.trigger("load",b),g(a)},function(){e.endWait()})},i=function(){var a=function(a){return a.openAndSetParam||(a.openAndSetParam=_.compose(a.open.bind(a),function(b){this.find('[type="text"].url').val(d).trigger("keyup"),a.params=b})),a},i=_.compose(a,c.getDialog),k=function(a){var c=function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);j.trigger("load",a)},b.readAsText(a.files[0])},d=function(a){return $('<input type="button" value="Open" disabled="disabled" />').addClass(a)},e=function(){return!l.params||window.confirm(b)},f=d("server"),g=d("local"),k=$("<div>").append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__load-dialog__file-name url" />'),f)).on("keyup",'[type="text"]',function(){this.value?f.removeAttr("disabled"):f.attr("disabled","disabled")}).on("click","input.server",function(){if(e()){var a=k.find(".textae-editor__load-dialog__file-name").val();h(a)}k.dialogClose()}).append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Local</label>'),$('<input class="textae-editor__load-dialog__file" type="file" />'),g)).on("change",'[type="file"]',function(){this.files.length>0?g.removeAttr("disabled"):g.attr("disabled","disabled")}).on("click","input.local",function(){e()&&c(k.find('[type="file"]')[0]),k.dialogClose()}),l=i(a,"textae.dialog.load","Load Annotations",k);return l},l=function(a){var b=function(){f().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),j.trigger("save"),e.endWait()},h=function(){f().html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),e.endWait()},l=function(a,d){e.startWait(),c.ajaxAccessor.post(a,{annotations:d},b,h,function(){e.endWait()})},m=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)},n=function(){var b=k(a).find("input[type='file']"),c=b.prop("files")[0];return c?c.name:"annotations.json"},o=$("<div>").append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__save-dialog__server-file-name url" />'),$('<input type="button" class="textae-editor__save-dialog__save-server-button" value="Save" />'))).on("click",".textae-editor__save-dialog__save-server-button",function(){var a=o.find(".textae-editor__save-dialog__server-file-name").val();l(a,p.params),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Local</label>'),$('<input type="text" class="textae-editor__save-dialog__local-file-name">'),$('<a class="download" href="#">Download</a>'))).on("click","a.download",function(){var a=m(p.params);$(this).attr("href",a).attr("download",o.find(".textae-editor__save-dialog__local-file-name").val()),j.trigger("save"),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label"></label>'),$('<a class="viewsource" href="#">Click to see the json source in a new window.</a>'))).on("click","a.viewsource",function(){var a=m(p.params);return window.open(a,"_blank"),j.trigger("save"),o.dialogClose(),!1}),p=i(a,"textae.dialog.save","Save Annotations",o);return p.on("dialogopen",function(){var a=n();p.find(".textae-editor__save-dialog__local-file-name").val(a)}),p};return{showLoad:function(a,b){k(a).openAndSetParam(b)},showSave:function(a,b){l(a).openAndSetParam(b)}}}(),j=c.extendBindable({getAnnotationFromServer:h,showAccess:_.partial(i.showLoad,a.editorId),showSave:_.partial(i.showSave,a.editorId)});return j},l=function(){var a=new d(this),b=new e(a),g=new f,l={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf("ANY")>=0?1:this.delimiterCharacters.indexOf(a)>=0}},m=new h(a,b,g,l),n=new i(this,a,b),o=new j(this,a,b,n,m,l),p=function(a){return{init:function(b){a.on("mousedown",function(a){return a.shiftKey?!1:void 0}).on("mousedown",".textae-editor__type",function(){return!1}).on("mousedown",".textae-editor__body__text-box__paragraph-margin",function(a){return"textae-editor__body__text-box__paragraph-margin"===a.target.className?!1:void 0}),a.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",o.editorSelected).on("mouseenter",".textae-editor__entity",function(){n.hoverRelation.on($(this).attr("title"))}).on("mouseleave",".textae-editor__entity",function(){n.hoverRelation.off($(this).attr("title"))}),a.on("textae.editor.jsPlumbConnection.add",o.jsPlumbConnectionAdded),g.bind("change",function(a){n.viewModel.buttonStateHelper.enabled("write",a.hasAnythingToSave),n.viewModel.buttonStateHelper.enabled("undo",a.hasAnythingToUndo),n.viewModel.buttonStateHelper.enabled("redo",a.hasAnythingToRedo),window.onbeforeunload=a.hasAnythingToSave?function(){return b}:null}),o.userEvent.viewHandler.init()}}}(this);return this.api=function(a){var d=function(a){var b=$.extend(c.getUrlParameters(location.search),{config:a.attr("config"),target:a.attr("target")});!b.mode&&a.attr("mode")&&(b.mode=a.attr("mode"));var d=a.text();return a.empty(),b.annotation={inlineAnnotation:d,url:b.target},b},e=function(a){b.annotationData.reset(a),g.reset()},f=function(a,b){var d=function(a){var b=function(a){n.viewModel.typeContainer.setDefinedEntityTypes(a["entity types"]),n.viewModel.typeContainer.setDefinedRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};if(l.set(),a.config){var d=c.ajaxAccessor.getSync(a.config);null!==d?(l.set(d),b(d)):alert("could not read the span configuration from the location you specified.")}},f=function(a){var c=a.annotation;c&&(c.inlineAnnotation?(e(JSON.parse(c.inlineAnnotation)),_.defer(o.userEvent.viewHandler.redraw)):c.url&&b.getAnnotationFromServer(c.url))};d(a),o.userEvent.viewHandler.bindChangeViewMode(a.mode),f(a)},h=function(b){var c=new k(a,b);return c.bind("save",g.saved),c.bind("load",e),c},i=function(a,b,c){a[b]&&a[b](c)},j=function(c){var d=function(){c.showAccess(g.hasAnythingToSave())},e=function(){c.showSave(b.annotationData.toJson())},f={A:d,C:o.userEvent.editHandler.copyEntities,D:o.userEvent.editHandler.removeSelectedElements,DEL:o.userEvent.editHandler.removeSelectedElements,E:o.userEvent.editHandler.createEntity,Q:o.userEvent.viewHandler.showPallet,R:o.userEvent.editHandler.replicate,S:e,V:o.userEvent.editHandler.pasteEntities,W:o.userEvent.editHandler.newLabel,X:m.redo,Y:m.redo,Z:m.undo,ESC:o.userEvent.viewHandler.cancelSelect,LEFT:o.userEvent.viewHandler.selectLeftSpan,RIGHT:o.userEvent.viewHandler.selectRightSpan},h={"textae.control.button.read.click":d,"textae.control.button.write.click":e,"textae.control.button.undo.click":m.undo,"textae.control.button.redo.click":m.redo,"textae.control.button.replicate.click":o.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":n.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":o.userEvent.viewHandler.toggleRelationEditMode,"textae.control.button.entity.click":o.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":o.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":o.userEvent.viewHandler.showPallet,"textae.control.button.negation.click":o.userEvent.editHandler.negation,"textae.control.button.speculation.click":o.userEvent.editHandler.speculation,"textae.control.button.delete.click":o.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":o.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":o.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":o.userEvent.viewHandler.showSettingDialog};a.api={handleKeyInput:_.partial(i,f),handleButtonClick:_.partial(i,h),redraw:o.userEvent.viewHandler.redraw}},q=function(a){var b="There is a change that has not been saved. If you procceed now, you will lose it.",c=d(a);n.init(),p.init(b);var e=h(b);f(c,e),j(e)};return{start:q}}(this),this},m=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{negation:"Negataion",speculation:"Speculation"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=this.trigger.bind(this,"textae.control.button.click",e.eventName);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b,c){var d=f[b].instance;c?a.push(d):a.unpush(d)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateButtonPushState=e,this},n=function(){{var a=function(){var a=c.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),b=c.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")}});return{control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:a,about:b,hideAll:_.compose(a.hide,b.hide)}}}(),b=function(){var a={},b=function(b){a={top:b.clientY,left:b.clientX}},c=_.debounce(b,30);return $("html").on("mousemove",c),function(){return a}}(),d={handleKeyInput:function(c){"H"===c?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(c,b()),"ESC"===c&&a.infoModals.hideAll())},handleButtonClick:function(c){switch(c){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(c,b())}},handleEditor:{select:function(b){a.editors.select(b)},"public":{cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b,c){a.control&&b===a.editors.selected&&a.control.updateAllButtonEnableState(c)},push:function(b,c){a.control&&a.control.updateButtonPushState(b,c)}}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},c=function(a){return a.keyCode},e=_.compose(d.handleKeyInput,b,c),f=e;$(document).on("keyup",function(a){f(a)}),$("body").on("dialogopen",".ui-dialog",function(){f=function(){}}).on("dialogclose",".ui-dialog",function(){f=e})},c=function(){$(window).on("resize",_.debounce(function(){a.editors.forEach(function(a){_.defer(a.api.redraw)})},20))};$(_.compose(c,b))}()}return{setControl:function(b){b.on("textae.control.button.click",function(){d.handleButtonClick.apply(null,_.rest(arguments))}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:$.extend({selectMe:_.partial(d.handleEditor.select,b)},d.handleEditor.public)})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return n.pushEditor(a),l.apply(a),a.api.start(a),a}),n.selectFirstEditor();else if(this.hasClass("textae-control")){var a=m.apply(this);return n.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);