/*! textae 0.0.1 17-12-2013 */
!function(a){var b={ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||$.ajax({type:"post",url:b,contentType:"application/json",data:{annotations:c}}).done(d).fail(e).always(f)}}}(),getUrlParameters:function(a){var b=a?(""+a).slice(1).split("&"):[],c="",d="",e=!1;return b.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).forEach(function(a){switch(a.key){case"target":c=a.val;break;case"config":d=a.val;break;case"debug":e=!0}}),{target:c,config:d,debug:e}},makeInformationDialog:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-dialog").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-dialog").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-dialog",function(){$(this).hide()})}),c}()},c=function(){var a,c,d=function(a){var b=function(){a.css("cursor","wait")},c=function(){a.css("cursor","auto")};return{startWait:b,endWait:c}}(this),e=function(){var a=function(){$body=$("body");var a=$body.find("#textae.dialog.load");if(0===a.length){a=$('<div id="textae.dialog.load" title="Load document with annotation.">').append('<div>Sever :<input type="text" style="width:345px"/><input type="button" value="OK" /></div>').append('<div>Local :<input type="file"　/></div>');var b=function(){var b=new FileReader;b.onload=function(){var b=JSON.parse(this.result);s.loadAnnotation(b),a.dialog("close")},b.readAsText(this.files[0])};$body.append(a),a.hide(),a.find("input[type='file']").on("change",b),a.find("input[type='button']").on("click",function(){var b=a.find("input[type='text']").val();s.getAnnotationFromServer(b),a.dialog("close")})}return a};return{showAccess:function(b){var c=a();c.find("input[type='text']").val(b),c.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:{Cancel:function(){$(this).dialog("close")}}})},showSave:function(b,c){var d=function(){$body=$("body");var a=$body.find("#textae.dialog.save");return 0===a.length&&(a=$('<div id="textae.dialog.save" title="Save document with annotation.">').append('<div>Sever :<input type="text" style="width:345px"/><input type="button" value="OK" /></div>').append('<div>Local :<span class="span_link_place"><a target="_blank"/></span></div>'),$body.append(a),a.hide(),a.on("click","a",function(){s.saveAnnotation(),a.dialog("close")}).on("click","input[type='button']",function(){var b=a.find("input[type='text']").val();s.saveAnnotationToServer(b),a.dialog("close")})),a},e=function(b,c){{var d=a().find("input[type='file']"),e=d.prop("files")[0],f=e?e.name:"annotations.json",g=new Blob([b],{type:"application/json"});c.find("a").text(f).attr("href",URL.createObjectURL(g)).attr("download",f)}},f=d();e(c,f),f.find("input[type='text']").val(b),f.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:{Cancel:function(){$(this).dialog("close")}}})}}}(),f=function(a){return{isReplicateAuto:!1,buttonState:function(){var b={},c=function(a,c){c?delete b[a]:b[a]=!0},d=function(){c("entity",r.span.getNumberOfSelected()>0)},e=function(){c("paste",g.length>0&&r.span.getNumberOfSelected()>0)},f=function(){c("replicate",1==r.span.getNumberOfSelected())},h=function(){c("pallet",r.entity.getNumberOfSelected()>0)},i=function(){c("newLabel",r.entity.getNumberOfSelected()>0)},j=function(){c("delete",r.hasSelecteds())},k=function(){c("copy",r.entity.hasSelecteds())},l=function(){j(),k()};return{pushed:function(b,c){a.tool.pushReplicateAuto(c)},renderEnable:function(){a.tool.changeButtonState(b)},enabled:function(a,b){c(a,b),this.renderEnable()},updateBySpan:function(){l(),d(),e(),f(),this.renderEnable()},updateByEntity:function(){l(),h(),i(),this.renderEnable()},updateAll:function(){l(),d(),e(),f(),h(),i(),this.renderEnable()}}}(),toggleReplicateAuto:function(){f.isReplicateAuto=!f.isReplicateAuto,f.buttonState.pushed("replicate-auto",f.isReplicateAuto)}}}(this),g=[],h={connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},i={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf(a)>=0}},j=function(){return{sourceDoc:"",relationTypes:{},relationTypeDefault:"",annotationData:function(){var a,b=null,c=function(){var a=j.annotationData.getAllSpan().sort(function(a,b){return a.begin-b.begin||b.end-a.end}),c=[];a.forEach(function(a,b,d){$.extend(a,{children:[],left:0!==b?d[b-1]:null,right:b!==d.length-1?d[b+1]:null});var e=d[b-1],f=c[c.length-1];a.isChildOf(e)?(e.children.push(a),a.parent=e):e&&a.isChildOf(e.parent)?(e.parent.children.push(a),a.parent=e.parent):a.isChildOf(f)?(f.children.push(a),a.parent=f):c.push(a)}),c.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},b=a.map(function(a){return a.id}),j.annotationData.spanTree=c},d=function(){var a=Object.keys(j.annotationData.entities).filter(function(a){return"E"===a[0]}).map(function(a){return a.slice(1)});return a.sort(function(a,b){return b-a}),parseInt(a[0])||0},e=function(b){var c={types:{},isChildOf:function(a){return a&&a.begin<=b.begin&&b.end<=a.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+j.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=j.annotationData.spanTree.indexOf(this),0===a||j.annotationData.spanTree[a-1].paragraph!==this.paragraph?null:j.annotationData.spanTree[a-1])},getTypes:function(){return $.map(this.types,function(b,c){return{id:c,name:b,entities:a[c]}})}},d=function(a){var b=j.annotationData.paragraphsArray.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return b.length>0?b[0]:null},e=o.makeSpanId(b.begin,b.end);j.annotationData.spans[e]||(j.annotationData.spans[e]=$.extend({id:e,paragraph:d(b)},b,c))};return{spans:null,entities:null,relations:null,reset:function(){j.annotationData.spans={},j.annotationData.entities={},j.annotationData.relations={}},addSpan:function(a){e(a),c()},removeSpan:function(a){delete j.annotationData.spans[a],c()},getSpan:function(a){return j.annotationData.spans[a]},getRangeOfSpan:function(a,c){var d=b.indexOf(a),e=b.indexOf(c);if(d>e){var f=d;d=e,e=f}return b.slice(d,e+1)},getAllSpan:function(){return $.map(j.annotationData.spans,function(a){return a})},addEntity:function(b){var c=function(b){var c=function(b,c){a[b]?a[b].push(c):a[b]=[c]},d=o.makeTypeId(b.span,b.type);j.annotationData.spans[b.span].types[d]=b.type,c(d,b.id)};j.annotationData.entities[b.id]=b,c(b)},removeEnitity:function(b){var c=function(b,c,d){"use strict";var e=o.makeTypeId(b,c),f=a[e];f.splice(f.indexOf(d),1),0===a[e].length&&(delete a[e],delete j.annotationData.spans[b].types[e])},d=j.annotationData.entities[b];return c(d.span,d.type,b),delete j.annotationData.entities[b],d},parseParagraphs:function(a){var b=[],c=0;a.split("\n").forEach(function(a,d){b.push({id:o.makeParagraphId(d),begin:c,end:c+a.length}),c+=a.length+1}),j.annotationData.paragraphsArray=b},parseDenotations:function(b){b&&(a={},b.forEach(function(a){e(a.span),j.annotationData.addEntity({id:a.id,span:o.makeSpanId(a.span.begin,a.span.end),type:a.obj})}),c())},parseRelations:function(a){a&&a.forEach(function(a){j.annotationData.relations[a.id]=a})},getRelationIds:function(){return Object.keys(j.annotationData.relations)},getNewEntityId:function(){return"E"+(d()+1)},toJason:function(){var a=[];for(var b in j.annotationData.entities){var c={begin:j.annotationData.spans[j.annotationData.entities[b].span].begin,end:j.annotationData.spans[j.annotationData.entities[b].span].end};a.push({id:b,span:c,obj:j.annotationData.entities[b].type})}return JSON.stringify({text:j.sourceDoc,denotations:a})}}}(),entityTypes:function(){var a={},b="",c=function(){return this.color?this.color:"#77DDDD"};return{setDefaultType:function(a){b=a},getDefaultType:function(){return b||j.entityTypes.getSortedNames()[0]},getType:function(b){return a[b]=a[b]||{getColor:c},a[b]},set:function(d){a={},b="",void 0!==d&&d.forEach(function(d){d.getColor=c,a[d.name]=d,d["default"]===!0&&(b=d.name)})},incrementNumberOfTypes:function(a){var b=j.entityTypes.getType(a);b.count=(b.count||0)+1},getSortedNames:function(){var b=Object.keys(a);return b.sort(function(b,c){return a[c].count-a[b].count}),b}}}(),connectorTypes:{},getSpanReplications:function(a){for(var b=function(a,b,c){var d=a.charAt(b-1),e=a.charAt(c);return i.isDelimiter(d)&&i.isDelimiter(e)?!1:!0},c=function(a,c){for(var d=j.sourceDoc.substring(a,c),e=c-a,f=[],g=0;;){var h=j.sourceDoc.indexOf(d,g);if(-1==h)break;if(!b(j.sourceDoc,h,h+e)){var i={};i.begin=h,i.end=h+e;var k=!1;for(var l in j.annotationData.spans)if(j.annotationData.spans[l].begin==i.begin&&j.annotationData.spans[l].end==i.end&&j.annotationData.spans[l].category==i.category){k=!0;break}k||a==h||f.push(i)}g=h+1}return f},d=a.begin,e=a.end,f=c(d,e),g=[],h=0;h<f.length;h++){cspan=f[h];var k=!1;for(var l in j.annotationData.spans)if(cspan.begin>j.annotationData.spans[l].begin&&cspan.begin<j.annotationData.spans[l].end&&cspan.end>j.annotationData.spans[l].end||cspan.begin<j.annotationData.spans[l].begin&&cspan.end>j.annotationData.spans[l].begin&&cspan.end<j.annotationData.spans[l].end){k=!0;break}k||g.push(cspan)}}}}(this),k="",l={BLOCK_THRESHOLD:100,TYPE_MARGIN_TOP:18,TYPE_MARGIN_BOTTOM:2,PALLET_HEIGHT_MAX:100},m=function(){var a=function(a){if(j.entityTypes.set(a["entity types"]),j.relationTypes={},j.relationTypeDefault=null,void 0!==a["relation types"]){var b=a["relation types"];for(var c in b)j.relationTypes[b[c].name]=b[c],b[c]["default"]===!0&&(j.relationTypeDefault=b[c].name);j.relationTypeDefault||(j.relationTypeDefault=b[0].name)}j.connectorTypes={},void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')},c=function(){n.history.init(n.historyChanged),f.buttonState.updateAll()};p.init(),q.init(),c(),i.set();var d={debug:this.attr("debug"),config:this.attr("config"),target:this.attr("annotations")};if(d.config&&""!==d.config){var e=b.ajaxAccessor.getSync(d.config);null!==e?(i.set(e),a(e)):alert("could not read the span configuration from the location you specified.")}d.target&&""!==d.target&&s.getAnnotationFromServer(d.target)}.bind(this),n={history:function(){var a,b=-1,c=-1,d=[],e=function(){a&&a()};return{init:function(f){b=-1,c=-1,d=[],void 0!==f&&(a=f.bind(this)),e()},push:function(a){d.push(a),c++,e()},next:function(){return c++,e(),d[c]},prev:function(){var a=d[c];return c--,e(),a},saved:function(){b=c,e()},hasAnythingToUndo:function(){return c>-1},hasAnythingToRedo:function(){return c<d.length-1},hasAnythingToSave:function(){return c!=b}}}(),historyChanged:function(){var a=function(){return"There is a change that has not been saved. If you leave now, you will lose it."};f.buttonState.enabled("write",this.hasAnythingToSave()),f.buttonState.enabled("undo",this.hasAnythingToUndo()),f.buttonState.enabled("redo",this.hasAnythingToRedo()),this.hasAnythingToSave()?$(window).off("beforeunload",a).on("beforeunload",a):$(window).off("beforeunload",a)},execute:function(b,d){if(b&&b.length>0){switch(b=n.util.uniq(b),d){case"undo":case"redo":r.unselect(),p.relations.clearRelationSelection()}var e;for(var g in b){var h=b[g];switch(h.action){case"new_span":try{j.annotationData.addSpan({begin:h.begin,end:h.end}),p.renderSpan(h.id),r.span.select(h.id)}catch(i){throw j.annotationData.removeSpan(h.id),i}break;case"remove_span":var k=j.annotationData.getSpan(h.id);h.begin=k.begin,h.end=k.end,j.annotationData.removeSpan(h.id),p.destroySpan(h.id),p.renderGrid(h.id);break;case"new_denotation":var l={id:h.id||j.annotationData.getNewEntityId(),span:h.span,type:h.type};j.annotationData.addEntity(l),p.renderGrid(l.span),p.renderEntity(l),r.entity.select(h.id);break;case"remove_denotation":var m=j.annotationData.removeEnitity(h.id);p.renderEntity(m),p.renderGrid(m.span);break;case"change_entity_type":j.annotationData.entities[h.id].type=h.new_type,p.renderEntity(j.annotationData.entities[h.id]);break;case"new_relation":j.annotationData.relations[h.id]={id:h.id,subj:h.subj,obj:h.obj,pred:h.pred},c[h.subj]?c[h.subj].indexOf(h.id)<0&&c[h.subj].push(h.id):c[h.subj]=[h.id],c[h.obj]?c[h.obj].indexOf(h.id)<0&&c[h.obj].push(h.id):c[h.obj]=[h.id],a[h.id]=p.relations.renderRelation(h.id),p.relations.selectRelation(h.id);break;case"remove_relation":delete j.annotationData.relations[h.id],e=c[h.subj],e.splice(e.indexOf(h.id),1),0===e.length&&delete c[h.subj],e=c[h.obj],e.splice(e.indexOf(h.id),1),0===e.length&&delete c[h.obj],p.relations.destroyRelation(h.id);break;case"change_relation_pred":j.annotationData.relations[h.id].pred=h.new_pred,a[h.id].setPaintStyle(j.connectorTypes[h.new_pred+"_selected"].paintStyle),a[h.id].setHoverPaintStyle(j.connectorTypes[h.new_pred+"_selected"].hoverPaintStyle),a[h.id].setLabel("["+h.id+"] "+h.new_pred),p.relations.selectRelation(h.id)}}switch(t.redraw(),d){case"undo":case"redo":break;default:n.history.push(b),f.buttonState.updateAll()}}},create:{replicateSpanCommands:function(a){for(var b=j.getSpanReplications(a),c=[],d=0;d<b.length;d++){var e=b[d],f=o.makeSpanId(e.begin,e.end);c.push({action:"new_span",id:f,begin:e.begin,end:e.end})}return c},removeSpanCommand:function(a){return{action:"remove_span",id:a}},removeEntityCommand:function(a){return{action:"remove_denotation",id:a}},removeRelationCommand:function(a){return{action:"remove_relation",id:a,subj:j.annotationData.relations[a].subj,obj:j.annotationData.relations[a].obj,pred:j.annotationData.relations[a].pred}}},util:{uniq:function(a){var b,c={},d=[];a.forEach(function(a){c[a.id]=a});for(b in c)d.push(c[b]);return d}}},o=function(a){return{makeParagraphId:function(b){return a.editorId+"__P"+b},makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},makeTypeId:function(a,b){return a+"-"+b},makeEntityDomId:function(b){return a.editorId+"__E"+b}}}(this),p=function(b){var c=function(a){return j.relationTypes&&j.relationTypes[a]&&j.relationTypes[a].color?j.relationTypes[a].color:"#555555"},d=function(a,b){var c=a.slice(1),d=c.substr(0,2),e=c.substr(2,2),f=c.substr(4,2);return d=parseInt(d,16),e=parseInt(e,16),f=parseInt(f,16),"rgba("+d+", "+e+", "+f+", "+b+")"};return{init:function(){var a=function(a,c){var d=b.find("."+c);return 0===d.length&&(d=$("<div>").addClass(c),a.append(d)),d},c=function(){p.jsPlumb=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]}),p.jsPlumb.setRenderMode(p.jsPlumb.SVG),p.jsPlumb.Defaults.Container=b.getAnnotationArea()};b.body=a(b,"textae-editor__body"),$.extend(b,{getSourceDocArea:function(){return a(b.body,"textae-editor__body__text-box")},getAnnotationArea:function(){return a(b.body,"textae-editor__body__annotation_box")}}),c()},renderAnnotation:function(){var a=function(){var a=b.getSourceDocArea();a.html(j.sourceDoc);var c=a.get(0).getClientRects(),d=c[1].top-c[0].bottom;b.find(".textae-editor__body").css("paddingTop",d/2),a.empty()},e=function(){return j.sourceDoc.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph">'+a+"</p>"}).join("\n")},f=function(){var a={};return b.getSourceDocArea().find("p").each(function(b,c){var d=$(c),e=$.extend(j.annotationData.paragraphsArray[b],{element:d});d.attr("id",e.id),a[e.id]=e}),a},g=function(){j.annotationData.spanTree.forEach(function(a){p.renderSpan(a.id)})},i=function(){for(var a in j.relationTypes){var b=c(a),e=d(b,h.connOpacity),f=d(b,1);j.connectorTypes[a]={paintStyle:{strokeStyle:e,lineWidth:1},hoverPaintStyle:{strokeStyle:f,lineWidth:3}},j.connectorTypes[a+"_selected"]={paintStyle:{strokeStyle:f,lineWidth:3},hoverPaintStyle:{strokeStyle:f,lineWidth:3}}}};a(),b.getSourceDocArea().html(e()),p.paragraphs=f(),b.getAnnotationArea().empty(),p.renderSize.mesure(),p.positions.reset(),g(),i(),p.relations.renderRelations()},renderSize:{gridWidthGap:0,typeHeight:0,entityWidth:0,mesure:function(){var a='<div id="temp_grid" class="textae-editor__grid" style="width:10px; height:auto"></div>';b.getAnnotationArea().append(a),a='<div id="temp_type" class="textae-editor__type" title="[Temp] Temp" >T0</div>',$("#temp_grid").append(a),a='<div id="temp_entity_pane" class="textae-editor__entity_pane"><div id="temp_entity" class="textae-editor__entity"></div></div>',$("#temp_type").append(a),p.renderSize.gridWidthGap=$("#temp_grid").outerWidth()-10,p.renderSize.typeHeight=$("#temp_type").outerHeight(),p.renderSize.entityWidth=$("#temp_entity").outerWidth(),$("#temp_grid").remove()}},renderSpan:function(a){var b=function(a){var b=function(b,c){var d=a.begin-c,e=a.end-c;if(0>d||b.length<e)throw new Error("oh my god! I cannot render this span. "+a.toStringOnlyThis()+", textNode "+b.textContent);var f=document.createRange();return f.setStart(b,d),f.setEnd(b,e),f},c=function(){var c=function(a){var c=p.paragraphs[a.paragraph.id];return textNodeInParagraph=c.element.contents().filter(function(){return 3===this.nodeType}).get(0),b(textNodeInParagraph,c.begin)},d=a.getBigBrother();if(d)return b(document.getElementById(d.id).nextSibling,d.end);if(a.parent){var e=$("#"+a.parent.id).contents().filter(function(){return 3===this.nodeType}).get(0);return b(e,a.parent.begin)}return c(a)},d=document.createElement("span");d.setAttribute("id",a.id),d.setAttribute("title",a.id),d.setAttribute("class","textae-editor__span"),c(a.id).surroundContents(d)},c=function(a){a.children.forEach(function(a){c(a)}),p.destroySpan(a.id)},d=function(a){var b=a.getTypes();b&&(p.renderGrid(a.id),b.forEach(function(a){a.entities.forEach(function(a){p.renderEntity(j.annotationData.entities[a])})}))},e=j.annotationData.spans[a];e.children.filter(function(a){return null!==document.getElementById(a.id)}).forEach(function(a){c(a)}),b(e),p.positions.indexPositionSpan(e.id),d(e),e.children.filter(function(a){return null===document.getElementById(a.id)}).forEach(function(a){p.renderSpan(a.id)})},destroySpan:function(a){for(var b=document.getElementById(a),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);c.removeChild(b),c.normalize()},renderEntity:function(a){var b=function(a){return j.annotationData.entities[a.id]},c={show:function(a){var b=function(a){return j.entityTypes.getType(a).getColor()},c=function(a){var c=b(a.type);return $("<div>").attr("id",o.makeEntityDomId(a.id)).attr("title",a.id).addClass("textae-editor__entity").css({display:"inline-block","border-color":c})},d=function(a,c){var d=function(a,c){var d=$("<div>").attr("id","P-"+c).addClass("textae-editor__entity_pane"),e=$("<div>").addClass("textae-editor__type_label").text(a);return $("<div>").attr("id",c).addClass("textae-editor__type").css({"background-color":b(a),"margin-top":l.TYPE_MARGIN_TOP,"margin-bottom":l.TYPE_MARGIN_BOTTOM,title:a}).append(d).append(e)},e=o.makeTypeId(a,c),f=$("#"+e);return 0===f.length&&(f=d(c,e),$("#G"+a).append(f)),f};if(0===r.entity.get(a.id).length){var e=c(a);d(a.span,a.type).find(".textae-editor__entity_pane").append(e),p.positions.indexPositionEntity(a.id)}},hide:function(a){var b=function(b){return 0===j.annotationData.spans[a.span].getTypes().filter(function(a){return a.name==b}).length};r.entity.get(a.id).remove(),b(a.type)&&$("#"+o.makeTypeId(a.span,a.type)).remove()}};b(a)?c.show(a):c.hide(a)},renderGrid:function(a){var c=function(a){return j.annotationData.spans[a]&&j.annotationData.spans[a].getTypes().length>0},d={show:function(c){var d=function(a){return $("<div>").attr("id",a).addClass("textae-editor__grid")},e=function(a){return g=$("#"+a),0===g.length&&(g=d(a),b.getAnnotationArea().append(g)),g},f=function(a,b){a.css({position:"absolute",top:b.top,left:b.left,width:b.width,height:b.height})},g=e(c),h=p.positions.getGridPosition(a);f(g,h),p.positions.grid[c]=h},hide:function(a){$grid=$("#"+a),$grid.remove(),delete p.positions.grid[a]}},e="G"+a;c(a)?d.show(e):d.hide(e)},positions:{reset:function(){this.span={},this.grid={},this.entity={}},indexPositionSpan:function(a){var b=$("#"+a);if(0===b.length)throw new Error("span is not renderd : "+a);p.positions.span[a]={top:b.get(0).offsetTop,left:b.get(0).offsetLeft,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}},indexPositionEntity:function(a){var b=j.annotationData.entities[a].span,c=r.entity.get(a);if(0===c.length)throw new Error("entity is not rendered : "+a);var d=p.positions.getGridPosition(b);p.positions.entity[a]={top:d.top+c.get(0).offsetTop,left:d.left+c.get(0).offsetLeft,width:c.outerWidth(),height:c.outerHeight(),center:d.left+c.get(0).offsetLeft+c.outerWidth()/2}},getGridPosition:function(a){var b=j.annotationData.spans[a].getTypes().length*(p.renderSize.typeHeight+l.TYPE_MARGIN_BOTTOM+l.TYPE_MARGIN_TOP);return{offset:l.TYPE_MARGIN_BOTTOM,top:p.positions.span[a].top-l.TYPE_MARGIN_BOTTOM-b,left:p.positions.span[a].left,width:p.positions.span[a].width-p.renderSize.gridWidthGap,height:b}}},relations:function(){var b=function(a,b){var c=p.positions.entity[a].center,d=p.positions.entity[b].center,e=p.positions.entity[a].top,f=p.positions.entity[b].top,g=Math.abs(c-d),i=Math.abs(e-f),j=g*h.xrate+i*h.yrate+h.c_offset;return j/=2.4};return{renderRelations:function(){var b=j.annotationData.getRelationIds();p.jsPlumb.reset(),b.forEach(function(b){a[b]=p.relations.renderRelation(b)}),p.relations.relationIdsSelected=[]},renewConnections:function(){var c=j.annotationData.getRelationIds();c.forEach(function(c){var d=j.annotationData.relations[c].subj,e=j.annotationData.relations[c].obj,f=b(d,e);d==e&&(f=30);{var g=a[c];g.getLabel()}g.endpoints[0].repaint(),g.endpoints[1].repaint(),g.setConnector(["Bezier",{curviness:f}])})},renderRelation:function(a){var e=j.annotationData.relations[a].subj,f=j.annotationData.relations[a].obj,g=b(e,f),i="TopCenter",k="TopCenter";e==f&&(i=[.5,0,-1,-1],k=[.5,0,1,-1],g=30);var l=j.annotationData.relations[a].pred,m=(d(c(l),h.connOpacity),r.entity.get(e)),n=r.entity.get(f),o="["+a+"] "+l,s=p.jsPlumb.connect({source:m,target:n,anchors:[i,k],connector:["Bezier",{curviness:g}],paintStyle:j.connectorTypes[l].paintStyle,hoverPaintStyle:j.connectorTypes[l].hoverPaintStyle,tooltip:"["+a+"] "+l,parameters:{id:a,label:o}});return s.addOverlay(["Arrow",{width:10,length:12,location:1}]),s.setLabel({label:o,cssClass:"label"}),s.bind("click",q.connectorClicked),s},isRelationSelected:function(a){return p.relations.relationIdsSelected.indexOf(a)>-1},selectRelation:function(b){p.relations.isRelationSelected(b)||(a[b].setPaintStyle(j.connectorTypes[j.annotationData.relations[b].pred+"_selected"].paintStyle),p.relations.relationIdsSelected.push(b))},deselectRelation:function(b){var c=p.relations.relationIdsSelected.indexOf(b);c>-1&&(a[b].setPaintStyle(j.connectorTypes[j.annotationData.relations[b].pred].paintStyle),p.relations.relationIdsSelected.splice(c,1))},clearRelationSelection:function(){for(;p.relations.relationIdsSelected.length>0;){var b=p.relations.relationIdsSelected.pop();a[b].setPaintStyle(j.connectorTypes[j.annotationData.relations[b].pred].paintStyle)}},destroyRelation:function(b){var c=a[b];p.jsPlumb.detach(c)}}}()}}(this),q=function(a){var b=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},c=function(c){var d=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=p.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return console.log(d),void 0;b=j.annotationData.spans[d].begin}for(var e=a.parentElement.childNodes,f=0;e[f]!=a;f++)b+="#text"==e[f].nodeName?e[f].nodeValue.length:$("#"+e[f].id).text().length;return b},e=function(a){var b=d(a.focusNode);return b+=a.focusOffset},g=function(a){var b=d(a.anchorNode);return b+a.anchorOffset},h=function(a){for(var b=a;i.isNonEdgeCharacter(j.sourceDoc.charAt(b));)b++;for(;!i.isDelimiter(j.sourceDoc.charAt(b))&&b>0&&!i.isDelimiter(j.sourceDoc.charAt(b-1));)b--;return b},k=function(a){for(var b=a;i.isNonEdgeCharacter(j.sourceDoc.charAt(b-1));)b--;for(;!i.isDelimiter(j.sourceDoc.charAt(b))&&b<j.sourceDoc.length;)b++;return b},m=function(a){for(var b=a;b<j.sourceDoc.length&&(i.isNonEdgeCharacter(j.sourceDoc.charAt(b))||!i.isDelimiter(j.sourceDoc.charAt(b-1)));)b++;return b},q=function(a){for(var b=a;b>0&&(i.isNonEdgeCharacter(j.sourceDoc.charAt(b-1))||!i.isDelimiter(j.sourceDoc.charAt(b)));)b--;return b},u=function(a,b,c){var d=[],e=o.makeSpanId(b,c);return j.annotationData.spans[e]||(d.push({action:"remove_span",id:a}),d.push({action:"new_span",id:e,begin:b,end:c}),j.annotationData.spans[a].getTypes().forEach(function(a){a.entities.forEach(function(b){d.push({action:"new_denotation",id:b,span:e,type:a.name})})})),d},v=function(a,b){var c=[],d=e(b),f=b.getRangeAt(0),g=document.createRange();if(g.selectNode(b.anchorNode),f.compareBoundaryPoints(Range.START_TO_START,g)<0){var i=h(d);c=u(a,i,j.annotationData.spans[a].end)}else{var l=k(d);c=u(a,j.annotationData.spans[a].begin,l)}n.execute(c)},w=function(a,b){var c=[],d=e(b),f=b.getRangeAt(0),g=document.createRange();g.selectNode(b.focusNode);var h,i=function(a){var b=[];return b.push({action:"remove_span",id:a}),b};if(f.compareBoundaryPoints(Range.START_TO_START,g)>0){var k=q(d);k>j.annotationData.spans[a].begin?(h=o.makeSpanId(j.annotationData.spans[a].begin,k),c=j.annotationData.spans[h]?i(a):u(a,j.annotationData.spans[a].begin,k)):(r.span.select(a),s.removeSelectedElements())}else{var l=m(d);l<j.annotationData.spans[a].end?(h=o.makeSpanId(l,j.annotationData.spans[a].end),c=j.annotationData.spans[h]?i(a):u(a,l,j.annotationData.spans[a].end)):(r.span.select(a),s.removeSelectedElements())}n.execute(c)},x=window.getSelection();if(x){var y=x.getRangeAt(0);if(y.startContainer==a.getSourceDocArea().get(0)||c.shiftKey||x.isCollapsed)return t.cancelSelect(),r.dismissBrowserSelection(),!0;var z,A=g(x),B=e(x);if(x.anchorNode.parentElement.id===x.focusNode.parentElement.id){if(r.unselect(),A>B){var C=A;A=B,B=C}if(0===A&&B==j.sourceDoc.length)return!0;var D=h(A),E=k(B);if(z=o.makeSpanId(D,E),!j.annotationData.spans[z])if(E-D>l.BLOCK_THRESHOLD)n.execute([{action:"new_span",id:z,begin:D,end:E}]);else{var F=[{action:"new_span",id:z,begin:D,end:E}];if(f.isReplicateAuto){var G=n.create.replicateSpanCommands({begin:D,end:E});F=F.concat(G)}n.execute(F)}}else x.anchorNode.parentNode.parentNode==x.focusNode.parentNode?(r.unselect(),v(x.anchorNode.parentNode.id,x)):x.anchorNode.parentNode==x.focusNode.parentNode.parentNode?(r.unselect(),w(x.focusNode.parentNode.id,x)):1==r.span.getNumberOfSelected()?(z=r.span.popSelectedId(),A>j.annotationData.spans[z].begin&&A<j.annotationData.spans[z].end?$("#"+z).get(0).parentNode.id==x.focusNode.parentNode.id?v(z,x):(r.span.select(z),alert("A span cannot be expanded to make a boundary crossing.")):B>j.annotationData.spans[z].begin&&B<j.annotationData.spans[z].end?$("#"+z).get(0).id==x.focusNode.parentNode.id?w(z,x):(r.span.select(z),alert("A span cannot be shrinked to make a boundary crossing.")):alert("It is ambiguous for which span you want to adjust the boundary. Reselect the span, and try again.")):alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again.")}r.dismissBrowserSelection(),b(c)},d=function(a){t.hidePallet();{var b=window.getSelection();b.getRangeAt(0)}if(b.isCollapsed)a.ctrlKey?(r.domElement.toggle(a.target),f.buttonState.updateBySpan()):(r.domElement.selectOnly(a.target),f.buttonState.updateAll());else{if(!a.shiftKey||1!=r.span.getNumberOfSelected())return!0;var c=r.span.popSelectedId(),d=$(this).attr("id");r.dismissBrowserSelection(),r.unselect(),j.annotationData.getRangeOfSpan(c,d).forEach(function(a){r.span.select(a)}),f.buttonState.updateBySpan()}return!1},e=function(a){return a.ctrlKey?(r.domElement.toggle(a.target),f.buttonState.updateByEntity()):(r.domElement.selectOnly(a.target),f.buttonState.updateAll()),b(a),!1},g=function(a){var b=$(this),c=b.attr("id");"mouseover"==a.type?(b.css("height","auto"),b.outerWidth()<p.positions.grid[c].width&&b.css("width",p.positions.grid[c].width)):b.css("height",p.positions.grid[c].height)},h=function(){a.tool.selectMe(),f.buttonState.renderEnable()};return{init:function(){a.on("mouseup",".textae-editor__body",c).on("mouseup",".textae-editor__span",d).on("mouseup",".textae-editor__entity",e).on("mouseover mouseout",".textae-editor__grid",g).on("mouseup",".textae-editor__body,.span,.entity,.grid",h)},connectorClicked:function(a,c){var d=a.getParameter("id");return r.unselect(),p.relations.isRelationSelected(d)?p.relations.deselectRelation(d):(c.ctrlKey||p.relations.clearRelationSelection(),p.relations.selectRelation(d)),b(c),!1}}}(this),r={dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)},getSelecteds:function(){return $(".ui-selected")},hasSelecteds:function(){return r.getSelecteds().length>0},unselect:function(){r.getSelecteds().removeClass("ui-selected"),p.relations.clearRelationSelection(),f.buttonState.updateAll()},domElement:function(){var a=function(a){return $(a).hasClass("ui-selected")},b=function(a){$(a).addClass("ui-selected")},c=function(a){$(a).removeClass("ui-selected")};return{toggle:function(d){a(d)?c(d):b(d)},selectOnly:function(a){r.getSelecteds().removeClass("ui-selected"),p.relations.clearRelationSelection(),b(a)}}}(),span:{getSelecteds:function(){return $(".textae-editor__span.ui-selected")},getNumberOfSelected:function(){return r.span.getSelecteds().length},getSelectedId:function(){return r.span.getSelecteds().attr("id")},popSelectedId:function(){var a=r.span.getSelecteds();return 1===a.length?(a.removeClass("ui-selected"),a.attr("id")):null},select:function(a){$("#"+a).addClass("ui-selected"),f.buttonState.updateBySpan()}},entity:{get:function(a){return $("#"+o.makeEntityDomId(a))},getSelecteds:function(){return $(".textae-editor__entity.ui-selected")},getNumberOfSelected:function(){return r.entity.getSelecteds().length},hasSelecteds:function(){return r.entity.getNumberOfSelected()>0},getSelectedId:function(){return r.entity.getSelecteds().attr("title")},select:function(a){r.entity.get(a).addClass("ui-selected")}}},s={loadAnnotation:function(b){var d=function(b){return void 0===b.text?(alert("read failed."),void 0):(j.sourceDoc=b.text,j.annotationData.reset(),j.annotationData.parseParagraphs(b.text),j.annotationData.parseDenotations(b.denotations),j.annotationData.parseRelations(b.relations),void 0!==b.denotations&&b.denotations.forEach(function(a){j.entityTypes.incrementNumberOfTypes(a.obj)}),c={},a={},void 0!==b.relations&&b.relations.forEach(function(a){j.relationTypes[a.pred]||(j.relationTypes[a.pred]={}),j.relationTypes[a.pred].count?j.relationTypes[a.pred].count++:j.relationTypes[a.pred].count=1,c[a.subj]?c[a.subj].indexOf(a.id)<0&&c[a.subj].push(a.id):c[a.subj]=[a.id],c[a.obj]?c[a.obj].indexOf(a.id)<0&&c[a.obj].push(a.id):c[a.obj]=[a.id]
}),void 0)};d(b),n.history.init(),p.renderAnnotation(),t.showTarget(k)},getAnnotationFromServer:function(a){k=a,d.startWait(),b.ajaxAccessor.getAsync(a,s.loadAnnotation,function(){d.endWait()})},saveAnnotation:function(){n.history.saved()},saveAnnotationToServer:function(a){d.startWait();var c=j.annotationData.toJason();b.ajaxAccessor.post(a,c,t.showSaveSuccess,t.showSaveError,function(){d.endWait()})},undo:function(){var a=function(a){var b=Object.create(a);switch(a.action){case"new_span":b.action="remove_span";break;case"remove_span":b.action="new_span";break;case"new_denotation":b.action="remove_denotation";break;case"remove_denotation":b.action="new_denotation";break;case"change_entity_type":b.old_type=a.new_type,b.new_type=a.old_type;break;case"new_relation":b.action="remove_relation";break;case"remove_relation":b.action="new_relation";break;case"change_relation_subj":b.old_subj=a.new_subj,b.new_subj=a.old_subj;break;case"change_relation_obj":b.old_obj=a.new_obj,b.new_obj=a.old_obj;break;case"change_relation_pred":b.old_pred=a.new_pred,b.new_pred=a.old_pred}return b},b=function(b){return b=Object.create(b),b.reverse(),b.map(a)};r.unselect(),p.relations.clearRelationSelection(),n.execute(b(n.history.prev()),"undo")},redo:function(){return r.unselect(),p.relations.clearRelationSelection(),n.execute(n.history.next(),"redo"),!1},replicate:function(){1==r.span.getNumberOfSelected()?n.execute(n.create.replicateSpanCommands(j.annotationData.spans[r.span.getSelectedId()])):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=[];r.span.getSelecteds().each(function(){var b=this.id;a.push({action:"new_denotation",span:b,type:j.entityTypes.getDefaultType()})}),n.execute(a)},newLabel:function(){var a=r.entity.getSelecteds();if(a.length>0){var b=prompt("Please enter a new label",""),c=[];a.each(function(){var a=this.title;console.log(a),c.push({action:"change_entity_type",id:a,old_type:j.annotationData.entities[a].type,new_type:b})}),n.execute(c)}},removeSelectedElements:function(){var a={spans:[],entities:[],relations:[],getAll:function(){return a.relations.concat(a.entities,a.spans)}},b=function(b){a.entities.push(n.create.removeEntityCommand(b)),c[b]&&Array.prototype.push.apply(a.relations,c[b].map(n.create.removeRelationCommand))};r.span.getSelecteds().each(function(){var c=this.id;a.spans.push(n.create.removeSpanCommand(c)),j.annotationData.spans[c].getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),r.entity.getSelecteds().each(function(){b(this.title)}),Array.prototype.push.apply(a.relations,p.relations.relationIdsSelected.map(n.create.removeRelationCommand)),p.relations.relationIdsSelected=[],n.execute(a.getAll())},copyEntities:function(){g.length=0,r.entity.getSelecteds().each(function(){g.push(this.title)})},pasteEntities:function(){var a=[];r.span.getSelecteds().each(function(){var b=this.id;a=a.concat(g.map(function(a){return{action:"new_denotation",span:b,type:j.annotationData.entities[a].type}}))}),n.execute(a)},setEntityTypeDefault:function(){return j.entityTypes.setDefaultType($(this).attr("label")),!1},setEntityType:function(){var a=$(this).attr("label"),b=[];return r.entity.getSelecteds().each(function(){var c=this.title;b.push({action:"change_entity_type",id:c,old_type:j.annotationData.entities[c].type,new_type:a})}),n.execute(b),!1}},t=function(a){var b=function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea};return{showTarget:function(a){if(""!==a){var c=a.replace(/\/annotations\.json$/,"");b().html("(Target: <a href='"+c+"'>"+c+"</a>)")}},showSaveSuccess:function(){b().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),t.showTarget(k)}),n.history.saved(),d.endWait()},showSaveError:function(){b.html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),t.showTarget(k)}),d.endWait()},showPallet:function(a){var b=function(){return j.entityTypes.getSortedNames().map(function(a){var b=j.entityTypes.getType(a),c='<tr class="textae-editor__entity-pallet__entity-type" style="background-color:'+b.getColor()+'">';c+='<th><input type="radio" name="etype" class="textae-editor__entity-pallet__entity-type__radio" label="'+a+'"',c+=a==j.entityTypes.getDefaultType()?' title="default type" checked':"",c+="/></th>",c+='<td class="textae-editor__entity-pallet__entity-type__label" label="'+a+'">'+a+"</td>",c+='<th title="'+d+'">';var d=b.uri;return d&&(c+='<a href="'+d+'" target="_blank"><img src="images/link.png"/></a>'),c+="</th>",c+="</tr>"}).join()},c=function(){var a=$(".textae-editor__entity-pallet");return 0===a.length?(a=$("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css({position:"fixed",display:"none"}).on("mouseup",".textae-edtior__entity-pallet__entity-type__radio",s.setEntityTypeDefault).on("mouseup",".textae-edtior__entity-pallet__entity-type__label",s.setEntityType),$("body").append(a)):(a.find("table").empty(),a.css("width","auto")),a},d=c();d.find("table").append(b(j.entityTypes)),d.outerHeight()>l.PALLET_HEIGHT_MAX&&(d.css("height",l.PALLET_HEIGHT_MAX),d.css("width",d.outerWidth()+15)),1===arguments.length?(d.css("top",a.top),d.css("left",a.left)):(d.css("top",10),d.css("left",20)),d.css("display","block")},hidePallet:function(){$(".textae-editor__entity-pallet").css("display","none")},redraw:function(){var a=function(a){var b="G"+a,c=$("#"+b);if(c.length>0){spanPosition=p.positions.span[a],gridPosition=p.positions.grid[b];var d=spanPosition.top-gridPosition.offset-gridPosition.height;c.css("top",d),gridPosition.top=d;var e=spanPosition.left;c.css("left",e),gridPosition.left=e}};j.annotationData.getAllSpan().forEach(function(b){p.positions.indexPositionSpan(b.id),a(b.id)}),Object.keys(j.annotationData.entities).forEach(function(a){p.positions.indexPositionEntity(a)}),p.relations.renewConnections()},cancelSelect:function(){return window.getSelection().isCollapsed?(r.unselect(),t.hidePallet(),f.buttonState.updateAll(),a.tool.cancelSelect(),void 0):(r.dismissBrowserSelection(),!0)},selectLeftSpan:function(){if(1==r.span.getNumberOfSelected()){var a=j.annotationData.spans[r.span.popSelectedId()];r.unselect(),a.left&&r.span.select(a.left.id)}},selectRightSpan:function(){if(1==r.span.getNumberOfSelected()){var a=j.annotationData.spans[r.span.popSelectedId()];r.unselect(),a.right&&r.span.select(a.right.id)}}}}(this),u={createEntity:s.createEntity,removeSelectedElements:s.removeSelectedElements,copyEntities:s.copyEntities,pasteEntities:s.pasteEntities,replicate:s.replicate,showPallet:t.showPallet,showAccess:function(){e.showAccess(k)},showSave:function(){e.showSave(k,j.annotationData.toJason())},newLabel:s.newLabel,redo:function(){n.history.hasAnythingToRedo()&&s.redo()},undo:function(){n.history.hasAnythingToUndo()&&s.undo()},start:function(){m()},handleKeyInput:function(a){var b={A:u.showAccess,C:u.copyEntities,D:u.removeSelectedElements,DEL:u.removeSelectedElements,E:u.createEntity,Q:u.showPallet,R:u.replicate,S:u.showSave,V:u.pasteEntities,W:u.newLabel,X:u.redo,Y:u.redo,Z:u.undo,ESC:t.cancelSelect,LEFT:t.selectLeftSpan,RIGHT:t.selectRightSpan};b[a]&&b[a]()},handleButtonClick:function(a){var b={"textae.control.button.read.click":u.showAccess,"textae.control.button.write.click":u.showSave,"textae.control.button.undo.click":u.undo,"textae.control.button.redo.click":u.redo,"textae.control.button.replicate.click":u.replicate,"textae.control.button.replicate_auto.click":f.toggleReplicateAuto,"textae.control.button.entity.click":u.createEntity,"textae.control.button.new_label.click":u.newLabel,"textae.control.button.pallet.click":function(){u.showPallet(a.point)},"textae.control.button.delete.click":u.removeSelectedElements,"textae.control.button.copy.click":u.copyEntities,"textae.control.button.paste.click":u.pasteEntities};b[a.name]()},redraw:t.redraw};return this.api=u,this},d=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b={},c=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},d=function(){var a=function(){return $("<span>").addClass("textae-control__separator")},c=function(a,c){var d=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",c);return b[a]={obj:d,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},d};return $($("<span>").append(a()).append(c("read","Access [A]")).append(c("write","Save [S]")).append(a()).append(c("undo","Undo [Z]")).append(c("redo","Redo [X]")).append(a()).append(c("replicate","Replicate span annotation [R]")).append(c("replicate-auto","Auto replicate (Toggle)")).append(a()).append(c("entity","New entity [E]")).append(c("pallet","Select label [Q]")).append(c("new-label","Enter label [W]")).append(a()).append(c("delete","Delete [D]")).append(c("copy","Copy [C]")).append(c("paste","Paste [V]")).append(a()).append(c("help","Help [H]")).append(c("about","About")).append(a()))},e=function(c,d){return function(e,f){var g=b[e],h=function(a){d.buttonClick({name:g.eventName,point:{top:a.clientY-d.get(0).offsetTop,left:a.clientX-d.get(0).offsetLeft}})};g&&(f?(g.obj.off(c).on(c,h),a.enable(g.obj)):(g.obj.off(c),a.disable(g.obj)))}}("click",this),f=function(a){for(var c in b)e(c,!a.hasOwnProperty(c))},g=function(c){c?a.push(b["replicate-auto"].obj):a.unpush(b["replicate-auto"].obj)};return this.append(c()).append(d()),e("read",!0),e("replicateAuto",!0),e("help",!0),e("about",!0),this.updateAllButtonEnableState=f,this.updateReplicateAutoButtonPushState=g,this},e=function(){{var a={control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoDialogs:{help:b.makeInformationDialog({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<img>").attr("src","images/keyhelp.png"))}}),about:b.makeInformationDialog({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")}}),hideAll:function(){a.infoDialogs.help.hide(),a.infoDialogs.about.hide()}}},c={handleKeyInput:function(b){"H"===b?a.infoDialogs.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(b),"ESC"===b&&a.infoDialogs.hideAll())},handleButtonClick:function(b){switch(b.name){case"textae.control.button.help.click":a.infoDialogs.help.show();break;case"textae.control.button.about.click":a.infoDialogs.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(b)}},handleEditor:{select:function(b){a.editors.select(b)},cancel:function(){a.infoDialogs.hideAll()},changeButtonState:function(b){a.control.updateAllButtonEnableState(b)},pushReplicateAuto:function(b){a.control.updateReplicateAutoButtonPushState(b)}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},d=!0,e=function(a){d&&c.handleKeyInput(b(a.keyCode))};$(document).on("keyup",e),$("body").on("dialogopen",".ui-dialog",function(){d=!1}).on("dialogclose",".ui-dialog",function(){d=!0})},d=function(){$(window).on("resize",function(){a.editors.forEach(function(a){a.api.redraw()})})};$(function(){b(),d()})}()}return{setControl:function(b){$.extend(b,{buttonClick:function(a){c.handleButtonClick(a)}}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:{selectMe:c.handleEditor.select.bind(this,b),cancelSelect:c.handleEditor.cancel,changeButtonState:c.handleEditor.changeButtonState,pushReplicateAuto:c.handleEditor.pushReplicateAuto}})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return e.pushEditor(a),c.apply(a),a.api.start(),a}),e.selectFirstEditor();else if(this.hasClass("textae-control")){var a=d.apply(this);return e.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);