/*! textae 0.0.1 10-12-2013 */
!function(a){var b={ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||$.ajax({type:"post",url:b,contentType:"application/json",data:{annotations:c}}).done(d).fail(e).always(f)}}}(),getUrlParameters:function(a){var b=a?(""+a).slice(1).split("&"):[],c="",d="",e=!1;return b.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).forEach(function(a){switch(a.key){case"target":c=a.val;break;case"config":d=a.val;break;case"debug":e=!0}}),{target:c,config:d,debug:e}},makeInformationDialog:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-dialog").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-dialog").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-dialog",function(){$(this).hide()})}),c}()},c=function(){var a,c,d,e,f=function(a){var b=function(){a.css("cursor","wait")},c=function(){a.css("cursor","auto")};return{startWait:b,endWait:c}}(this),g=function(){var a=function(){$body=$("body");var a=$body.find("#textae.dialog.load");if(0===a.length){a=$('<div id="textae.dialog.load" title="Load document with annotation.">').append('<div>Sever :<input type="text" style="width:345px"/><input type="button" value="OK" /></div>').append('<div>Local :<input type="file"　/></div>');var b=function(){var b=new FileReader;b.onload=function(){var b=JSON.parse(this.result);u.loadAnnotation(b),a.dialog("close")},b.readAsText(this.files[0])};$body.append(a),a.hide(),a.find("input[type='file']").on("change",b),a.find("input[type='button']").on("click",function(){var b=a.find("input[type='text']").val();u.getAnnotationFromServer(b),a.dialog("close")})}return a};return{showAccess:function(b){var c=a();c.find("input[type='text']").val(b),c.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:{Cancel:function(){$(this).dialog("close")}}})},showSave:function(b,c){var d=function(){$body=$("body");var a=$body.find("#textae.dialog.save");return 0===a.length&&(a=$('<div id="textae.dialog.save" title="Save document with annotation.">').append('<div>Sever :<input type="text" style="width:345px"/><input type="button" value="OK" /></div>').append('<div>Local :<span class="span_link_place"><a target="_blank"/></span></div>'),$body.append(a),a.hide(),a.on("click","a",function(){u.saveAnnotation(),a.dialog("close")}).on("click","input[type='button']",function(){var b=a.find("input[type='text']").val();u.saveAnnotationToServer(b),a.dialog("close")})),a},e=function(b,c){{var d=a().find("input[type='file']"),e=d.prop("files")[0],f=e?e.name:"annotations.json",g=new Blob([b],{type:"application/json"});c.find("a").text(f).attr("href",URL.createObjectURL(g)).attr("download",f)}},f=d();e(c,f),f.find("input[type='text']").val(b),f.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:{Cancel:function(){$(this).dialog("close")}}})}}}(),h=function(a){return{isReplicateAuto:!1,buttonState:function(){var b={},c=function(a,c){c?delete b[a]:b[a]=!0},d=function(){c("entity",t.span.getNumberOfSelected()>0)},e=function(){c("paste",i.length>0&&t.span.getNumberOfSelected()>0)},f=function(){c("replicate",1==t.span.getNumberOfSelected())},g=function(){c("pallet",t.entity.getNumberOfSelected()>0)},h=function(){c("newLabel",t.entity.getNumberOfSelected()>0)},j=function(){c("delete",t.hasSelecteds())},k=function(){c("copy",t.entity.hasSelecteds())},l=function(){j(),k()};return{pushed:function(b,c){a.tool.pushReplicateAuto(c)},renderEnable:function(){a.tool.changeButtonState(b)},enabled:function(a,b){c(a,b),this.renderEnable()},updateBySpan:function(){l(),d(),e(),f(),this.renderEnable()},updateByEntity:function(){l(),g(),h(),this.renderEnable()},updateAll:function(){l(),d(),e(),f(),g(),h(),this.renderEnable()}}}(),toggleReplicateAuto:function(){h.isReplicateAuto=!h.isReplicateAuto,h.buttonState.pushed("replicate-auto",h.isReplicateAuto)}}}(this),i=[],j={connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},k={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf(a)>=0}},l=function(){return{sourceDoc:"",relationTypes:{},relationTypeDefault:"",annotationData:function(){var a=function(){var a=Object.keys(l.annotationData.spans),b=function(a,b){var c=l.annotationData.spans;return c[a].begin-c[b].begin||c[b].end-c[a].end};a.sort(b),$.extend(a,{getPrevSpanId:function(a){return this[this.indexOf(a)-1]}}),l.annotationData.spanIds=a},b=function(){var a=Object.keys(l.annotationData.entities).filter(function(a){return"E"===a[0]}).map(function(a){return a.slice(1)});return a.sort(function(a,b){return b-a}),parseInt(a[0])||0};return{spans:null,entities:null,relations:null,spanIds:null,reset:function(){l.annotationData.spans={},l.annotationData.entities={},l.annotationData.relations={}},addSpan:function(b){var c=q.makeSpanId(b.begin,b.end);l.annotationData.spans[c]={begin:b.begin,end:b.end},a()},getSpan:function(a){return l.annotationData.spans[a]},removeSpan:function(b){delete l.annotationData.spans[b],a()},parseDenotations:function(b){b&&b.forEach(function(a){var b=a.span,c=q.makeSpanId(b.begin,b.end);l.annotationData.spans[c]={begin:b.begin,end:b.end},l.annotationData.entities[a.id]={id:a.id,span:c,type:a.obj}}),a()},parseRelations:function(a){a&&a.forEach(function(a){l.annotationData.relations[a.id]=a})},getRelationIds:function(){return Object.keys(l.annotationData.relations)},getNewEntityId:function(){return"E"+(b()+1)},toJason:function(){var a=[];for(var b in l.annotationData.entities){var c={begin:l.annotationData.spans[l.annotationData.entities[b].span].begin,end:l.annotationData.spans[l.annotationData.entities[b].span].end};a.push({id:b,span:c,obj:l.annotationData.entities[b].type})}return JSON.stringify({text:l.sourceDoc,denotations:a})}}}(),entityTypes:function(){var a={},b="",c=function(){return this.color?this.color:"#77DDDD"};return{setDefaultType:function(a){b=a},getDefaultType:function(){return b||l.entityTypes.getSortedNames()[0]},getType:function(b){return a[b]=a[b]||{getColor:c},a[b]},set:function(d){a={},b="",void 0!==d&&d.forEach(function(d){d.getColor=c,a[d.name]=d,d["default"]===!0&&(b=d.name)})},incrementNumberOfTypes:function(a){var b=l.entityTypes.getType(a);b.count=(b.count||0)+1},getSortedNames:function(){var b=Object.keys(a);return b.sort(function(b,c){return a[c].count-a[b].count}),b}}}(),connectorTypes:{},getSpanReplications:function(a){for(var b=function(a,b,c){var d=a.charAt(b-1),e=a.charAt(c);return k.isDelimiter(d)&&k.isDelimiter(e)?!1:!0},c=function(a,c){for(var d=l.sourceDoc.substring(a,c),e=c-a,f=[],g=0;;){var h=l.sourceDoc.indexOf(d,g);if(-1==h)break;if(!b(l.sourceDoc,h,h+e)){var i={};i.begin=h,i.end=h+e;var j=!1;for(var k in l.annotationData.spans)if(l.annotationData.spans[k].begin==i.begin&&l.annotationData.spans[k].end==i.end&&l.annotationData.spans[k].category==i.category){j=!0;break}j||a==h||f.push(i)}g=h+1}return f},d=a.begin,e=a.end,f=c(d,e),g=[],h=0;h<f.length;h++){cspan=f[h];var i=!1;for(var j in l.annotationData.spans)if(cspan.begin>l.annotationData.spans[j].begin&&cspan.begin<l.annotationData.spans[j].end&&cspan.end>l.annotationData.spans[j].end||cspan.begin<l.annotationData.spans[j].begin&&cspan.end>l.annotationData.spans[j].begin&&cspan.end<l.annotationData.spans[j].end){i=!0;break}i||g.push(cspan)}}}}(this),m="",n={BLOCK_THRESHOLD:100,TYPE_MARGIN_TOP:18,TYPE_MARGIN_BOTTOM:2,PALLET_HEIGHT_MAX:100},o=function(){var a=function(a){if(l.entityTypes.set(a["entity types"]),l.relationTypes={},l.relationTypeDefault=null,void 0!==a["relation types"]){var b=a["relation types"];for(var c in b)l.relationTypes[b[c].name]=b[c],b[c]["default"]===!0&&(l.relationTypeDefault=b[c].name);l.relationTypeDefault||(l.relationTypeDefault=b[0].name)}l.connectorTypes={},void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')},c=function(){p.history.init(p.historyChanged),h.buttonState.updateAll()};r.init(),s.init(),c(),k.set();var d={debug:this.attr("debug"),config:this.attr("config"),target:this.attr("annotations")};if(d.config&&""!==d.config){var e=b.ajaxAccessor.getSync(d.config);null!==e?(k.set(e),a(e)):alert("could not read the span configuration from the location you specified.")}d.target&&""!==d.target&&u.getAnnotationFromServer(d.target)}.bind(this),p={history:function(){var a,b=-1,c=-1,d=[],e=function(){a&&a()};return{init:function(f){b=-1,c=-1,d=[],void 0!==f&&(a=f.bind(this)),e()},push:function(a){d.push(a),c++,e()},next:function(){return c++,e(),d[c]},prev:function(){var a=d[c];return c--,e(),a},saved:function(){b=c,e()},hasAnythingToUndo:function(){return c>-1},hasAnythingToRedo:function(){return c<d.length-1},hasAnythingToSave:function(){return c!=b}}}(),historyChanged:function(){var a=function(){return"There is a change that has not been saved. If you leave now, you will lose it."};h.buttonState.enabled("write",this.hasAnythingToSave()),h.buttonState.enabled("undo",this.hasAnythingToUndo()),h.buttonState.enabled("redo",this.hasAnythingToRedo()),this.hasAnythingToSave()?$(window).off("beforeunload",a).on("beforeunload",a):$(window).off("beforeunload",a)},execute:function(b,f){if(b&&b.length>0){switch(f){case"undo":case"redo":t.unselect(),r.relations.clearRelationSelection()}var g,i;for(var j in b){var k=b[j];switch(k.action){case"new_span":l.annotationData.addSpan({begin:k.begin,end:k.end}),c[k.id]=[],r.renderSpan(k.id),r.positions.indexPositionSpan(k.id),t.span.select(k.id);break;case"remove_span":var m=l.annotationData.getSpan(k.id);k.begin=m.begin,k.end=m.end,l.annotationData.removeSpan(k.id),c[k.id]=[],r.destroySpan(k.id),r.renderGrid(k.id);break;case"new_denotation":k.id||(k.id=l.annotationData.getNewEntityId());var n={id:k.id,span:k.span,type:k.type};l.annotationData.entities[k.id]=n,g=q.makeTypeId(k.span,k.type),c[k.span].indexOf(g)<0&&(c[k.span].push(g),d[g]=[],r.renderGrid(k.span)),d[g].push(k.id),r.renderEntity(n),t.entity.select(k.id);break;case"remove_denotation":delete l.annotationData.entities[k.id],g=q.makeTypeId(k.span,k.type),i=d[g],i.splice(i.indexOf(k.id),1),r.destroyEntity(k.id),r.positionEntityPanel(k.span,k.type),0===d[g].length&&(delete d[g],i=c[k.span],i.splice(i.indexOf(g),1),r.destroyType(g),r.renderGrid(k.span));break;case"change_entity_type":l.annotationData.entities[k.id].type=k.new_type,r.renderEntity(l.annotationData.entities[k.id]);break;case"new_relation":l.annotationData.relations[k.id]={id:k.id,subj:k.subj,obj:k.obj,pred:k.pred},e[k.subj]?e[k.subj].indexOf(k.id)<0&&e[k.subj].push(k.id):e[k.subj]=[k.id],e[k.obj]?e[k.obj].indexOf(k.id)<0&&e[k.obj].push(k.id):e[k.obj]=[k.id],a[k.id]=r.relations.renderRelation(k.id),r.relations.selectRelation(k.id);break;case"remove_relation":delete l.annotationData.relations[k.id],i=e[k.subj],i.splice(i.indexOf(k.id),1),0===i.length&&delete e[k.subj],i=e[k.obj],i.splice(i.indexOf(k.id),1),0===i.length&&delete e[k.obj],r.relations.destroyRelation(k.id);break;case"change_relation_pred":l.annotationData.relations[k.id].pred=k.new_pred,a[k.id].setPaintStyle(l.connectorTypes[k.new_pred+"_selected"].paintStyle),a[k.id].setHoverPaintStyle(l.connectorTypes[k.new_pred+"_selected"].hoverPaintStyle),a[k.id].setLabel("["+k.id+"] "+k.new_pred),r.relations.selectRelation(k.id)}}switch(v.redraw(),f){case"undo":case"redo":break;default:p.history.push(b),h.buttonState.updateAll()}}},getReplicateSpanCommands:function(a){for(var b=l.getSpanReplications(a),c=[],d=0;d<b.length;d++){var e=b[d],f=q.makeSpanId(e.begin,e.end);c.push({action:"new_span",id:f,begin:e.begin,end:e.end})}return c}},q=function(a){return{makeParagraphId:function(b){return a.editorId+"__P"+b},makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},makeTypeId:function(a,b){return a+"-"+b},makeEntityDomId:function(b){return a.editorId+"__E"+b}}}(this),r=function(b){var e=function(a){return l.relationTypes&&l.relationTypes[a]&&l.relationTypes[a].color?l.relationTypes[a].color:"#555555"},f=function(a,b){var c=a.slice(1),d=c.substr(0,2),e=c.substr(2,2),f=c.substr(4,2);return d=parseInt(d,16),e=parseInt(e,16),f=parseInt(f,16),"rgba("+d+", "+e+", "+f+", "+b+")"};return{init:function(){var a=function(a,c){var d=b.find("."+c);return 0===d.length&&(d=$("<div>").addClass(c),a.append(d)),d},c=function(){r.jsPlumb=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]}),r.jsPlumb.setRenderMode(r.jsPlumb.SVG),r.jsPlumb.Defaults.Container=b.getAnnotationArea()};b.body=a(b,"textae-editor__body"),$.extend(b,{getSourceDocArea:function(){return a(b.body,"textae-editor__body__text-box")},getAnnotationArea:function(){return a(b.body,"textae-editor__body__annotation_box")}}),c()},renderAnnotation:function(){var a=function(){var a=b.getSourceDocArea();a.html(l.sourceDoc);var c=a.get(0).getClientRects(),d=c[1].top-c[0].bottom;b.find(".textae-editor__body").css("paddingTop",d/2),a.empty()},g=function(){return l.sourceDoc.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph">'+a+"</p>"}).join("\n")},h=function(){var a=$.extend({},{getBySid:function(a){var b=l.annotationData.getSpan(a);if(b)for(var c in r.paragraphs){var d=r.paragraphs[c];if(b.begin>=d.begin&&b.end<=d.end)return d}return null}}),c=0,d=0;return b.getSourceDocArea().find("p").each(function(){var b=q.makeParagraphId(c),e=$(this),f=e.text().length;a[b]={id:b,begin:d,end:d+f,element:e},d+=f+1,e.attr("id",b),c++}),a},i=function(a){r.renderGrid(a),c[a].forEach(function(a){d[a].forEach(function(a){r.renderEntity(l.annotationData.entities[a])})})},k=function(){l.annotationData.spanIds.forEach(function(a){r.renderSpan(a),r.positions.indexPositionSpan(a),i(a)})},m=function(){for(var a in l.relationTypes){var b=e(a),c=f(b,j.connOpacity),d=f(b,1);l.connectorTypes[a]={paintStyle:{strokeStyle:c,lineWidth:1},hoverPaintStyle:{strokeStyle:d,lineWidth:3}},l.connectorTypes[a+"_selected"]={paintStyle:{strokeStyle:d,lineWidth:3},hoverPaintStyle:{strokeStyle:d,lineWidth:3}}}};m(),a();var n=b.getSourceDocArea();n.html(g()),r.paragraphs=h(),b.getAnnotationArea().empty(),r.renderSize.mesure(),r.positions.reset(),k(),r.relations.renderRelations()},renderSize:{gridWidthGap:0,typeHeight:0,entityWidth:0,mesure:function(){var a='<div id="temp_grid" class="grid" style="width:10px; height:auto"></div>';b.getAnnotationArea().append(a),a='<div id="temp_type" class="type" title="[Temp] Temp" >T0</div>',$("#temp_grid").append(a),a='<div id="temp_entity_pane" class="entity_pane"><div id="temp_entity" class="entity"></div></div>',$("#temp_type").append(a),r.renderSize.gridWidthGap=$("#temp_grid").outerWidth()-10,r.renderSize.typeHeight=$("#temp_type").outerHeight(),r.renderSize.entityWidth=$("#temp_entity").outerWidth(),$("#temp_grid").remove()}},createDiv:function(a,c,d,e,f,g,h){b.getAnnotationArea().append('<div id="'+a+'"></div');var i=$("#"+a);return i.addClass(c),i.attr("title",h),i.css("position","absolute"),i.css("top",d),i.css("left",e),i.css("width",f),i.css("height",g),a},renderSpan:function(a){var b=function(a){var b=l.annotationData.spanIds.getPrevSpanId(a),c=r.paragraphs.getBySid(a),d=l.annotationData.spans[a],e=(d.end-d.begin,function(a,b,c){var d=document.createRange();return d.setStart(b,a.begin-c),d.setEnd(b,a.end-c),d}.bind(this,d));if(r.paragraphs.getBySid(b)!=c)return textNodeInParagraph=c.element.contents().filter(function(){return 3===this.nodeType}).get(0),e(textNodeInParagraph,c.begin);var f=l.annotationData.spans[b];if(d.begin<f.begin)console.log("Error: sid is not sorted");else{if(f.end<=d.begin){for(var g=document.getElementById(b);g.parentElement&&l.annotationData.spans[g.parentElement.id]&&l.annotationData.spans[g.parentElement.id].end<d.begin;)g=g.parentElement;return e(g.nextSibling,l.annotationData.spans[g.id].end)}if(f.end<d.end);else if(d.end<=f.end){var h=$("#"+b).contents().filter(function(){return 3===this.nodeType}).get(0);return e(h,f.begin)}}},c=document.createElement("span");c.setAttribute("id",a),c.setAttribute("title",a),c.setAttribute("class","span"),b(a).surroundContents(c)},destroySpan:function(a){for(var b=document.getElementById(a),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);c.removeChild(b),c.normalize()},renderEntity:function(a){var b=function(a,b){var c=$('<div id="'+b+'"></div>');return c.addClass("type"),c.css("background-color",l.entityTypes.getType(a).getColor()),c.css("margin-top",n.TYPE_MARGIN_TOP),c.css("margin-bottom",n.TYPE_MARGIN_BOTTOM),c.attr("title",a),c.append('<div id="P-'+b+'" class="entity_pane"></div>'),c.append('<div class="type_label">'+a+"</div>"),c},c=function(a,c){var d=q.makeTypeId(a,c),e=$("#"+d);return 0===e.length&&(e=b(c,d),$("#G"+a).append(e)),e},d=function(a){var b=$('<div id="'+q.makeEntityDomId(a)+'" class="entity" />');b.attr("title",a),b.css("display: inline-block");var c=l.annotationData.entities[a].type;return b.css("border-color",l.entityTypes.getType(c).getColor()),b};if(0===t.entity.get(a.id).length){var e=d(a.id);c(a.span,a.type).find(".entity_pane").append(e),r.positionEntityPanel(a.span,a.type),r.positions.indexPositionEntity(a.id)}},positions:{reset:function(){this.span={},this.grid={},this.entity={}},indexPositionSpan:function(a){var b=$("#"+a);r.positions.span[a]={top:b.get(0).offsetTop,left:b.get(0).offsetLeft,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}},indexPositionEntity:function(a){var b="G"+l.annotationData.entities[a].span,c=t.entity.get(a);r.positions.entity[a]={top:r.positions.grid[b].top+c.get(0).offsetTop,left:r.positions.grid[b].left+c.get(0).offsetLeft,width:c.outerWidth(),height:c.outerHeight(),center:r.positions.grid[b].left+c.get(0).offsetLeft+c.outerWidth()/2}}},renderGrid:function(a){var b="G"+a,d=$("#"+b);if(c[a].length<1)return d.length>0&&(d.remove(),delete r.positions.grid[b]),null;var e=c[a].length*(r.renderSize.typeHeight+n.TYPE_MARGIN_BOTTOM+n.TYPE_MARGIN_TOP),f={offset:n.TYPE_MARGIN_BOTTOM,top:r.positions.span[a].top-n.TYPE_MARGIN_BOTTOM-e,left:r.positions.span[a].left,width:r.positions.span[a].width-r.renderSize.gridWidthGap,height:e};return 0===d.length?r.createDiv(b,"$grid",f.top,f.left,f.width,f.height):(d=$("#"+b),d.css("top",f.top),d.css("left",f.left),d.css("width",f.width),d.css("height",f.height)),r.positions.grid[b]=f,b},destroyType:function(a){$("#"+a).remove()},positionEntityPanel:function(a,b){var c=q.makeTypeId(a,b),e=(r.positions.grid["G"+a].width-r.renderSize.entityWidth*d[c].length)/2;$("#P-"+c).css("left",e)},destroyEntity:function(a){t.entity.get(a).remove()},relations:function(){var b=function(a,b){var c=r.positions.entity[a].center,d=r.positions.entity[b].center,e=r.positions.entity[a].top,f=r.positions.entity[b].top,g=Math.abs(c-d),h=Math.abs(e-f),i=g*j.xrate+h*j.yrate+j.c_offset;return i/=2.4};return{renderRelations:function(){var b=l.annotationData.getRelationIds();r.jsPlumb.reset(),b.forEach(function(b){a[b]=r.relations.renderRelation(b)}),r.relations.relationIdsSelected=[]},renewConnections:function(){var c=l.annotationData.getRelationIds();c.forEach(function(c){var d=l.annotationData.relations[c].subj,e=l.annotationData.relations[c].obj,f=b(d,e);d==e&&(f=30);{var g=a[c];g.getLabel()}g.endpoints[0].repaint(),g.endpoints[1].repaint(),g.setConnector(["Bezier",{curviness:f}])})},renderRelation:function(a){var c=l.annotationData.relations[a].subj,d=l.annotationData.relations[a].obj,g=b(c,d),h="TopCenter",i="TopCenter";c==d&&(h=[.5,0,-1,-1],i=[.5,0,1,-1],g=30);var k=l.annotationData.relations[a].pred,m=(f(e(k),j.connOpacity),t.entity.get(c)),n=t.entity.get(d),o="["+a+"] "+k,p=r.jsPlumb.connect({source:m,target:n,anchors:[h,i],connector:["Bezier",{curviness:g}],paintStyle:l.connectorTypes[k].paintStyle,hoverPaintStyle:l.connectorTypes[k].hoverPaintStyle,tooltip:"["+a+"] "+k,parameters:{id:a,label:o}});return p.addOverlay(["Arrow",{width:10,length:12,location:1}]),p.setLabel({label:o,cssClass:"label"}),p.bind("click",s.connectorClicked),p},isRelationSelected:function(a){return r.relations.relationIdsSelected.indexOf(a)>-1},selectRelation:function(b){r.relations.isRelationSelected(b)||(a[b].setPaintStyle(l.connectorTypes[l.annotationData.relations[b].pred+"_selected"].paintStyle),r.relations.relationIdsSelected.push(b))},deselectRelation:function(b){var c=r.relations.relationIdsSelected.indexOf(b);c>-1&&(a[b].setPaintStyle(l.connectorTypes[l.annotationData.relations[b].pred].paintStyle),r.relations.relationIdsSelected.splice(c,1))},clearRelationSelection:function(){for(;r.relations.relationIdsSelected.length>0;){var b=r.relations.relationIdsSelected.pop();a[b].setPaintStyle(l.connectorTypes[l.annotationData.relations[b].pred].paintStyle)}},destroyRelation:function(b){var c=a[b];r.jsPlumb.detach(c)}}}()}}(this),s=function(a){var b=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},e=function(e){var f=function(a){var b,c=$(a).parent(),d=c.attr("id");b=c.hasClass("textae-editor__body__text-box__paragraph")?r.paragraphs[d].begin:l.annotationData.spans[d].begin;for(var e=a.parentElement.childNodes,f=0;e[f]!=a;f++)b+="#text"==e[f].nodeName?e[f].nodeValue.length:$("#"+e[f].id).text().length;return b},g=function(a){var b=f(a.focusNode);return b+=a.focusOffset},i=function(a){var b=f(a.anchorNode);return b+a.anchorOffset},j=function(a){for(var b=a;k.isNonEdgeCharacter(l.sourceDoc.charAt(b));)b++;for(;!k.isDelimiter(l.sourceDoc.charAt(b))&&b>0&&!k.isDelimiter(l.sourceDoc.charAt(b-1));)b--;return b},m=function(a){for(var b=a;k.isNonEdgeCharacter(l.sourceDoc.charAt(b-1));)b--;for(;!k.isDelimiter(l.sourceDoc.charAt(b))&&b<l.sourceDoc.length;)b++;return b},o=function(a){for(var b=a;b<l.sourceDoc.length&&(k.isNonEdgeCharacter(l.sourceDoc.charAt(b))||!k.isDelimiter(l.sourceDoc.charAt(b-1)));)b++;return b},s=function(a){for(var b=a;b>0&&(k.isNonEdgeCharacter(l.sourceDoc.charAt(b-1))||!k.isDelimiter(l.sourceDoc.charAt(b)));)b--;return b},w=function(a,b,e){var f=[],g=q.makeSpanId(b,e);return l.annotationData.spans[g]||(f.push({action:"remove_span",id:a}),f.push({action:"new_span",id:g,begin:b,end:e}),c[a].forEach(function(a){d[a].forEach(function(a){type=l.annotationData.entities[a].type,f.push({action:"new_denotation",id:a,span:g,type:type})})})),f},x=function(a,b){var c=[],d=g(b),e=b.getRangeAt(0),f=document.createRange();if(f.selectNode(b.anchorNode),e.compareBoundaryPoints(Range.START_TO_START,f)<0){var h=j(d);c=w(a,h,l.annotationData.spans[a].end)}else{var i=m(d);c=w(a,l.annotationData.spans[a].begin,i)}p.execute(c)},y=function(a,b){var c=[],d=g(b),e=b.getRangeAt(0),f=document.createRange();f.selectNode(b.focusNode);var h,i=function(a){var b=[];return b.push({action:"remove_span",id:a}),b};if(e.compareBoundaryPoints(Range.START_TO_START,f)>0){var j=s(d);j>l.annotationData.spans[a].begin?(h=q.makeSpanId(l.annotationData.spans[a].begin,j),c=l.annotationData.spans[h]?i(a):w(a,l.annotationData.spans[a].begin,j)):(t.span.select(a),u.removeSelectedElements())}else{var k=o(d);k<l.annotationData.spans[a].end?(h=q.makeSpanId(k,l.annotationData.spans[a].end),c=l.annotationData.spans[h]?i(a):w(a,k,l.annotationData.spans[a].end)):(t.span.select(a),u.removeSelectedElements())}p.execute(c)},z=window.getSelection();if(z){var A=z.getRangeAt(0);if(A.startContainer==a.getSourceDocArea().get(0)||e.shiftKey||z.isCollapsed)return v.cancelSelect(),v.dismissBrowserSelection(),!0;var B,C=i(z),D=g(z);if(z.anchorNode.parentElement.id===z.focusNode.parentElement.id){if(t.unselect(),C>D){var E=C;C=D,D=E}if(0===C&&D==l.sourceDoc.length)return!0;var F=j(C),G=m(D);if(B=q.makeSpanId(F,G),!l.annotationData.spans[B])if(G-F>n.BLOCK_THRESHOLD)p.execute([{action:"new_span",id:B,begin:F,end:G}]);else{var H=[{action:"new_span",id:B,begin:F,end:G}];if(h.isReplicateAuto){var I=p.getReplicateSpanCommands({begin:F,end:G});H=H.concat(I)}p.execute(H)}}else z.anchorNode.parentNode.parentNode==z.focusNode.parentNode?(t.unselect(),x(z.anchorNode.parentNode.id,z)):z.anchorNode.parentNode==z.focusNode.parentNode.parentNode?(t.unselect(),y(z.focusNode.parentNode.id,z)):1==t.span.getNumberOfSelected()?(B=t.span.popSelectedId(),C>l.annotationData.spans[B].begin&&C<l.annotationData.spans[B].end?$("#"+B).get(0).parentNode.id==z.focusNode.parentNode.id?x(B,z):(t.span.select(B),alert("A span cannot be expanded to make a boundary crossing.")):D>l.annotationData.spans[B].begin&&D<l.annotationData.spans[B].end?$("#"+B).get(0).id==z.focusNode.parentNode.id?y(B,z):(t.span.select(B),alert("A span cannot be shrinked to make a boundary crossing.")):alert("It is ambiguous for which span you want to adjust the boundary. Reselect the span, and try again.")):alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again.")}v.dismissBrowserSelection(),b(e)},f=function(a){v.hidePallet();{var b=window.getSelection();b.getRangeAt(0)}if(b.isCollapsed)a.ctrlKey?(t.domElement.toggle(a.target),h.buttonState.updateBySpan()):(t.domElement.selectOnly(a.target),h.buttonState.updateAll());else{if(!a.shiftKey||1!=t.span.getNumberOfSelected())return!0;var c=t.span.popSelectedId(),d=$(this).attr("id");v.dismissBrowserSelection(),t.unselect();var e=l.annotationData.spanIds.indexOf(c),f=l.annotationData.spanIds.indexOf(d);if(e>f){var g=e;e=f,f=g}for(var i=e;f>=i;i++)t.span.select(l.annotationData.spanIds[i]);h.buttonState.updateBySpan()}return!1},g=function(a){return a.ctrlKey?(t.domElement.toggle(a.target),mouseover.buttonState.updateByEntity()):(t.domElement.selectOnly(a.target),h.buttonState.updateAll()),b(a),!1},i=function(a){var b=$(this),c=b.attr("id");"mouseover"==a.type?(b.css("height","auto"),b.outerWidth()<r.positions.grid[c].width&&b.css("width",r.positions.grid[c].width)):b.css("height",r.positions.grid[c].height)},j=function(){a.tool.selectMe(),h.buttonState.renderEnable()};return{init:function(){a.on("mouseup",".textae-editor__body",e).on("mouseup",".span",f).on("mouseup",".entity",g).on("mouseover mouseout",".grid",i).on("mouseup",".textae-editor__body,.span,.entity,.grid",j)},connectorClicked:function(a,c){var d=a.getParameter("id");return t.unselect(),r.relations.isRelationSelected(d)?r.relations.deselectRelation(d):(c.ctrlKey||r.relations.clearRelationSelection(),r.relations.selectRelation(d)),b(c),!1}}}(this),t={getSelecteds:function(){return $(".ui-selected")},hasSelecteds:function(){return t.getSelecteds().length>0},unselect:function(){t.getSelecteds().removeClass("ui-selected"),h.buttonState.updateAll()},domElement:function(){var a=function(a){return $(a).hasClass("ui-selected")},b=function(a){$(a).addClass("ui-selected")},c=function(a){$(a).removeClass("ui-selected")};return{toggle:function(d){a(d)?c(d):b(d)},selectOnly:function(a){t.getSelecteds().removeClass("ui-selected"),b(a)}}}(),span:{getSelecteds:function(){return $(".span.ui-selected")},getNumberOfSelected:function(){return t.span.getSelecteds().length},getSelectedId:function(){return t.span.getSelecteds().attr("id")},popSelectedId:function(){var a=t.span.getSelecteds();return 1===a.length?(a.removeClass("ui-selected"),a.attr("id")):null},select:function(a){$("#"+a).addClass("ui-selected"),h.buttonState.updateBySpan()}},entity:{get:function(a){return $("#"+q.makeEntityDomId(a))},getSelecteds:function(){return $(".entity.ui-selected")},getNumberOfSelected:function(){return t.entity.getSelecteds().length},hasSelecteds:function(){return t.entity.getNumberOfSelected()>0},getSelectedId:function(){return t.entity.getSelecteds().attr("title")},select:function(a){t.entity.get(a).addClass("ui-selected")}}},u={loadAnnotation:function(b){var f=function(b){return void 0===b.text?(alert("read failed."),void 0):(l.sourceDoc=b.text,l.annotationData.reset(),l.annotationData.parseDenotations(b.denotations),l.annotationData.parseRelations(b.relations),d={},c={},e={},a={},void 0!==b.denotations&&b.denotations.forEach(function(a){var b=a.span,e=q.makeSpanId(b.begin,b.end),f=a.obj;l.entityTypes.incrementNumberOfTypes(f);var g=q.makeTypeId(e,f);c[e]?c[e].indexOf(g)<0&&c[e].push(g):c[e]=[g],d[g]?d[g].push(a.id):d[g]=[a.id]}),void 0!==b.relations&&b.relations.forEach(function(a){l.relationTypes[a.pred]||(l.relationTypes[a.pred]={}),l.relationTypes[a.pred].count?l.relationTypes[a.pred].count++:l.relationTypes[a.pred].count=1,e[a.subj]?e[a.subj].indexOf(a.id)<0&&e[a.subj].push(a.id):e[a.subj]=[a.id],e[a.obj]?e[a.obj].indexOf(a.id)<0&&e[a.obj].push(a.id):e[a.obj]=[a.id]}),void 0)};f(b),p.history.init(),r.renderAnnotation(),v.showTarget(m)},getAnnotationFromServer:function(a){m=a,f.startWait(),b.ajaxAccessor.getAsync(a,u.loadAnnotation,function(){f.endWait()})},saveAnnotation:function(){p.history.saved()},saveAnnotationToServer:function(a){f.startWait();var c=l.annotationData.toJason();b.ajaxAccessor.post(a,c,v.showSaveSuccess,v.showSaveError,function(){f.endWait()})},undo:function(){var a=function(a){var b=Object.create(a);switch(a.action){case"new_span":b.action="remove_span";break;case"remove_span":b.action="new_span";break;case"new_denotation":b.action="remove_denotation";break;case"remove_denotation":b.action="new_denotation";break;case"change_entity_type":b.old_type=a.new_type,b.new_type=a.old_type;break;case"new_relation":b.action="remove_relation";break;case"remove_relation":b.action="new_relation";break;case"change_relation_subj":b.old_subj=a.new_subj,b.new_subj=a.old_subj;break;case"change_relation_obj":b.old_obj=a.new_obj,b.new_obj=a.old_obj;break;case"change_relation_pred":b.old_pred=a.new_pred,b.new_pred=a.old_pred}return b},b=function(b){return b=Object.create(b),b.reverse(),b.map(a)};t.unselect(),r.relations.clearRelationSelection(),p.execute(b(p.history.prev()),"undo")},redo:function(){return t.unselect(),r.relations.clearRelationSelection(),p.execute(p.history.next(),"redo"),!1},replicate:function(){1==t.span.getNumberOfSelected()?p.execute(p.getReplicateSpanCommands(l.annotationData.spans[t.span.getSelectedId()])):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=[];t.span.getSelecteds().each(function(){var b=this.id;a.push({action:"new_denotation",span:b,type:l.entityTypes.getDefaultType()})}),p.execute(a)},newLabel:function(){var a=t.entity.getSelecteds();if(a.length>0){var b=prompt("Please enter a new label",""),c=[];a.each(function(){var a=this.title;console.log(a),c.push({action:"change_entity_type",id:a,old_type:l.annotationData.entities[a].type,new_type:b})}),p.execute(c)}},removeSelectedElements:function(){var a=[];t.span.getSelecteds().each(function(){var b=this.id;a.push({action:"remove_span",id:b});for(var e in c[b]){var f=c[b][e];for(var g in d[f]){var h=d[f][g];t.entity.select(h)}}});var b=[];t.entity.getSelecteds().each(function(){var a=this.title;b.push({action:"remove_denotation",id:a,span:l.annotationData.entities[a].span,type:l.annotationData.entities[a].type});for(var c in e[a]){var d=e[a][c];r.relations.selectRelation(d)}});for(var f=[];r.relations.relationIdsSelected.length>0;)rid=r.relations.relationIdsSelected.pop(),f.push({action:"remove_relation",id:rid,subj:l.annotationData.relations[rid].subj,obj:l.annotationData.relations[rid].obj,pred:l.annotationData.relations[rid].pred});
var g=[].concat(f,b,a);p.execute(g)},copyEntities:function(){i.length=0,t.entity.getSelecteds().each(function(){i.push(this.title)})},pasteEntities:function(){var a=[];t.span.getSelecteds().each(function(){var b=this.id;a=a.concat(i.map(function(a){return{action:"new_denotation",span:b,type:l.annotationData.entities[a].type}}))}),p.execute(a)},setEntityTypeDefault:function(){return l.entityTypes.setDefaultType($(this).attr("label")),!1},setEntityType:function(){var a=$(this).attr("label"),b=[];return t.entity.getSelecteds().each(function(){var c=this.title;b.push({action:"change_entity_type",id:c,old_type:l.annotationData.entities[c].type,new_type:a})}),p.execute(b),!1}},v=function(a){var b=function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea};return{showTarget:function(a){if(""!==a){var c=a.replace(/\/annotations\.json$/,"");b().html("(Target: <a href='"+c+"'>"+c+"</a>)")}},showSaveSuccess:function(){b().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),v.showTarget(m)}),p.history.saved(),f.endWait()},showSaveError:function(){b.html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),v.showTarget(m)}),f.endWait()},showPallet:function(a){var b=function(){return l.entityTypes.getSortedNames().map(function(a){var b=l.entityTypes.getType(a),c='<tr class="textae-editor__entity-pallet__entity-type" style="background-color:'+b.getColor()+'">';c+='<th><input type="radio" name="etype" class="textae-editor__entity-pallet__entity-type__radio" label="'+a+'"',c+=a==l.entityTypes.getDefaultType()?' title="default type" checked':"",c+="/></th>",c+='<td class="textae-editor__entity-pallet__entity-type__label" label="'+a+'">'+a+"</td>",c+='<th title="'+d+'">';var d=b.uri;return d&&(c+='<a href="'+d+'" target="_blank"><img src="images/link.png"/></a>'),c+="</th>",c+="</tr>"}).join()},c=function(){var a=$(".textae-editor__entity-pallet");return 0===a.length?(a=$("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css({position:"fixed",display:"none"}).on("mouseup",".textae-edtior__entity-pallet__entity-type__radio",u.setEntityTypeDefault).on("mouseup",".textae-edtior__entity-pallet__entity-type__label",u.setEntityType),$("body").append(a)):(a.find("table").empty(),a.css("width","auto")),a},d=c();d.find("table").append(b(l.entityTypes)),d.outerHeight()>n.PALLET_HEIGHT_MAX&&(d.css("height",n.PALLET_HEIGHT_MAX),d.css("width",d.outerWidth()+15)),1===arguments.length?(d.css("top",a.top),d.css("left",a.left)):(d.css("top",10),d.css("left",20)),d.css("display","block")},hidePallet:function(){$(".textae-editor__entity-pallet").css("display","none")},redraw:function(){var a=function(a){var b="G"+a,c=$("#"+b);if(c.length>0){spanPosition=r.positions.span[a],gridPosition=r.positions.grid[b];var d=spanPosition.top-gridPosition.offset-gridPosition.height;c.css("top",d),gridPosition.top=d;var e=spanPosition.left;c.css("left",e),gridPosition.left=e}};l.annotationData.spanIds.forEach(function(b){r.positions.indexPositionSpan(b),a(b)}),Object.keys(l.annotationData.entities).forEach(function(a){r.positions.indexPositionEntity(a)}),r.relations.renewConnections()},cancelSelect:function(){return window.getSelection().isCollapsed?(t.unselect(),r.relations.clearRelationSelection(),v.hidePallet(),h.buttonState.updateAll(),a.tool.cancelSelect(),void 0):(v.dismissBrowserSelection(),!0)},dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}}}(this),w={createEntity:u.createEntity,removeSelectedElements:u.removeSelectedElements,copyEntities:u.copyEntities,pasteEntities:u.pasteEntities,replicate:u.replicate,showPallet:v.showPallet,showAccess:function(){g.showAccess(m)},showSave:function(){g.showSave(m,l.annotationData.toJason())},newLabel:u.newLabel,redo:function(){p.history.hasAnythingToRedo()&&u.redo()},undo:function(){p.history.hasAnythingToUndo()&&u.undo()},selectLeftEntity:function(){if(1==t.span.getNumberOfSelected()){var a=l.annotationData.spanIds.indexOf(t.span.popSelectedId());t.unselect(),a--,0>a&&(a=l.annotationData.spanIds.length-1),t.span.select(l.annotationData.spanIds[a])}},selectRightEntity:function(){if(1==t.span.getNumberOfSelected()){var a=l.annotationData.spanIds.indexOf(t.span.popSelectedId());t.unselect(),a++,a>l.annotationData.spanIds.length-1&&(a=0),t.span.select(l.annotationData.spanIds[a])}},start:function(){o()},handleKeyInput:function(a){var b={A:w.showAccess,C:w.copyEntities,D:w.removeSelectedElements,DEL:w.removeSelectedElements,E:w.createEntity,Q:w.showPallet,R:w.replicate,S:w.showSave,V:w.pasteEntities,W:w.newLabel,X:w.redo,Y:w.redo,Z:w.undo,ESC:v.cancelSelect,LEFT:w.selectLeftEntity,RIGHT:w.selectRightEntity};b[a]&&b[a]()},handleButtonClick:function(a){var b={"textae.control.button.read.click":w.showAccess,"textae.control.button.write.click":w.showSave,"textae.control.button.undo.click":w.undo,"textae.control.button.redo.click":w.redo,"textae.control.button.replicate.click":w.replicate,"textae.control.button.replicate_auto.click":h.toggleReplicateAuto,"textae.control.button.entity.click":w.createEntity,"textae.control.button.new_label.click":w.newLabel,"textae.control.button.pallet.click":function(){w.showPallet(a.point)},"textae.control.button.delete.click":w.removeSelectedElements,"textae.control.button.copy.click":w.copyEntities,"textae.control.button.paste.click":w.pasteEntities};b[a.name]()},redraw:v.redraw};return this.api=w,this},d=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b={},c=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},d=function(){var a=function(){return $("<span>").addClass("textae-control__separator")},c=function(a,c){var d=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",c);return b[a]={obj:d,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},d};return $($("<span>").append(a()).append(c("read","Access [A]")).append(c("write","Save [S]")).append(a()).append(c("undo","Undo [Z]")).append(c("redo","Redo [X]")).append(a()).append(c("replicate","Replicate span annotation [R]")).append(c("replicate-auto","Auto replicate (Toggle)")).append(a()).append(c("entity","New entity [E]")).append(c("pallet","Select label [Q]")).append(c("new-label","Enter label [W]")).append(a()).append(c("delete","Delete [D]")).append(c("copy","Copy [C]")).append(c("paste","Paste [V]")).append(a()).append(c("help","Help [H]")).append(c("about","About")).append(a()))},e=function(c,d){return function(e,f){var g=b[e],h=function(a){d.buttonClick({name:g.eventName,point:{top:a.clientY-d.get(0).offsetTop,left:a.clientX-d.get(0).offsetLeft}})};g&&(f?(g.obj.off(c).on(c,h),a.enable(g.obj)):(g.obj.off(c),a.disable(g.obj)))}}("click",this),f=function(a){for(var c in b)e(c,!a.hasOwnProperty(c))},g=function(c){c?a.push(b["replicate-auto"].obj):a.unpush(b["replicate-auto"].obj)};return this.append(c()).append(d()),e("read",!0),e("replicateAuto",!0),e("help",!0),e("about",!0),this.updateAllButtonEnableState=f,this.updateReplicateAutoButtonPushState=g,this},e=function(){{var a={control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoDialogs:{help:b.makeInformationDialog({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<img>").attr("src","images/keyhelp.png"))}}),about:b.makeInformationDialog({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")}}),hideAll:function(){a.infoDialogs.help.hide(),a.infoDialogs.about.hide()}}},c={handleKeyInput:function(b){"H"===b?a.infoDialogs.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(b),"ESC"===b&&a.infoDialogs.hideAll())},handleButtonClick:function(b){switch(b.name){case"textae.control.button.help.click":a.infoDialogs.help.show();break;case"textae.control.button.about.click":a.infoDialogs.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(b)}},handleEditor:{select:function(b){a.editors.select(b)},cancel:function(){a.infoDialogs.hideAll()},changeButtonState:function(b){a.control.updateAllButtonEnableState(b)},pushReplicateAuto:function(b){a.control.updateReplicateAutoButtonPushState(b)}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},d=!0,e=function(a){d&&c.handleKeyInput(b(a.keyCode))};$(document).on("keyup",e),$("body").on("dialogopen",".ui-dialog",function(){d=!1}).on("dialogclose",".ui-dialog",function(){d=!0})},d=function(){$(window).on("resize",function(){a.editors.forEach(function(a){a.api.redraw()})})};$(function(){b(),d()})}()}return{setControl:function(b){$.extend(b,{buttonClick:function(a){c.handleButtonClick(a)}}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:{selectMe:c.handleEditor.select.bind(this,b),cancelSelect:c.handleEditor.cancel,changeButtonState:c.handleEditor.changeButtonState,pushReplicateAuto:c.handleEditor.pushReplicateAuto}})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return e.pushEditor(a),c.apply(a),a.api.start(),a}),e.selectFirstEditor();else if(this.hasClass("textae-control")){var a=d.apply(this);return e.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);