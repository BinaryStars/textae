/*! textae 4.0.1 05-03-2014 */
!function(a){var b={ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||$.ajax({type:"post",url:b,contentType:"application/json",data:{annotations:c}}).done(d).fail(e).always(f)}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(a){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}}),a&&this.find('[type="text"]').val(a)},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}()},c=function(){var a={cursorChanger:function(a){var b=function(){a.css("cursor","wait")},c=function(){a.css("cursor","auto")};return{startWait:b,endWait:c}}(this),selector:{getSelecteds:function(){return $(".ui-selected")},hasSelecteds:function(){return a.selector.getSelecteds().length>0},span:{get:function(a){return $("#"+a)},getSelecteds:function(){return $(".textae-editor__span.ui-selected")},getNumberOfSelected:function(){return a.selector.span.getSelecteds().length},hasSelecteds:function(){return a.selector.span.getNumberOfSelected()>0},getSelectedId:function(){return a.selector.span.getSelecteds().attr("id")},popSelectedId:function(){var b=a.selector.span.getSelecteds();return 1===b.length?(b.removeClass("ui-selected"),b.attr("id")):null},select:function(b){a.manipulate.select(a.selector.span.get(b))}},entity:{get:function(a){return $("#"+e.makeEntityDomId(a))},getSelecteds:function(){return $(".textae-editor__entity.ui-selected")},getNumberOfSelected:function(){return a.selector.entity.getSelecteds().length},hasSelecteds:function(){return a.selector.entity.getNumberOfSelected()>0},getSelectedId:function(){return a.selector.entity.getSelecteds().attr("title")},select:function(b){a.manipulate.select(a.selector.entity.get(b))}},grid:{get:function(a){return $("#G"+a)}}},manipulate:function(){var b=function(a){return $(a).hasClass("ui-selected")},c=function(){b(this)||$(this).addClass("ui-selected").trigger("selectChanged",!0)},d=function(){b(this)&&$(this).removeClass("ui-selected").trigger("selectChanged",!1)},e=function(){b(this)?d.apply(this):c.apply(this)},f=function(){var a=$(this);d.call(a.add(a.find(".ui-selected"))),a.remove()},h=function(a,b){return $(b).each(a)};return{select:h.bind(null,c),deselect:h.bind(null,d),toggle:h.bind(null,e),remove:h.bind(null,f),selectOnly:function(b){a.manipulate.deselect(a.selector.getSelecteds().not(b)),g.renderer.relation.clearRelationSelection(),a.manipulate.select(b)},unselect:function(){a.manipulate.deselect(a.selector.getSelecteds()),g.renderer.relation.clearRelationSelection()},dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}}}()},c={BLOCK_THRESHOLD:100},d=function(c){var e=function(){var a=function(){var a=$("<div>").append('<div>Sever :<input type="text" class="textae-editor__load-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div>Local :<input type="file"　/></div>').on("change",'[type="file"]',function(){d.getAnnotationFromFile(this),a.dialogClose()}).on("click",'[type="button"]',function(){var b=a.find(".textae-editor__load-dialog__file-name").val();d.getAnnotationFromServer(b),a.dialogClose()});return b.getDialog(c.editorId,"textae.dialog.load","Load document with annotation.",a)},e=function(){var a=$("<div>").append('<div>Sever :<input type="text" class="textae-editor__save-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div>Local :<span class="span_link_place"><a target="_blank"/></span></div>').on("click","a",function(){h.command.updateSavePoint(),a.dialogClose()}).on("click",'[type="button"]',function(){var b=a.find(".textae-editor__save-dialog__file-name").val();d.saveAnnotationToServer(b),a.dialogClose()});return b.getDialog(c.editorId,"textae.dialog.save","Save document with annotation.",a)};return{showLoad:function(b){a().open(b)},showSave:function(b,c){var d=function(b,c){{var d=a().find("input[type='file']"),e=d.prop("files")[0],f=e?e.name:"annotations.json";b.find("a").text(f).attr("href",c).attr("download",f)}},f=e();d(f,c),f.open(b)}}}(),g=function(){if($messageArea=c.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var a=$("<div>").addClass("textae-editor__footer").append($messageArea);c.append(a)}return $messageArea},i=function(){g().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),k(l)}),h.command.updateSavePoint(),a.cursorChanger.endWait()},j=function(){g.html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),k(l)}),a.cursorChanger.endWait()},k=function(a){if(""!==a){var b=a.replace(/\/annotations\.json$/,"");g().html("(Target: <a href='"+b+"'>"+b+"</a>)"),l=a}},l="";return{getAnnotationFromServer:function(c){a.cursorChanger.startWait(),b.ajaxAccessor.getAsync(c,function(a){h.command.reset(a),k(c)},function(){a.cursorChanger.endWait()})},getAnnotationFromFile:function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);h.command.reset(a)},b.readAsText(a.files[0])},saveAnnotationToServer:function(c){a.cursorChanger.startWait();var d=f.annotationData.toJason();b.ajaxAccessor.post(c,d,i,j,function(){a.cursorChanger.endWait()}),h.command.updateSavePoint()},showAccess:function(){e.showLoad(l)},showSave:function(){var a=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)};e.showSave(l,a(f.annotationData.toJason()))}}}(this),e=function(a){return{makeParagraphId:function(b){return a.editorId+"__P"+b},makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:c[0],end:c[1]}},makeTypeId:function(a,b){return a+"-"+b},makeEntityDomId:function(b){return a.editorId+"__E"+b}}}(this),f=function(a){var c={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf(a)>=0}};return{init:function(){var c=function(a){f.annotationData.entityTypeContainer.set(a["entity types"]),f.setRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};f.spanConfig.set();var e=$.extend(b.getUrlParameters(location.search),{debug:a.attr("debug"),config:a.attr("config"),target:a.attr("target")});if(e.config&&""!==e.config){var g=b.ajaxAccessor.getSync(e.config);null!==g?(f.spanConfig.set(g),c(g)):alert("could not read the span configuration from the location you specified.")}e.target&&""!==e.target&&d.getAnnotationFromServer(e.target)},spanConfig:c,annotationData:function(){var a,b,c,d=null,g=function(){var a=f.annotationData.getAllSpan().sort(function(a,b){return a.begin-b.begin||b.end-a.end}),b=[];a.forEach(function(a,c,d){$.extend(a,{children:[],left:0!==c?d[c-1]:null,right:c!==d.length-1?d[c+1]:null});var e=b[b.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(e)?(e.children.push(a),a.parent=e):b.push(a)}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},d=a.map(function(a){return a.id}),f.annotationData.spansTopLevel=b},h=function(){var a=Object.keys(f.annotationData.entities).filter(function(a){return"E"===a[0]}).map(function(a){return a.slice(1)});return a.sort(function(a,b){return b-a}),parseInt(a[0])||0},i=function(a){var d={types:{},isChildOf:function(b){return b&&b.begin<=a.begin&&a.end<=b.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+f.annotationData.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=f.annotationData.spansTopLevel.indexOf(this),0===a||f.annotationData.spansTopLevel[a-1].paragraph!==this.paragraph?null:f.annotationData.spansTopLevel[a-1])},getTypes:function(){return $.map(this.types,function(a,b){return{id:b,name:a,entities:Object.keys(c[b])}})}},g=function(a){var b=f.annotationData.paragraphsArray.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return b.length>0?b[0]:null},h=e.makeSpanId(a.begin,a.end);f.annotationData.getSpan(h)||(b[h]=$.extend({id:h,paragraph:g(a)},a,d))};return{sourceDoc:"",entities:null,relations:null,reset:function(d){b={},f.annotationData.entities={},f.annotationData.relations={},a=d,function(a){if(void 0===a)return alert("read failed."),void 0;f.annotationData.sourceDoc=a;var b=[],c=0;a.split("\n").forEach(function(a,d){b.push({id:e.makeParagraphId(d),begin:c,end:c+a.length}),c+=a.length+1}),f.annotationData.paragraphsArray=b}(d.base_text),function(a){a&&(c={},a.forEach(function(a){i(a.span),f.annotationData.addEntity({id:a.id,span:e.makeSpanId(a.span.begin,a.span.end),type:a.obj}),f.annotationData.entityTypeContainer.incrementNumberOfTypes(a.obj)}),g())}(d.denotations)},addSpan:function(a){i(a),g()},removeSpan:function(a){delete b[a],g()},getSpan:function(a){return b[a]},getRangeOfSpan:function(a,b){var c=d.indexOf(a),e=d.indexOf(b);if(c>e){var f=c;c=e,e=f}return d.slice(c,e+1)},getAllSpan:function(){return $.map(b,function(a){return a})},addEntity:function(a){var b=function(a){var b=function(a,b){c[a]||(c[a]={}),c[a][b]=null},d=e.makeTypeId(a.span,a.type);f.annotationData.getSpan(a.span).types[d]=a.type,b(d,a.id)};f.annotationData.entities[a.id]=a,b(a)},removeEnitity:function(a){var b=function(a,b,d){"use strict";var g=e.makeTypeId(a,b);delete c[g][d],0===Object.keys(c[g]).length&&(delete c[g],delete f.annotationData.getSpan(a).types[g])},d=f.annotationData.entities[a];return d&&(b(d.span,d.type,a),delete f.annotationData.entities[a]),d},parseRelations:function(a){a&&a.forEach(function(a){f.annotationData.relations[a.id]=a})},getRelationIds:function(){return Object.keys(f.annotationData.relations)},getNewEntityId:function(){return"E"+(h()+1)},toJason:function(){var b=[];for(var c in f.annotationData.entities){var d=f.annotationData.entities[c].span,e={begin:f.annotationData.getSpan(d).begin,end:f.annotationData.getSpan(d).end};b.push({id:c,span:e,obj:f.annotationData.entities[c].type})}return JSON.stringify($.extend(a,{denotations:b}))},entityTypeContainer:function(){var a={},b="",c=function(){return this.color?this.color:"#77DDDD"};return{setDefaultType:function(a){b=a},getDefaultType:function(){return console.log("aa",b),b||this.getSortedNames()[0]},getType:function(b){return a[b]=a[b]||{getColor:c},a[b]},set:function(d){a={},b="",void 0!==d&&d.forEach(function(d){d.getColor=c,a[d.name]=d,d["default"]===!0&&(b=d.name)})},incrementNumberOfTypes:function(a){var b=this.getType(a);b.count=(b.count||0)+1},getSortedNames:function(){var b=Object.keys(a);return b.sort(function(b,c){return a[c].count-a[b].count}),b}}}()}}(),relationTypes:{},relationTypeDefault:"",setRelationTypes:function(a){void 0!==a&&(f.relationTypes={},f.relationTypeDefault=null,a.forEach(function(a){f.relationTypes[a.name]=a,a["default"]===!0&&(f.relationTypeDefault=a.name)}),f.relationTypeDefault||(f.relationTypeDefault=a[0].name))},relationsPerEntity:{},initRelationsPerEntity:function(a){void 0!==a&&(f.relationsPerEntity={},a.forEach(function(a){f.relationTypes[a.pred]||(f.relationTypes[a.pred]={}),f.relationTypes[a.pred].count?f.relationTypes[a.pred].count++:f.relationTypes[a.pred].count=1,f.relationsPerEntity[a.subj]?f.relationsPerEntity[a.subj].indexOf(a.id)<0&&f.relationsPerEntity[a.subj].push(a.id):f.relationsPerEntity[a.subj]=[a.id],f.relationsPerEntity[a.obj]?f.relationsPerEntity[a.obj].indexOf(a.id)<0&&f.relationsPerEntity[a.obj].push(a.id):f.relationsPerEntity[a.obj]=[a.id]}))},connectorTypes:{},initConnectorTypes:function(){var a=function(a){return f.relationTypes[a]&&f.relationTypes[a].color?f.relationTypes[a].color:"#555555"},b=function(a,b){var c=a.slice(1),d=c.substr(0,2),e=c.substr(2,2),f=c.substr(4,2);return d=parseInt(d,16),e=parseInt(e,16),f=parseInt(f,16),"rgba("+d+", "+e+", "+f+", "+b+")"};f.connectorTypes={};for(var c in f.relationTypes){var d=a(c),e=b(d,g.renderer.relation.settings.connOpacity),h=b(d,1);f.connectorTypes[c]={paintStyle:{strokeStyle:e,lineWidth:1},hoverPaintStyle:{strokeStyle:h,lineWidth:3}},f.connectorTypes[c+"_selected"]={paintStyle:{strokeStyle:h,lineWidth:3},hoverPaintStyle:{strokeStyle:h,lineWidth:3}}}},getReplicationSpans:function(a){var b=function(a){for(var b=String.prototype.indexOf.bind(f.annotationData.sourceDoc,f.annotationData.sourceDoc.substring(a.begin,a.end)),c=a.end-a.begin,d=[],e=0,g=b(e);-1!==g;g=b(e))d.push({begin:g,end:g+c}),e=g+c;return d},c=function(b){return b.begin===a.begin},d=function(a){var b=f.annotationData.sourceDoc.charAt(a.begin-1),c=f.annotationData.sourceDoc.charAt(a.end);return f.spanConfig.isDelimiter(b)&&f.spanConfig.isDelimiter(c)},e=function(a){return f.annotationData.getAllSpan().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0},g=function(a){return f.annotationData.getAllSpan().filter(function(b){return b.begin<a.begin&&a.begin<b.end&&b.end<a.end||a.begin<b.begin&&b.begin<a.end&&a.end<b.end}).length>0};return b(a).filter(function(a){return!c(a)&&d(a)&&!e(a)&&!g(a)})},reset:function(a){var b=function(a){f.annotationData.parseRelations(a.relations),f.initRelationsPerEntity(a.relations),f.initConnectorTypes()};f.annotationData.reset(a),b(a)}}}(this),g=function(b){var c=18,d=2,h=function(){return{clipBoard:[],isReplicateAuto:!1,buttonStateHelper:function(){var c={},d=function(a,b){b?delete c[a]:c[a]=!1},e=function(){d("entity",a.selector.span.getNumberOfSelected()>0)},f=function(){d("paste",g.viewModel.clipBoard.length>0&&a.selector.span.getNumberOfSelected()>0)},h=function(){d("replicate",1==a.selector.span.getNumberOfSelected())},i=function(){d("pallet",a.selector.entity.getNumberOfSelected()>0)},j=function(){d("change-label",a.selector.entity.getNumberOfSelected()>0)},k=function(){d("delete",a.selector.hasSelecteds())},l=function(){d("copy",a.selector.span.hasSelecteds()||a.selector.entity.hasSelecteds())},m=function(){k(),l()};return{init:function(){m(),e(),f(),h(),i(),j(),this.renderEnable()},pushed:function(a,c){b.tool.pushReplicateAuto(c)},renderEnable:function(){b.tool.changeButtonState(c)},enabled:function(a,b){d(a,b),this.renderEnable()},updateBySpan:function(){m(),e(),f(),h(),this.renderEnable()},updateByEntity:function(){m(),i(),j(),this.renderEnable()}}}(),toggleReplicateAuto:function(){g.viewModel.isReplicateAuto=!g.viewModel.isReplicateAuto,g.viewModel.buttonStateHelper.pushed("replicate-auto",g.viewModel.isReplicateAuto)},viewMode:function(){var a;return{get:function(){return a},set:function(){var h=function(){this.css({visibility:"visible"})},i=function(){this.css({visibility:"hidden"})},j=function(a){var c=function(){var a=d;return function(){h.apply(b.find(".textae-editor__entity-pane")),b.find(".textae-editor__type_term-centric-mode").removeClass("textae-editor__type_term-centric-mode").addClass("textae-editor__type"),d=a}}(),e=function(){i.apply(b.find(".textae-editor__entity-pane")),b.find(".textae-editor__type").removeClass("textae-editor__type").addClass("textae-editor__type_term-centric-mode"),d=0},f=function(a){$.map(g.renderer.relation.cachedConnectors,function(a){return a}).forEach(function(b){b.setConnectorVisible(a)})};"TERM"===a?(e(),f(!1)):"INSTANCE"===a&&(c(),f(!0))},k=function(a){var b=function(a,b,g,h){var i=e.makeTypeId(g,h),j=$("<div>").attr("id","P-"+i).addClass("textae-editor__entity-pane");a.apply(j);var k=$("<div>").addClass("textae-editor__type-label").text(h).css({"background-color":f.annotationData.entityTypeContainer.getType(h).getColor()});return $("<div>").attr("id",i).addClass(b).css({"padding-top":c,"margin-bottom":d}).append(k).append(j)};"TERM"===a?(g.renderer.helper.redraw=g.renderer.grid.arrangePositionAll,g.renderer.entity.createEmptyTypeDomElement=b.bind(null,i,"textae-editor__type_term-centric-mode"),g.renderer.relation.render=function(a){g.renderer.relation.renderRelation(a).setConnectorVisible(!1)}):"INSTANCE"===a&&(g.renderer.helper.redraw=function(){g.renderer.grid.arrangePositionAll(),g.renderer.relation.arrangePositionAll()},g.renderer.entity.createEmptyTypeDomElement=b.bind(null,h,"textae-editor__type"),g.renderer.relation.render=g.renderer.relation.renderRelation)};return function(b){a=b,j(b),k(b)}}()}}()}}(),i=function(){var c=function(b){a.manipulate.remove(a.selector.grid.get(b))},h={getSpan:function(b){var c=a.selector.span.get(b);if(0===c.length)throw new Error("span is not renderd : "+b);return{top:c.get(0).offsetTop,left:c.get(0).offsetLeft,width:c.outerWidth(),height:c.outerHeight(),center:c.get(0).offsetLeft+c.outerWidth()/2}},getGrid:function(b){var c=a.selector.grid.get(b),d=c.get(0);return d?{top:d.offsetTop,left:d.offsetLeft,height:c.outerHeight()}:{top:0,left:0,height:0}},getEntity:function(b){var c=f.annotationData.entities[b].span,d=a.selector.entity.get(b);if(0===d.length)throw new Error("entity is not rendered : "+b);var e=h.getGrid(c),g=d.get(0);return{top:e.top+g.offsetTop,center:e.left+g.offsetLeft+d.outerWidth()/2}}},i=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},j=i(b,"div","textae-editor__body"),k=function(){return i(j,"div","textae-editor__body__annotation-box")};return{reset:function(){var a=function(){return f.annotationData.sourceDoc.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph">'+a+"</p>"}).join("\n")},b=function(){var a={};return g.renderer.helper.getSourceDocArea().find("p").each(function(b,c){var d=$(c),e=$.extend(f.annotationData.paragraphsArray[b],{element:d});d.attr("id",e.id),a[e.id]=e}),a};g.renderer.helper.getSourceDocArea().html(a()),g.renderer.paragraphs=b(),k().empty(),g.renderer.helper.renderAllSpan(),g.renderer.helper.renderAllRelation()},helper:function(){return{getSourceDocArea:function(){return i(j,"span","textae-editor__body__text-box")},renderAllSpan:function(){f.annotationData.spansTopLevel.forEach(function(a){g.renderer.span.render(a.id)})},renderAllRelation:function(){g.renderer.relation.reset(),f.annotationData.getRelationIds().forEach(function(a){g.renderer.relation.render(a)})},changeLineHeight:function(a){b.find(".textae-editor__body__text-box").css({"line-height":100*a+"%"})}}}(),span:{render:function(b){var c=function(b){var c=function(a,c){var d=b.begin-c,e=b.end-c;if(0>d||a.length<e)throw new Error("oh my god! I cannot render this span. "+b.toStringOnlyThis()+", textNode "+a.textContent);var f=document.createRange();return f.setStart(a,d),f.setEnd(a,e),f},d=function(){var d=function(a){var b=g.renderer.paragraphs[a.paragraph.id];return textNodeInParagraph=b.element.contents().filter(function(){return 3===this.nodeType}).get(0),c(textNodeInParagraph,b.begin)},e=b.getBigBrother();if(e)return c(document.getElementById(e.id).nextSibling,e.end);if(b.parent){var f=a.selector.span.get(b.parent.id).contents().filter(function(){return 3===this.nodeType}).get(0);return c(f,b.parent.begin)}return d(b)},e=document.createElement("span");e.setAttribute("id",b.id),e.setAttribute("title",b.id),e.setAttribute("class","textae-editor__span"),d(b.id).surroundContents(e)},d=function(a){a.getTypes().forEach(function(a){a.entities.forEach(function(a){g.renderer.entity.render(f.annotationData.entities[a])})})},e=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),g.renderer.span.destroy(a.id)};a.children.filter(function(a){return null!==document.getElementById(a.id)}).forEach(function(a){b(a)})},h=f.annotationData.getSpan(b);e(h),c(h),d(h),h.children.filter(function(a){return null===document.getElementById(a.id)}).forEach(function(a){g.renderer.span.render(a.id)}),g.renderer.grid.arrangePosition(h)},destroy:function(b){for(var d=document.getElementById(b),e=d.parentNode;d.firstChild;)e.insertBefore(d.firstChild,d);a.manipulate.remove(d),e.normalize(),c(b)}},entity:function(){var b=function(a,b){return $("#"+e.makeTypeId(a,b))},d=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},i=function(c){var e=function(a){return 0===f.annotationData.getSpan(c.span).getTypes().filter(function(b){return b.name===a}).length},g=a.manipulate.remove(a.selector.entity.get(c.id)).attr("type");e(g)?b(c.span,g).remove():d(b(c.span,g).find(".textae-editor__entity-pane"))};return{render:function(c){var i=function(c,d){var e=function(b){var c=function(a){var b=h.getSpan(a),c=$("<div>").attr("id","G"+a).addClass("textae-editor__grid").css({width:b.width});return k().append(c),c},d=a.selector.grid.get(b);return 0===d.length?c(b):d},f=b(c,d);return 0===f.length&&(f=g.renderer.entity.createEmptyTypeDomElement(c,d),e(c).append(f)),f},j=function(a){return $("<div>").attr("id",e.makeEntityDomId(a.id)).attr("title",a.id).attr("type",String(a.type)).addClass("textae-editor__entity").css({"border-color":f.annotationData.entityTypeContainer.getType(a.type).getColor()})},l=i(c.span,c.type).find(".textae-editor__entity-pane").append(j(c));d(l)},destroy:function(a){var b=function(a){return 0===f.annotationData.getSpan(a).getTypes().length};b(a.span)?c(a.span):i(a)},changeTypeOfExists:function(a){i(a),g.renderer.entity.render(a)}}}(),grid:{arrangePosition:function(b){var c=function(b){var c=b.id,e=h.getSpan(c),f=h.getGrid(c);a.selector.grid.get(c).css({top:e.top-d-f.height,left:e.left})},e=function(b){var c=function(a){var b=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return c(a)})),e=h.getGrid(a.id).height+b+d;return e};if(b.getTypes().length>0&&b.children.length>0){var e=h.getSpan(b.id),f=c(b);a.selector.grid.get(b.id).css({top:e.top-d-f})}};c(b),e(b)},arrangePositionAll:function(){var a=function(b){b.children.forEach(function(b){a(b)}),g.renderer.grid.arrangePosition(b)};f.annotationData.spansTopLevel.filter(function(a){return a.getTypes().length>0}).forEach(function(b){a(b)})}},relation:function(){var c=function(){var a=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return a.setRenderMode(a.SVG),a.Defaults.Container=k(),a}(),d=function(a,b){var c=h.getEntity(a),d=h.getEntity(b),e=c.center,f=d.center,i=c.top,j=d.top,k=Math.abs(e-f),l=Math.abs(i-j),m=k*g.renderer.relation.settings.xrate+l*g.renderer.relation.settings.yrate+g.renderer.relation.settings.c_offset;return m/=2.4},e=function(a){this.endpoints.forEach(function(b){b.setVisible(a)}),this.setVisible(a)};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},cachedConnectors:{},reset:function(){c.reset(),g.renderer.relation.cachedConnectors={},g.renderer.relation.relationIdsSelected=[]},renderRelation:function(h){var i,j,k,l=f.annotationData.relations[h].subj,m=f.annotationData.relations[h].obj;l==m?(i=[.5,0,-1,-1],j=[.5,0,1,-1],k=30):(i="TopCenter",j="TopCenter",k=d(l,m));var n=f.annotationData.relations[h].pred,o=c.connect({source:a.selector.entity.get(l),target:a.selector.entity.get(m),anchors:[i,j],connector:["Bezier",{curviness:k}],paintStyle:f.connectorTypes[n].paintStyle,hoverPaintStyle:f.connectorTypes[n].hoverPaintStyle,parameters:{id:h},cssClass:"textae-editor__relation",overlays:[["Arrow",{width:10,length:12,location:1}],["Label",{label:"["+h+"] "+n,cssClass:"textae-editor__relation__label"}]]});return b.trigger("textae.editor.jsPlumbConnection.add",o),$.extend(o,{setConnectorVisible:e}),g.renderer.relation.cachedConnectors[h]=o,o},destroy:function(a){var b=g.renderer.relation.cachedConnectors[a];c.detach(b)},arrangePosition:function(a){var b=f.annotationData.relations[a].subj,c=f.annotationData.relations[a].obj,e=d(b,c);b==c&&(e=30);var h=g.renderer.relation.cachedConnectors[a];h.endpoints[0].repaint(),h.endpoints[1].repaint(),h.setConnector(["Bezier",{curviness:e}]),h.addOverlay(["Arrow",{width:10,length:12,location:1}])},arrangePositionAll:function(){f.annotationData.getRelationIds().forEach(function(a){g.renderer.relation.arrangePosition(a)})},isRelationSelected:function(a){return g.renderer.relation.relationIdsSelected.indexOf(a)>-1},selectRelation:function(a){g.renderer.relation.isRelationSelected(a)||(g.renderer.relation.cachedConnectors[a].setPaintStyle(f.connectorTypes[f.annotationData.relations[a].pred+"_selected"].paintStyle),g.renderer.relation.relationIdsSelected.push(a))},deselectRelation:function(a){var b=g.renderer.relation.relationIdsSelected.indexOf(a);b>-1&&(g.renderer.relation.cachedConnectors[a].setPaintStyle(f.connectorTypes[f.annotationData.relations[a].pred].paintStyle),g.renderer.relation.relationIdsSelected.splice(b,1))},clearRelationSelection:function(){for(;g.renderer.relation.relationIdsSelected.length>0;){var a=g.renderer.relation.relationIdsSelected.pop();g.renderer.relation.cachedConnectors[a].setPaintStyle(f.connectorTypes[f.annotationData.relations[a].pred].paintStyle)}}}}()}}();return{init:function(){g.viewModel.buttonStateHelper.init(),g.viewModel.viewMode.set("TERM")},renderer:i,viewModel:h}}(this),h=function(d){var i=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},j=function(b){var d=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=g.renderer.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return console.log(d),void 0;b=f.annotationData.getSpan(d).begin}for(var e=a.parentElement.childNodes,h=0;e[h]!=a;h++)b+="#text"==e[h].nodeName?e[h].nodeValue.length:$("#"+e[h].id).text().length;return b},j=function(a){var b=d(a.focusNode);return b+=a.focusOffset},k=function(a){var b=d(a.anchorNode);return b+a.anchorOffset},l=function(a){for(var b=a;f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b));)b++;for(;!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b))&&b>0&&!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b-1));)b--;return b},m=function(a){for(var b=a;f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b-1));)b--;for(;!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b))&&b<f.annotationData.sourceDoc.length;)b++;return b},n=function(a){for(var b=a;b<f.annotationData.sourceDoc.length&&(f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b))||!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b-1)));)b++;return b},o=function(a){for(var b=a;b>0&&(f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b-1))||!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b)));)b--;return b},p=function(a,b,c){return[h.command.factory.spanMoveCommand(a,b,c)]},q=function(a,b){var c=[],d=j(b),e=b.getRangeAt(0),g=document.createRange();if(g.selectNode(b.anchorNode),e.compareBoundaryPoints(Range.START_TO_START,g)<0){var i=l(d);c=p(a,i,f.annotationData.getSpan(a).end)}else{var k=m(d);c=p(a,f.annotationData.getSpan(a).begin,k)}h.command.invoke(c)},r=function(b,c){var d=[],g=j(c),i=c.getRangeAt(0),k=document.createRange();k.selectNode(c.focusNode);var l,m=function(a){return[h.command.factory.spanRemoveCommand(a)]};if(i.compareBoundaryPoints(Range.START_TO_START,k)>0){var q=o(g);q>f.annotationData.getSpan(b).begin?(l=e.makeSpanId(f.annotationData.getSpan(b).begin,q),d=f.annotationData.getSpan(l)?m(b):p(b,f.annotationData.getSpan(b).begin,q)):(a.selector.span.select(b),h.userEvent.editHandler.removeSelectedElements())}else{var r=n(g);r<f.annotationData.getSpan(b).end?(l=e.makeSpanId(r,f.annotationData.getSpan(b).end),d=f.annotationData.getSpan(l)?m(b):p(b,r,f.annotationData.getSpan(b).end)):(a.selector.span.select(b),h.userEvent.editHandler.removeSelectedElements())}h.command.invoke(d)},s=window.getSelection();if(s&&s.rangeCount>0){var t=s.getRangeAt(0);if(t.startContainer==g.renderer.helper.getSourceDocArea().get(0)||b.shiftKey||s.isCollapsed)return h.userEvent.viewHandler.cancelSelect(),a.manipulate.dismissBrowserSelection(),!0;var u,v=k(s),w=j(s);if(s.anchorNode.parentElement.id===s.focusNode.parentElement.id){if(a.manipulate.unselect(),v>w){var x=v;v=w,w=x}if(0===v&&w==f.annotationData.sourceDoc.length)return!0;var y=l(v),z=m(w);if(u=e.makeSpanId(y,z),!f.annotationData.getSpan(u))if(z-y>c.BLOCK_THRESHOLD)h.command.invoke([h.command.factory.spanCreateCommand({begin:y,end:z})]);else{var A=[h.command.factory.spanCreateCommand({begin:y,end:z})];if(g.viewModel.isReplicateAuto){var B=h.command.factory.spanReplicateCommand({begin:y,end:z});A.push(B)}h.command.invoke(A)}}else s.anchorNode.parentNode.parentNode==s.focusNode.parentNode?(a.manipulate.unselect(),q(s.anchorNode.parentNode.id,s)):s.anchorNode.parentNode==s.focusNode.parentNode.parentNode?(a.manipulate.unselect(),r(s.focusNode.parentNode.id,s)):1==a.selector.span.getNumberOfSelected()?(u=a.selector.span.popSelectedId(),v>f.annotationData.getSpan(u).begin&&v<f.annotationData.getSpan(u).end?a.selector.span.get(u).get(0).parentNode.id==s.focusNode.parentNode.id?q(u,s):(a.selector.span.select(u),alert("A span cannot be expanded to make a boundary crossing.")):w>f.annotationData.getSpan(u).begin&&w<f.annotationData.getSpan(u).end?a.selector.span.get(u).get(0).id==s.focusNode.parentNode.id?r(u,s):(a.selector.span.select(u),alert("A span cannot be shrinked to make a boundary crossing.")):alert("It is ambiguous for which span you want to adjust the boundary. Reselect the span, and try again.")):alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again.")}a.manipulate.dismissBrowserSelection(),i(b)},k=function(b){h.userEvent.viewHandler.hidePallet();{var c=window.getSelection();c.getRangeAt(0)}if(c.isCollapsed)b.ctrlKey?a.manipulate.toggle(b.target):a.manipulate.selectOnly(b.target);else{if(!b.shiftKey||1!=a.selector.span.getNumberOfSelected())return!0;var d=a.selector.span.popSelectedId(),e=$(this).attr("id");a.manipulate.dismissBrowserSelection(),a.manipulate.unselect(),f.annotationData.getRangeOfSpan(d,e).forEach(function(b){a.selector.span.select(b)
})}return!1},l=function(b,c,d){var e=c.add(d);return b?c.hasClass("ui-selected")?a.manipulate.deselect(e):a.manipulate.select(e):a.manipulate.selectOnly(e),!1},m=function(a){var b=$(a.target);return l(a.ctrlKey,b,b.next().children())},n=function(a){var b=$(a.target);return l(a.ctrlKey,b.prev(),b.children())},o=function(b){if(b.ctrlKey)a.manipulate.toggle(b.target);else{var c=$(b.target).parent();1===c.children().length?a.manipulate.selectOnly(c.prev().add(c.children())):a.manipulate.selectOnly(b.target)}return!1},p=function(){g.viewModel.buttonStateHelper.updateBySpan()},q=function(b){var c=$(b.target).parent();c.children().length===c.find(".ui-selected").length?a.manipulate.select(c.prev()):a.manipulate.deselect(c.prev()),g.viewModel.buttonStateHelper.updateByEntity()},r=function(b,c){var d=b.getParameter("id");return a.manipulate.unselect(),g.renderer.relation.isRelationSelected(d)?g.renderer.relation.deselectRelation(d):(c.ctrlKey||g.renderer.relation.clearRelationSelection(),g.renderer.relation.selectRelation(d)),i(c),!1},s=function(){d.tool.selectMe(),g.viewModel.buttonStateHelper.renderEnable()},t=function(){var b=function(){var a,b=-1,c=-1,d=[],e=function(){a&&a()};return{init:function(b){void 0!==b&&(a=b.bind(this))},reset:function(){b=-1,c=-1,d=[],e()},push:function(a){d.splice(c+1,d.length-c,a),c++,e()},next:function(){return c++,e(),d[c]},prev:function(){var a=d[c];return c--,e(),a},saved:function(){b=c,e()},hasAnythingToUndo:function(){return c>-1},hasAnythingToRedo:function(){return c<d.length-1},hasAnythingToSave:function(){return c!=b}}}(),c=function(a){a.forEach(function(a){a.execute()}),g.renderer.helper.redraw()};return{init:function(a){b.init(a),b.reset()},reset:function(a){f.reset(a),b.reset(),g.renderer.reset()},updateSavePoint:function(){b.saved()},invoke:function(a){a&&a.length>0&&(c(a),b.push(a))},undo:function(){var d=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};b.hasAnythingToUndo()&&(a.manipulate.unselect(),g.renderer.relation.clearRelationSelection(),c(d(b.prev())))},redo:function(){b.hasAnythingToRedo()&&(a.manipulate.unselect(),g.renderer.relation.clearRelationSelection(),c(b.next()))},factory:function(){var b=function(a){console.log("[controller.command.invoke]",a)};return{spanCreateCommand:function(c){var d=e.makeSpanId(c.begin,c.end);return{execute:function(){try{f.annotationData.addSpan({begin:c.begin,end:c.end}),g.renderer.span.render(d),a.selector.span.select(d),b("create a new span, spanId:"+d)}catch(e){throw f.annotationData.removeSpan(d),e}},revert:h.command.factory.spanRemoveCommand.bind(null,d)}},spanRemoveCommand:function(a){var c=f.annotationData.getSpan(a);return{execute:function(){this.begin=c.begin,this.end=c.end,f.annotationData.removeSpan(a),g.renderer.span.destroy(a),b("remove a span, spanId:"+a)},revert:h.command.factory.spanCreateCommand.bind(null,{begin:c.begin,end:c.end})}},spanMoveCommand:function(a,c,d){var g=[],i=e.makeSpanId(c,d);f.annotationData.getSpan(i)||(g.push(h.command.factory.spanRemoveCommand(a)),g.push(h.command.factory.spanCreateCommand({begin:c,end:d})),f.annotationData.getSpan(a).getTypes().forEach(function(a){a.entities.forEach(function(b){g.push(h.command.factory.entityCreateCommand(i,a.name,b))})}));var j=e.parseSpanId(a);return{execute:function(){g.forEach(function(a){a.execute()}),b("move a span, spanId:"+a+", newBegin:"+c+", newEnd:"+d)},revert:h.command.factory.spanMoveCommand.bind(null,i,j.begin,j.end)}},spanReplicateCommand:function(a){var c=f.getReplicationSpans(a).map(h.command.factory.spanCreateCommand);return{execute:function(){c.forEach(function(a){a.execute()}),b("replicate a span, begin:"+a.begin+", end:"+a.end)},revert:function(){var d=c.map(function(a){return a.revert()});return{execute:function(){d.forEach(function(a){a.execute()}),b("revert replicate a span, begin:"+a.begin+", end:"+a.end)}}}}},entityCreateCommand:function(c,d,e){return{execute:function(){e=e||f.annotationData.getNewEntityId();var h={id:e,span:c,type:d};f.annotationData.addEntity(h),g.renderer.entity.render(h),a.selector.entity.select(e),b("create a new entity, spanId:"+c+", type:"+d+"  entityId:"+e)},revert:function(){return h.command.factory.entityRemoveCommand(e,c,d)}}},entityRemoveCommand:function(a,c,d){var e=f.annotationData.entities[a];return{execute:function(){var c=f.annotationData.removeEnitity(a);g.renderer.entity.destroy(c),b("remove a entity, spanId:"+e.span+", type:"+e.type+", entityId:"+a)},revert:h.command.factory.entityCreateCommand.bind(null,c||e.span,d||e.type,a)}},entityChangeTypeCommand:function(a,c){return{execute:function(){var d=f.annotationData.removeEnitity(a),e=d.type;d.type=c,f.annotationData.addEntity(d),g.renderer.entity.changeTypeOfExists(d),b("change type of a entity, spanId:"+d.span+", type:"+e+", entityId:"+a+", newType:"+c)},revert:h.command.factory.entityChangeTypeCommand.bind(null,a,f.annotationData.entities[a].type)}},relationCreateCommand:function(a,c,d,e){return{execute:function(){f.annotationData.relations[a]={id:a,subj:c,obj:d,pred:e},f.relationsPerEntity[c]?f.relationsPerEntity[c].indexOf(a)<0&&f.relationsPerEntity[c].push(a):f.relationsPerEntity[c]=[a],f.relationsPerEntity[d]?f.relationsPerEntity[d].indexOf(a)<0&&f.relationsPerEntity[d].push(a):f.relationsPerEntity[d]=[a],g.renderer.relation.render(a),g.renderer.relation.selectRelation(a),b("create a new relation relationId:"+a+", subject:"+c+", object:"+d+", predicate:"+e)},revert:h.command.factory.relationRemoveCommand.bind(null,a)}},relationRemoveCommand:function(a){var c=f.annotationData.relations[a],d=c.subj,e=c.obj,i=c.pred;return{execute:function(){delete f.annotationData.relations[a],console.log("before remove relation",f.relationsPerEntity);var c=f.relationsPerEntity[d];c.splice(c.indexOf(a),1),0===c.length&&delete f.relationsPerEntity[d];var h=f.relationsPerEntity[e];h.splice(h.indexOf(a),1),0===h.length&&delete f.relationsPerEntity[e],g.renderer.relation.destroy(a),b("remove a relation relationId:"+a+", subject:"+d+", object:"+e+", predicate:"+i)},revert:h.command.factory.relationCreateCommand.bind(null,a,d,e,i)}},relationChangePredicateCommand:function(a,b){var c=f.annotationData.relations[a].pred;return{execute:function(){f.annotationData.relations[a].pred=b,g.renderer.relation.cachedConnectors[a].setPaintStyle(f.connectorTypes[b+"_selected"].paintStyle),g.renderer.relation.cachedConnectors[a].setHoverPaintStyle(f.connectorTypes[b+"_selected"].hoverPaintStyle),g.renderer.relation.cachedConnectors[a].setLabel("["+a+"] "+b),g.renderer.relation.selectRelation(a)},revert:h.command.factory.relationChangePredicateCommand.bind(null,a,c)}}}}()}}(),u={editHandler:function(){var b=function(b){var c=a.selector.entity.getSelecteds();if(c.length>0){var d=[];c.each(function(){d.push(h.command.factory.entityChangeTypeCommand(this.title,b))}),h.command.invoke(d)}};return{replicate:function(){1===a.selector.span.getNumberOfSelected()?h.command.invoke([h.command.factory.spanReplicateCommand(f.annotationData.getSpan(a.selector.span.getSelectedId()))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var b=[];a.selector.span.getSelecteds().each(function(){b.push(h.command.factory.entityCreateCommand(this.id,f.annotationData.entityTypeContainer.getDefaultType()))}),h.command.invoke(b)},setEntityType:function(){var a=$(this).attr("label");return b(a),!1},newLabel:function(){if(a.selector.entity.hasSelecteds()){var c=prompt("Please enter a new label","");c&&b(c)}},removeSelectedElements:function(){var b=function(){var a=function(a){var b={};return a.forEach(function(a){b[a]=null}),Object.keys(b)},b=[],c=[],d=[];return{addSpanId:function(a){b.push(a)},addEntityId:function(a){c.push(a)},addRelations:function(a){Array.prototype.push.apply(d,a)},getAll:function(){return a(d).map(h.command.factory.relationRemoveCommand).concat(a(c).map(function(a){return h.command.factory.entityRemoveCommand(a)}),a(b).map(h.command.factory.spanRemoveCommand))}}}(),c=function(a){b.addEntityId(a),f.relationsPerEntity[a]&&b.addRelations(f.relationsPerEntity[a])};a.selector.span.getSelecteds().each(function(){var a=this.id;b.addSpanId(a),f.annotationData.getSpan(a).getTypes().forEach(function(a){a.entities.forEach(function(a){c(a)})})}),a.selector.entity.getSelecteds().each(function(){c(this.title)}),b.addRelations(g.renderer.relation.relationIdsSelected),g.renderer.relation.relationIdsSelected=[],h.command.invoke(b.getAll())},copyEntities:function(){g.viewModel.clipBoard=function(){return a.selector.span.getSelecteds().map(function(){return f.annotationData.getSpan(this.id).getTypes().map(function(a){return a.entities}).reduce(function(a,b){return a.concat(b)})}).get()}().concat(function(){return a.selector.entity.getSelecteds().map(function(){return $(this).attr("title")}).get()}()).reduce(function(a,b){return a.indexOf(b)<0&&a.push(b),a},[])},pasteEntities:function(){var b=a.selector.span.getSelecteds().map(function(){var a=this.id;return g.viewModel.clipBoard.map(function(b){return h.command.factory.entityCreateCommand(a,f.annotationData.entities[b].type)})}).get();h.command.invoke(b)},setEntityTypeDefault:function(){return f.annotationData.entityTypeContainer.setDefaultType($(this).attr("label")),!1}}}(),viewHandler:function(){return{showPallet:function(a){var b=function(){return f.annotationData.entityTypeContainer.getSortedNames().map(function(a){var b=f.annotationData.entityTypeContainer.getType(a),c=$("<td>").append(function(){var b=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:a});return a===f.annotationData.entityTypeContainer.getDefaultType()&&b.attr({title:"default type",checked:"checked"}),b}()),d=$("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",a).text(a),e=$("<td>");return b.uri&&e.append($("<a>").attr({href:b.uri,target:"_blank"}).append('<img src="images/link.png"/>')),$("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":b.getColor()}).append([c,d,e])})},c=function(){var a=$(".textae-editor__entity-pallet");return 0===a.length?(a=$("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("mouseup",".textae-edtior__entity-pallet__entity-type__radio",h.userEvent.editHandler.setEntityTypeDefault).on("click",".textae-editor__entity-pallet__entity-type__label",function(){h.userEvent.viewHandler.hidePallet(),h.userEvent.editHandler.setEntityType.call(this)}).hide(),$("body").append(a)):(a.find("table").empty(),a.css("width","auto")),a},d=c();d.find("table").append(b(f.annotationData.entityTypeContainer)),d.outerHeight()+"px"===d.css("max-height")?d.css("overflow-y","scroll"):d.css("overflow-y",""),1===arguments.length?d.css({top:a.top,left:a.left}):d.css({top:10,left:20}),d.show()},hidePallet:function(){$(".textae-editor__entity-pallet").hide()},redraw:function(){g.renderer.helper.redraw()},cancelSelect:function(){return window.getSelection().isCollapsed?(a.manipulate.unselect(),h.userEvent.viewHandler.hidePallet(),d.tool.cancelSelect(),void 0):(a.manipulate.dismissBrowserSelection(),!0)},selectLeftSpan:function(){if(1==a.selector.span.getNumberOfSelected()){var b=f.annotationData.getSpan(a.selector.span.popSelectedId());a.manipulate.unselect(),b.left&&a.selector.span.select(b.left.id)}},selectRightSpan:function(){if(1==a.selector.span.getNumberOfSelected()){var b=f.annotationData.getSpan(a.selector.span.popSelectedId());a.manipulate.unselect(),b.right&&a.selector.span.select(b.right.id)}},showSettingDialog:function(){var a=$("<div>").addClass("textae-editor__setting-dialog");a.append($("<div>").append("<label>Line Height:").append($("<input>").attr({type:"number",step:1,min:3,max:10,value:4}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){var a=$(this).val();h.userEvent.viewHandler.changeLineHeight(a)});var c=$("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view");"INSTANCE"===g.viewModel.viewMode.get()&&c.attr({checked:"checked"}),a.append($("<div>").append("<label>Instance/Relation View:").append(c)).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?g.viewModel.viewMode.set("INSTANCE"):g.viewModel.viewMode.set("TERM"),g.renderer.helper.redraw()}),b.getDialog(d.editorId,"textae.dialog.setting","Chage Settings",a,!0).open()},changeLineHeight:function(a){g.renderer.helper.changeLineHeight(a),g.renderer.helper.redraw()}}}()};return{init:function(){d.on("mouseup",".textae-editor__body",j).on("mouseup",".textae-editor__span",k).on("mouseup",".textae-editor__type-label",m).on("mouseup",".textae-editor__entity-pane",n).on("mouseup",".textae-editor__entity",o).on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",s).on("selectChanged",".textae-editor__span",p).on("selectChanged",".textae-editor__entity",q),d.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bind("click",r)}),h.command.init(function(){g.viewModel.buttonStateHelper.enabled("write",this.hasAnythingToSave()),g.viewModel.buttonStateHelper.enabled("undo",this.hasAnythingToUndo()),g.viewModel.buttonStateHelper.enabled("redo",this.hasAnythingToRedo()),window.onbeforeunload=this.hasAnythingToSave()?function(){return"There is a change that has not been saved. If you leave now, you will lose it."}:null})},command:t,userEvent:u}}(this);return this.api={start:function(){h.init(),g.init(),f.init()},handleKeyInput:function(a){var b={A:d.showAccess,C:h.userEvent.editHandler.copyEntities,D:h.userEvent.editHandler.removeSelectedElements,DEL:h.userEvent.editHandler.removeSelectedElements,E:h.userEvent.editHandler.createEntity,Q:h.userEvent.viewHandler.showPallet,R:h.userEvent.editHandler.replicate,S:d.showSave,V:h.userEvent.editHandler.pasteEntities,W:h.userEvent.editHandler.newLabel,X:h.command.redo,Y:h.command.redo,Z:h.command.undo,ESC:h.userEvent.viewHandler.cancelSelect,LEFT:h.userEvent.viewHandler.selectLeftSpan,RIGHT:h.userEvent.viewHandler.selectRightSpan};b[a]&&b[a]()},handleButtonClick:function(a){var b={"textae.control.button.read.click":d.showAccess,"textae.control.button.write.click":d.showSave,"textae.control.button.undo.click":h.command.undo,"textae.control.button.redo.click":h.command.redo,"textae.control.button.replicate.click":h.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":g.viewModel.toggleReplicateAuto,"textae.control.button.entity.click":h.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":h.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":function(){h.userEvent.viewHandler.showPallet(a.point)},"textae.control.button.delete.click":h.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":h.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":h.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":h.userEvent.viewHandler.showSettingDialog};b[a.name]()},redraw:h.userEvent.viewHandler.redraw},this},d=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=function(a){this.buttonClick({name:e.eventName,point:{top:a.clientY-this.get(0).offsetTop,left:a.clientX-this.get(0).offsetLeft}})}.bind(this);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b){b?a.push(f["replicate-auto"].instance):a.unpush(f["replicate-auto"].instance)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateReplicateAutoButtonPushState=e,this},e=function(){{var a={control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:b.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),about:b.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")}}),hideAll:function(){a.infoModals.help.hide(),a.infoModals.about.hide()}}},c={handleKeyInput:function(b){"H"===b?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(b),"ESC"===b&&a.infoModals.hideAll())},handleButtonClick:function(b){switch(b.name){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(b)}},handleEditor:{select:function(b){a.editors.select(b)},cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b){a.control.updateAllButtonEnableState(b)},pushReplicateAuto:function(b){a.control.updateReplicateAutoButtonPushState(b)}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},d=!0,e=function(a){d&&c.handleKeyInput(b(a.keyCode))};$(document).on("keyup",e),$("body").on("dialogopen",".ui-dialog",function(){d=!1}).on("dialogclose",".ui-dialog",function(){d=!0})},d=function(){$(window).on("resize",function(){var b;return function(){b&&window.clearTimeout(b),b=window.setTimeout(function(){a.editors.forEach(function(a){a.api.redraw()})},200)}}())};$(function(){b(),d()})}()}return{setControl:function(b){$.extend(b,{buttonClick:function(a){c.handleButtonClick(a)}}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:{selectMe:c.handleEditor.select.bind(this,b),cancelSelect:c.handleEditor.cancel,changeButtonState:c.handleEditor.changeButtonState,pushReplicateAuto:c.handleEditor.pushReplicateAuto}})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return e.pushEditor(a),c.apply(a),a.api.start(),a}),e.selectFirstEditor();else if(this.hasClass("textae-control")){var a=d.apply(this);return e.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);