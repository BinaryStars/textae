/*! textae 4.0.1 31-03-2014 */
!function(a){var c={ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||(console.log("POST data"),$.ajax({type:"post",url:b,contentType:"application/json",data:c,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(a){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}}),a&&this.find('[type="text"]').val(a)},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}()},d=function(){var a={BLOCK_THRESHOLD:100},d=function(a){var b=function(){var b=function(){var b=$("<div>").append('<div>Sever :<input type="text" class="textae-editor__load-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div>Local :<input type="file" /></div>').on("change",'[type="file"]',function(){d.getAnnotationFromFile(this),b.dialogClose()}).on("click",'[type="button"]',function(){var a=b.find(".textae-editor__load-dialog__file-name").val();d.getAnnotationFromServer(a),b.dialogClose()});return c.getDialog(a.editorId,"textae.dialog.load","Load document with annotation.",b)},e=function(){var b=$("<div>").append('<div>Sever :<input type="text" class="textae-editor__save-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div>Local :<span class="span_link_place"><a target="_blank"/></span></div>').on("click","a",function(){i.command.updateSavePoint(),b.dialogClose()}).on("click",'[type="button"]',function(){var a=b.find(".textae-editor__save-dialog__file-name").val();d.saveAnnotationToServer(a),b.dialogClose()});return c.getDialog(a.editorId,"textae.dialog.save","Save document with annotation.",b)};return{showLoad:function(a){b().open(a)},showSave:function(a,c){var d=function(a,c){{var d=b().find("input[type='file']"),e=d.prop("files")[0],f=e?e.name:"annotations.json";a.find("a").text(f).attr("href",c).attr("download",f)}},f=e();d(f,c),f.open(a)}}}(),e=function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea},g=function(){e().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),k(l)}),i.command.updateSavePoint(),h.domUtil.cursorChanger.endWait()},j=function(){e.html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),k(l)}),h.domUtil.cursorChanger.endWait()},k=function(a){if(""!==a){var b=a.replace(/\/annotations\.json$/,"");e().html("(Target: <a href='"+b+"'>"+b+"</a>)"),l=a}},l="";return{getAnnotationFromServer:function(a){h.domUtil.cursorChanger.startWait(),c.ajaxAccessor.getAsync(a,function(b){i.command.reset(b),k(a)},function(){h.domUtil.cursorChanger.endWait()})},getAnnotationFromFile:function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);i.command.reset(a)},b.readAsText(a.files[0])},saveAnnotationToServer:function(a){h.domUtil.cursorChanger.startWait();var b=f.annotationData.toJson();c.ajaxAccessor.post(a,b,g,j,function(){h.domUtil.cursorChanger.endWait()}),i.command.updateSavePoint()},showAccess:function(){b.showLoad(l)},showSave:function(){var a=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)};b.showSave(l,a(f.annotationData.toJson()))}}}(this),e=function(a){var b=[];return{makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:c[0],end:c[1]}},makeTypeId:function(a,c){return-1===b.indexOf(c)&&b.push(c),a+"-"+b.indexOf(c)},makeEntityDomId:function(b){return a.editorId+"__E"+b},makeParagraphId:function(b){return a.editorId+"__P"+b}}}(this),f=function(a){var b={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n","–"],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf(a)>=0}};return{init:function(){var b=function(a){h.viewModel.typeContainer.setDefinedEntityTypes(a["entity types"]),h.viewModel.typeContainer.setDefinedRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};f.spanConfig.set();var e=$.extend(c.getUrlParameters(location.search),{debug:a.attr("debug"),config:a.attr("config"),target:a.attr("target")});if(e.config&&""!==e.config){var g=c.ajaxAccessor.getSync(e.config);null!==g?(f.spanConfig.set(g),b(g)):alert("could not read the span configuration from the location you specified.")}e.target&&""!==e.target&&d.getAnnotationFromServer(e.target)},spanConfig:b,annotationData:function(){var a,b,c=null,d=function(){var a=f.annotationData.getAllSpan().sort(function(a,b){return a.begin-b.begin||b.end-a.end}),b=[];a.forEach(function(a,c,d){$.extend(a,{children:[],left:0!==c?d[c-1]:null,right:c!==d.length-1?d[c+1]:null});var e=b[b.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(e)?(e.children.push(a),a.parent=e):b.push(a)}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},c=a.map(function(a){return a.id}),f.annotationData.spansTopLevel=b},g=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)},h=g.bind(null,"E",function(){return Object.keys(f.annotationData.entities)}),i=function(){return Object.keys(f.annotationData.relations)},j=g.bind(null,"R",i),k=function(a){var c={isChildOf:function(b){return b&&b.begin<=a.begin&&a.end<=b.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+f.annotationData.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=f.annotationData.spansTopLevel.indexOf(this),0===a||f.annotationData.spansTopLevel[a-1].paragraph!==this.paragraph?null:f.annotationData.spansTopLevel[a-1])},getTypes:function(){var a=this.id;return Object.keys(f.annotationData.entities).map(function(a){return f.annotationData.entities[a]}).filter(function(b){return a===b.span}).reduce(function(a,b){var c=e.makeTypeId(b.span,b.type),d=a.filter(function(a){return a.id===c});return d.length>0?d[0].entities.push(b.id):a.push({id:c,name:b.type,entities:[b.id]}),a},[])}},d=function(a){var b=f.annotationData.paragraphsArray.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return b.length>0?b[0]:null},g=e.makeSpanId(a.begin,a.end);f.annotationData.getSpan(g)||(b[g]=$.extend({id:g,paragraph:d(a)},a,c))};return{sourceDoc:"",spansTopLevel:[],entities:null,relations:{},modifications:[],reset:function(c){a=c,function(a){if(void 0===a)return void alert("read failed.");this.sourceDoc=a;var b=0;this.paragraphsArray=a.split("\n").map(function(a,c){var d={id:e.makeParagraphId(c),begin:b,end:b+a.length};return b+=a.length+1,d})}.call(this,c.text),function(a){var c=this;b={},c.entities={},a&&(a.forEach(function(a){k(a.span),c.addEntity({id:a.id,span:e.makeSpanId(a.span.begin,a.span.end),type:a.obj})}),d())}.call(this,c.denotations),function(a){a&&(this.relations=a.reduce(function(a,b){return a[b.id]=$.extend({},b),a},{}))}.call(this,c.relations),function(a){a&&(this.modifications=a)}.call(this,c.modifications)},addSpan:function(a){k(a),d()},removeSpan:function(a){delete b[a],d()},getSpan:function(a){return b[a]},getRangeOfSpan:function(a,c){var d=b[a],e=b[c];return Object.keys(b).filter(function(a){var c=b[a];return d.begin<=c.begin&&c.end<=e.end})},getAllSpan:function(){return $.map(b,function(a){return a})},addEntity:function(a){f.annotationData.entities[a.id]=a},removeEnitity:function(a){var b=f.annotationData.entities[a];return b&&delete f.annotationData.entities[a],b},getEntityTypes:function(){return Object.keys(f.annotationData.entities).map(function(a){return f.annotationData.entities[a].type})},getRelationTypes:function(){return Object.keys(f.annotationData.relations).map(function(a){return f.annotationData.relations[a].pred})},getAssosicatedRelations:function(a){return Object.keys(f.annotationData.relations).filter(function(b){var c=f.annotationData.relations[b];return c.obj===a||c.subj===a})},getNewEntityId:h,getRelationIds:i,getNewRelationId:j,toJson:function(){var b=Object.keys(f.annotationData.entities).map(function(a){var b=f.annotationData.entities[a],c=f.annotationData.getSpan(b.span);return{id:a,span:{begin:c.begin,end:c.end},obj:b.type}}),c=Object.keys(f.annotationData.relations).map(function(a){return f.annotationData.relations[a]});return JSON.stringify({annotations:$.extend(a,{denotations:b,relations:c})})}}}(),getReplicationSpans:function(a){var b=function(a){for(var b=String.prototype.indexOf.bind(f.annotationData.sourceDoc,f.annotationData.sourceDoc.substring(a.begin,a.end)),c=a.end-a.begin,d=[],e=0,g=b(e);-1!==g;g=b(e))d.push({begin:g,end:g+c}),e=g+c;return d},c=function(b){return b.begin===a.begin},d=function(a){var b=f.annotationData.sourceDoc.charAt(a.begin-1),c=f.annotationData.sourceDoc.charAt(a.end);return f.spanConfig.isDelimiter(b)&&f.spanConfig.isDelimiter(c)},e=function(a){return f.annotationData.getAllSpan().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0},g=function(a){return f.annotationData.getAllSpan().filter(function(b){return b.begin<a.begin&&a.begin<b.end&&b.end<a.end||a.begin<b.begin&&b.begin<a.end&&a.end<b.end}).length>0};return b(a).filter(function(a){return!c(a)&&d(a)&&!e(a)&&!g(a)})}}}(this),h=function(a){var c={},d=function(){var c=function(a,b){var c={},d="";return{setDefinedTypes:function(a){c=a},setDefaultType:function(a){d=a},getDefaultType:function(){return d||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},d=function(a,b){void 0!==b&&(a.setDefinedTypes(b.map(function(a){return a}).reduce(function(a,b){return a[b.name]=b,a},{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||""))},e=c(f.annotationData.getEntityTypes,"#77DDDD"),i=c(f.annotationData.getRelationTypes,"#555555");return{clipBoard:[],modeAccordingToButton:function(){var b=[],c={propagate:function(){b.forEach(function(a){a()})}};return["replicate-auto","relation-edit-mode"].forEach(function(b,c,d){var e=!1,f=function(){a.tool.push(d,e)};b[d]={value:function(a){return void 0===a?e:(e=a,void f())},toggle:function(){e=!e,f()}},c.push(f)}.bind(null,c,b)),c}(),buttonStateHelper:function(){var b=function(){return h.domUtil.selector.entity.hasSelecteds()||h.domUtil.selector.relation.hasSelecteds()},c={},d=function(a,b){b?delete c[a]:c[a]=!1},e=function(){d("entity",h.domUtil.selector.span.hasSelecteds())},f=function(){d("paste",h.viewModel.clipBoard.length>0&&h.domUtil.selector.span.hasSelecteds())},g=function(){d("replicate",h.domUtil.selector.span.isSelectOne())},i=function(){d("pallet",b())},j=function(){d("change-label",b())},k=function(){d("delete",h.domUtil.selector.hasSelecteds())},l=function(){d("copy",h.domUtil.selector.span.hasSelecteds()||h.domUtil.selector.entity.hasSelecteds())},m=function(){k(),l()};return{propagate:function(){a.tool.changeButtonState(c),h.viewModel.modeAccordingToButton.propagate()},init:function(){m(),e(),f(),g(),i(),j(),this.propagate()},enabled:function(a,b){d(a,b),this.propagate()},updateBySpan:function(){m(),e(),f(),g(),this.propagate()},updateByEntity:function(){m(),i(),j(),this.propagate()},updateByRelation:function(){k(),i(),j(),this.propagate()}}}(),viewMode:function(){var b=function(b){a.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+b+"-mode")},c=function(a){h.viewModel.modeAccordingToButton["relation-edit-mode"].value(a)};return{marginBottomOfGrid:0,isTerm:function(){return a.hasClass("textae-editor_term-mode")},setTerm:function(){b("term"),c(!1),h.viewModel.viewMode.marginBottomOfGrid=0},setInstance:function(){b("instance"),c(!1),h.viewModel.viewMode.marginBottomOfGrid=2},setRelation:function(){b("relation"),c(!0),h.viewModel.viewMode.marginBottomOfGrid=2}}}(),typeContainer:{entity:e,setDefinedEntityTypes:d.bind(null,e),relation:i,setDefinedRelationTypes:d.bind(null,i)},getConnectorStrokeStyle:function(a){var c=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"},d=f.annotationData.relations[a].pred,e=h.viewModel.typeContainer.relation.getColor(d);return{strokeStyle:c(e,1)}}}}(),i=function(){var b,d=function(a){h.domUtil.manipulate.remove(h.domUtil.selector.grid.get(a))},g={},i=function(a,b,c){var d=a+c;return g[d]?g[d]:g[d]=b(c)},j={reset:function(){g={},b=a.find(".textae-editor__body__text-box").offset()},getSpan:i.bind(null,"S",function(a){var c=h.domUtil.selector.span.get(a);if(0===c.length)throw new Error("span is not renderd : "+a);var d=c.offset();return{top:d.top-b.top,left:d.left-b.left,width:c.outerWidth(),height:c.outerHeight(),center:c.get(0).offsetLeft+c.outerWidth()/2}}),getGrid:i.bind(null,"G",function(a){return h.domUtil.selector.grid.get(a).offset()}),getEntity:function(a){var b=f.annotationData.entities[a].span,c=h.domUtil.selector.entity.get(a);if(0===c.length)throw new Error("entity is not rendered : "+a);var d=j.getGrid(b),e=c.get(0);return{top:d.top+e.offsetTop,center:d.left+e.offsetLeft+c.outerWidth()/2}}},k=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},l=k(a,"div","textae-editor__body"),m=function(){return k(l,"div","textae-editor__body__annotation-box")};return{reset:function(){var a=function(){return f.annotationData.sourceDoc.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph">'+a+"</p>"}).join("\n")},b=function(){var a={};return h.renderer.helper.getSourceDocArea().find("p").each(function(b,c){var d=$(c),e=$.extend(f.annotationData.paragraphsArray[b],{element:d});d.attr("id",e.id),a[e.id]=e}),a};h.renderer.helper.getSourceDocArea().html(a()),h.renderer.paragraphs=b(),m().empty(),j.reset(),h.renderer.helper.renderAllSpan(),h.renderer.helper.renderAllRelation()},helper:function(){return{getSourceDocArea:function(){return k(l,"div","textae-editor__body__text-box")},renderAllSpan:function(){f.annotationData.spansTopLevel.forEach(function(a){h.renderer.span.render(a.id)})},renderAllRelation:function(){h.renderer.relation.reset(),f.annotationData.getRelationIds().forEach(function(a){h.renderer.relation.render(a)})},changeLineHeight:function(b){a.find(".textae-editor__body__text-box").css({"line-height":100*b+"%"})},redraw:function(){window.setTimeout(function(){h.renderer.grid.arrangePositionAll(),h.renderer.relation.arrangePositionAll()},10)}}}(),span:{render:function(a){var b=function(a){var b=function(b,c){var d=a.begin-c,e=a.end-c;if(0>d||b.length<e)throw new Error("oh my god! I cannot render this span. "+a.toStringOnlyThis()+", textNode "+b.textContent);var f=document.createRange();return f.setStart(b,d),f.setEnd(b,e),f},c=function(){var c=function(a){var c=h.renderer.paragraphs[a.paragraph.id];return textNodeInParagraph=c.element.contents().filter(function(){return 3===this.nodeType}).get(0),b(textNodeInParagraph,c.begin)},d=a.getBigBrother();if(d)return b(document.getElementById(d.id).nextSibling,d.end);if(a.parent){var e=h.domUtil.selector.span.get(a.parent.id).contents().filter(function(){return 3===this.nodeType}).get(0);return b(e,a.parent.begin)}return c(a)},d=document.createElement("span");d.setAttribute("id",a.id),d.setAttribute("title",a.id),d.setAttribute("class","textae-editor__span"),c(a.id).surroundContents(d)},c=function(a){a.getTypes().forEach(function(a){a.entities.forEach(function(a){h.renderer.entity.render(f.annotationData.entities[a])})})},d=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),h.renderer.span.destroy(a.id)};a.children.filter(function(a){return null!==document.getElementById(a.id)}).forEach(function(a){b(a)})},e=f.annotationData.getSpan(a);d(e),b(e),c(e),e.children.filter(function(a){return null===document.getElementById(a.id)}).forEach(function(a){h.renderer.span.render(a.id)}),h.renderer.grid.arrangePosition(e)},destroy:function(a){for(var b=document.getElementById(a),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);h.domUtil.manipulate.remove(b),c.normalize(),d(a)}},entity:function(){var a=function(a,b){return $("#"+e.makeTypeId(a,b))},b=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},c=function(c){var d=function(a){return 0===f.annotationData.getSpan(c.span).getTypes().filter(function(b){return b.name===a}).length},e=h.domUtil.manipulate.remove(h.domUtil.selector.entity.get(c.id)).attr("type");d(e)?a(c.span,e).remove():b(a(c.span,e).find(".textae-editor__entity-pane"))};return{render:function(c){var d=function(b,c){var d=function(a,b){var c=e.makeTypeId(a,b),d=$("<div>").attr("id","P-"+c).addClass("textae-editor__entity-pane"),f=b;if(String(b).indexOf("http")>-1){var g=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost(?=\/)|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi,i=g.exec(b);f=i[6]?i[6]+(i[7]||""):i[5]?i[5].split("/").filter(function(a){return""!==a}).pop():i[3]}var j=$("<div>").addClass("textae-editor__type-label").text(f).css({"background-color":h.viewModel.typeContainer.entity.getColor(b)});return $("<div>").attr("id",c).addClass("textae-editor__type").append(j).append(d)},f=function(a){var b=function(a){var b=j.getSpan(a),c=$("<div>").attr("id","G"+a).addClass("textae-editor__grid").css({width:b.width});return m().append(c),c},c=h.domUtil.selector.grid.get(a);return 0===c.length?b(a):c},g=a(b,c);return 0===g.length&&(g=d(b,c),f(b).append(g)),g},g=function(a){var b=$("<div>").attr("id",e.makeEntityDomId(a.id)).attr("title",a.id).attr("type",String(a.type)).addClass("textae-editor__entity").css({"border-color":h.viewModel.typeContainer.entity.getColor(a.type)});return f.annotationData.modifications.filter(function(b){return b.obj===a.id}).map(function(a){return"textae-editor__entity-"+a.pred.toLowerCase()}).forEach(function(a){b.addClass(a)}),b},i=d(c.span,c.type).find(".textae-editor__entity-pane").append(g(c));b(i)},destroy:function(a){var b=function(a){return 0===f.annotationData.getSpan(a).getTypes().length};b(a.span)?d(a.span):c(a)},changeTypeOfExists:function(a){c(a),h.renderer.entity.render(a)}}}(),grid:{arrangePosition:function(a){var b=function(a){var b=j.getSpan(a.id),c=h.domUtil.selector.grid.get(a.id);c.length>0&&c.css({top:b.top-h.viewModel.viewMode.marginBottomOfGrid-c.outerHeight(),left:b.left})},c=function(a){var b=function(a){var c=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return b(a)}));return h.domUtil.selector.grid.get(a.id).outerHeight()+c+h.viewModel.viewMode.marginBottomOfGrid};if(a.getTypes().length>0&&a.children.length>0){var c=j.getSpan(a.id),d=b(a);h.domUtil.selector.grid.get(a.id).css({top:c.top-h.viewModel.viewMode.marginBottomOfGrid-d})}};b(a),c(a)},arrangePositionAll:function(){var a=function(b){b.children.forEach(function(b){a(b)}),h.renderer.grid.arrangePosition(b)};j.reset(),f.annotationData.spansTopLevel.filter(function(a){return a.getTypes().length>0}).forEach(function(b){a(b)})}},relation:function(){var b=function(){var a=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return a.setRenderMode(a.SVG),a.Defaults.Container=m(),a}(),d=function(a,b){var c=j.getEntity(a),d=j.getEntity(b),e=c.center,f=d.center,g=c.top,i=d.top,k=Math.abs(e-f),l=Math.abs(g-i),m=k*h.renderer.relation.settings.xrate+l*h.renderer.relation.settings.yrate+h.renderer.relation.settings.c_offset;return m/=2.4};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},reset:function(){b.reset(),c={},h.domUtil.selector.relation.emptyRelationIdsSelected()},render:function(e){var g,i,j,k=f.annotationData.relations[e].subj,l=f.annotationData.relations[e].obj;k==l?(g=[.5,0,-1,-1],i=[.5,0,1,-1],j=30):(g="TopCenter",i="TopCenter",j=d(k,l));var m=b.connect({source:h.domUtil.selector.entity.get(k),target:h.domUtil.selector.entity.get(l),anchors:[g,i],connector:["Bezier",{curviness:j}],paintStyle:h.viewModel.getConnectorStrokeStyle(e),parameters:{id:e},cssClass:"textae-editor__relation",overlays:[["Arrow",{width:10,length:12,location:1}],["Label",{label:"["+e+"] "+f.annotationData.relations[e].pred,cssClass:"textae-editor__relation__label"}]]});return a.trigger("textae.editor.jsPlumbConnection.add",m),c[e]=m,m},destroy:function(a){b.detach(c[a]),delete c[a]},changePredicate:function(a,b){var d=c[a];if(!d)throw"no connector";var e=d.getOverlays().filter(function(a){return"Label"===a.type})[0];if(!e)throw"no label overlay";e.setLabel("["+a+"] "+b),d.setPaintStyle(h.viewModel.getConnectorStrokeStyle(a))},arrangePosition:function(a){var b=f.annotationData.relations[a].subj,e=f.annotationData.relations[a].obj,g=d(b,e);b==e&&(g=30);var h=c[a];h.endpoints[0].repaint(),h.endpoints[1].repaint(),h.setConnector(["Bezier",{curviness:g}]),h.addOverlay(["Arrow",{width:10,length:12,location:1}])},arrangePositionAll:function(){window.setTimeout(function(){f.annotationData.getRelationIds().forEach(function(a){h.renderer.relation.arrangePosition(a)})},0)}}}()}}(),j={cursorChanger:function(){var b=function(){a.addClass("textae-editor_wait")},c=function(){a.removeClass("textae-editor_wait")};return{startWait:b,endWait:c}}(),selector:{getSelecteds:function(){return a.find(".ui-selected")},hasSelecteds:function(){return h.domUtil.selector.getSelecteds().length>0},span:{get:function(b){return a.find("#"+b)},getSelecteds:function(){return a.find(".textae-editor__span.ui-selected").map(function(){return this.id}).get()},hasSelecteds:function(){return h.domUtil.selector.span.getSelecteds().length>0},isSelectOne:function(){return 1===h.domUtil.selector.span.getSelecteds().length},select:function(a){h.domUtil.manipulate.select(h.domUtil.selector.span.get(a))}},entity:{get:function(a){return $("#"+e.makeEntityDomId(a))},getSelecteds:function(){return a.find(".textae-editor__entity.ui-selected").map(function(){return this.title}).get()},hasSelecteds:function(){return h.domUtil.selector.entity.getSelecteds().length>0},select:function(a){h.domUtil.manipulate.select(h.domUtil.selector.entity.get(a))},deselect:function(a){h.domUtil.manipulate.deselect(h.domUtil.selector.entity.get(a))}},relation:function(){var a=[],b=function(b){return a.indexOf(b)>-1};return{getSelecteds:function(){return a},hasSelecteds:function(){return a.length>0},select:function(d){b(d)||(a.push(d),h.viewModel.buttonStateHelper.updateByRelation(),window.setTimeout(function(){c[d].addClass("ui-selected")},0))},deselect:function(b){var d=a.indexOf(b);d>-1&&(c[b].removeClass("ui-selected"),a.splice(d,1),h.viewModel.buttonStateHelper.updateByRelation())},clearRelationSelection:function(){a.forEach(function(a){c[a].removeClass("ui-selected")}),h.domUtil.selector.relation.emptyRelationIdsSelected()},emptyRelationIdsSelected:function(){a=[],h.viewModel.buttonStateHelper.updateByRelation()},toggle:function(a){b(a)?h.domUtil.selector.relation.deselect(a):h.domUtil.selector.relation.select(a)}}}(),grid:{get:function(b){return a.find("#G"+b)}}},manipulate:function(){var a=function(a){return $(a).hasClass("ui-selected")},b=function(){a(this)||$(this).addClass("ui-selected").trigger("selectChanged",!0)},c=function(){a(this)&&$(this).removeClass("ui-selected").trigger("selectChanged",!1)},d=function(){a(this)?c.apply(this):b.apply(this)},e=function(){var a=$(this);c.call(a.add(a.find(".ui-selected"))),a.remove()},f=function(a,b){return $(b).each(a)};return{select:f.bind(null,b),deselect:f.bind(null,c),toggle:f.bind(null,d),remove:f.bind(null,e),selectOnly:function(a){h.domUtil.manipulate.deselect(h.domUtil.selector.getSelecteds().not(a)),h.domUtil.selector.relation.clearRelationSelection(),h.domUtil.manipulate.select(a)},unselect:function(){h.domUtil.manipulate.deselect(h.domUtil.selector.getSelecteds()),h.domUtil.selector.relation.clearRelationSelection()},dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}}}()};return{init:function(){h.viewModel.buttonStateHelper.init()},renderer:i,domUtil:j,viewModel:d}}(this),i=function(b){var d=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},g=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=h.renderer.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return void console.log(d);b=f.annotationData.getSpan(d).begin}for(var e=a.parentElement.childNodes,g=0;e[g]!=a;g++)b+="#text"==e[g].nodeName?e[g].nodeValue.length:$("#"+e[g].id).text().length;return b},j=function(a){var b=g(a.focusNode);return b+=a.focusOffset},k=function(a){var b=g(a.anchorNode);return b+a.anchorOffset},l=function(a){for(var b=a;f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b));)b++;for(;!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b))&&b>0&&!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b-1));)b--;return b},m=function(a){for(var b=a;f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b-1));)b--;for(;!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b))&&b<f.annotationData.sourceDoc.length;)b++;return b},n=function(a){for(var b=a;b<f.annotationData.sourceDoc.length&&(f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b))||!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b-1)));)b++;return b},o=function(a){for(var b=a;b>0&&(f.spanConfig.isNonEdgeCharacter(f.annotationData.sourceDoc.charAt(b-1))||!f.spanConfig.isDelimiter(f.annotationData.sourceDoc.charAt(b)));)b--;return b},p=function(b){if(b.anchorNode.parentElement.id!==b.focusNode.parentElement.id)return console.log(b.anchorNode.parentElement.id,b.focusNode.parentElement.id),!1;var c=k(b),d=j(b);if(c>d){var g=c;c=d,d=g}var n=f.annotationData.sourceDoc.substring(c,d);return f.spanConfig.nonEdgeCharacters.forEach(function(a){n=n.replace(a,"")}),0===n.length?(h.domUtil.manipulate.dismissBrowserSelection(),!0):(h.domUtil.manipulate.unselect(),function(b,c){var d=e.makeSpanId(b,c);if(!f.annotationData.getSpan(d)){var g=[i.command.factory.spanCreateCommand({begin:b,end:c})];h.viewModel.modeAccordingToButton["replicate-auto"].value()&&c-b<=a.BLOCK_THRESHOLD&&g.push(i.command.factory.spanReplicateCommand({begin:b,end:c})),i.command.invoke(g)}}(l(c),m(d)),!0)},q=function(a,b,c){return a!==e.makeSpanId(b,c)?[i.command.factory.spanMoveCommand(a,b,c)]:void 0},r=function(a,b){var c=[],d=j(b),e=b.getRangeAt(0),g=document.createRange();if(g.selectNode(b.anchorNode),e.compareBoundaryPoints(Range.START_TO_START,g)<0){var h=l(d);c=q(a,h,f.annotationData.getSpan(a).end)}else{var k=m(d);c=q(a,f.annotationData.getSpan(a).begin,k)}i.command.invoke(c)},s=function(a,b){var c=[],d=j(b),g=b.getRangeAt(0),k=document.createRange();k.selectNode(b.focusNode);var l,m=function(a){return[i.command.factory.spanRemoveCommand(a)]};if(g.compareBoundaryPoints(Range.START_TO_START,k)>0){var p=o(d);p>f.annotationData.getSpan(a).begin?(l=e.makeSpanId(f.annotationData.getSpan(a).begin,p),c=f.annotationData.getSpan(l)?m(a):q(a,f.annotationData.getSpan(a).begin,p)):(h.domUtil.selector.span.select(a),i.userEvent.editHandler.removeSelectedElements())}else{var r=n(d);r<f.annotationData.getSpan(a).end?(l=e.makeSpanId(r,f.annotationData.getSpan(a).end),c=f.annotationData.getSpan(l)?m(a):q(a,r,f.annotationData.getSpan(a).end)):(h.domUtil.selector.span.select(a),i.userEvent.editHandler.removeSelectedElements())}i.command.invoke(c)},t=function(a){if(h.domUtil.selector.span.isSelectOne()){var b=h.domUtil.selector.span.getSelecteds()[0],c=f.annotationData.getSpan(b);return c.begin<a&&a<c.end}return!1},u=function(a){if(a.anchorNode.parentNode.parentNode===a.focusNode.parentNode)return h.domUtil.manipulate.unselect(),r(a.anchorNode.parentNode.id,a),h.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(k(a))){var b=h.domUtil.selector.span.getSelecteds()[0];return h.domUtil.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id?(r(b,a),h.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be expanded to make a boundary crossing."),h.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},v=function(a){if(a.anchorNode.parentNode===a.focusNode.parentNode.parentNode)return h.domUtil.manipulate.unselect(),s(a.focusNode.parentNode.id,a),h.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(j(a))){var b=h.domUtil.selector.span.getSelecteds()[0];return a.focusNode.parentNode.id===b?(s(b,a),h.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be shrinked to make a boundary crossing."),h.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},w=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),h.domUtil.manipulate.dismissBrowserSelection()},x=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:(w(),!1)},y=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:v(a)?!1:(w(),!1)
},z=function(){i.userEvent.viewHandler.hidePallet();var a=window.getSelection();return a.isCollapsed?(i.userEvent.viewHandler.cancelSelect(),h.domUtil.manipulate.dismissBrowserSelection(),!0):x(a)},A=function(a){i.userEvent.viewHandler.hidePallet();var b=window.getSelection();if(b.isCollapsed){if(a.shiftKey&&h.domUtil.selector.span.isSelectOne()){var c=h.domUtil.selector.span.getSelecteds()[0],d=$(this).attr("id");h.domUtil.manipulate.unselect(),f.annotationData.getRangeOfSpan(c,d).forEach(function(a){h.domUtil.selector.span.select(a)})}else a.ctrlKey?h.domUtil.manipulate.toggle(a.target):h.domUtil.manipulate.selectOnly(a.target);return!1}return y(b)},B=function(a,b,c){var d=b.add(c);return a?b.hasClass("ui-selected")?h.domUtil.manipulate.deselect(d):h.domUtil.manipulate.select(d):h.domUtil.manipulate.selectOnly(d),!1},C=function(a){var b=$(a.target);return B(a.ctrlKey,b,b.next().children())},D=function(a){var b=$(a.target);return B(a.ctrlKey,b.prev(),b.children())},E=function(){h.viewModel.buttonStateHelper.updateBySpan()},F=function(a){var b=$(a.target).parent();b.children().length===b.find(".ui-selected").length?h.domUtil.manipulate.select(b.prev()):h.domUtil.manipulate.deselect(b.prev()),h.viewModel.buttonStateHelper.updateByEntity()},G=function(a,b){var c=a.getParameter("id");b.ctrlKey?h.domUtil.selector.relation.toggle(c):(h.domUtil.manipulate.unselect(),h.domUtil.selector.relation.select(c))},H=null,I=function(a,b){return H&&H(a,b),d(b),!1},J=function(){b.tool.selectMe(),h.viewModel.buttonStateHelper.propagate()},K=function(){var a=function(){var a,b=-1,c=-1,d=[],e=function(){a&&a()};return{init:function(b){void 0!==b&&(a=b.bind(this))},reset:function(){b=-1,c=-1,d=[],e()},push:function(a){d.splice(c+1,d.length-c,a),c++,e()},next:function(){return c++,e(),d[c]},prev:function(){var a=d[c];return c--,e(),a},saved:function(){b=c,e()},hasAnythingToUndo:function(){return c>-1},hasAnythingToRedo:function(){return c<d.length-1},hasAnythingToSave:function(){return c!=b}}}(),b=function(a){a.forEach(function(a){a.execute()}),h.renderer.helper.redraw()};return{init:function(b){a.init(b),a.reset()},reset:function(b){f.annotationData.reset(b),a.reset(),h.renderer.reset()},updateSavePoint:function(){a.saved()},invoke:function(c){c&&c.length>0&&(b(c),a.push(c))},undo:function(){var c=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};a.hasAnythingToUndo()&&(h.domUtil.manipulate.unselect(),b(c(a.prev())))},redo:function(){a.hasAnythingToRedo()&&(h.domUtil.manipulate.unselect(),b(a.next()))},factory:function(){var a=function(a){console.log("[controller.command.invoke]",a)};return{spanCreateCommand:function(b){var c=e.makeSpanId(b.begin,b.end);return{execute:function(){try{f.annotationData.addSpan({begin:b.begin,end:b.end}),h.renderer.span.render(c),h.domUtil.selector.span.select(c),a("create a new span, spanId:"+c)}catch(d){throw f.annotationData.removeSpan(c),d}},revert:i.command.factory.spanRemoveCommand.bind(null,c)}},spanRemoveCommand:function(b){var c=f.annotationData.getSpan(b);return{execute:function(){this.begin=c.begin,this.end=c.end,f.annotationData.removeSpan(b),h.renderer.span.destroy(b),a("remove a span, spanId:"+b)},revert:i.command.factory.spanCreateCommand.bind(null,{begin:c.begin,end:c.end})}},spanMoveCommand:function(b,c,d){var g=[],h=e.makeSpanId(c,d);f.annotationData.getSpan(h)||(g.push(i.command.factory.spanRemoveCommand(b)),g.push(i.command.factory.spanCreateCommand({begin:c,end:d})),f.annotationData.getSpan(b).getTypes().forEach(function(a){a.entities.forEach(function(b){g.push(i.command.factory.entityCreateCommand(h,a.name,b))})}));var j=e.parseSpanId(b);return{execute:function(){g.forEach(function(a){a.execute()}),a("move a span, spanId:"+b+", newBegin:"+c+", newEnd:"+d)},revert:i.command.factory.spanMoveCommand.bind(null,h,j.begin,j.end)}},spanReplicateCommand:function(b){var c=f.getReplicationSpans(b).map(i.command.factory.spanCreateCommand);return{execute:function(){c.forEach(function(a){a.execute()}),a("replicate a span, begin:"+b.begin+", end:"+b.end)},revert:function(){var d=c.map(function(a){return a.revert()});return{execute:function(){d.forEach(function(a){a.execute()}),a("revert replicate a span, begin:"+b.begin+", end:"+b.end)}}}}},entityCreateCommand:function(b,c,d){return{execute:function(){d=d||f.annotationData.getNewEntityId();var e={id:d,span:b,type:c};f.annotationData.addEntity(e),h.renderer.entity.render(e),h.domUtil.selector.entity.select(d),a("create a new entity, spanId:"+b+", type:"+c+"  entityId:"+d)},revert:function(){return i.command.factory.entityRemoveCommand(d,b,c)}}},entityRemoveCommand:function(b,c,d){var e=f.annotationData.entities[b];return{execute:function(){var c=f.annotationData.removeEnitity(b);h.renderer.entity.destroy(c),a("remove a entity, spanId:"+e.span+", type:"+e.type+", entityId:"+b)},revert:i.command.factory.entityCreateCommand.bind(null,c||e.span,d||e.type,b)}},entityChangeTypeCommand:function(b,c){return{execute:function(){var d=f.annotationData.removeEnitity(b),e=d.type;d.type=c,f.annotationData.addEntity(d),h.renderer.entity.changeTypeOfExists(d),a("change type of a entity, spanId:"+d.span+", type:"+e+", entityId:"+b+", newType:"+c)},revert:i.command.factory.entityChangeTypeCommand.bind(null,b,f.annotationData.entities[b].type)}},relationCreateCommand:function(b,c,d,e){return{execute:function(){f.annotationData.relations[b]={id:b,pred:e,subj:c,obj:d},h.renderer.relation.render(b),h.domUtil.selector.relation.select(b),a("create a new relation relationId:"+b+", subject:"+c+", object:"+d+", predicate:"+e)},revert:i.command.factory.relationRemoveCommand.bind(null,b)}},relationRemoveCommand:function(b){var c=f.annotationData.relations[b],d=c.subj,e=c.obj,g=c.pred;return{execute:function(){delete f.annotationData.relations[b],h.renderer.relation.destroy(b),a("remove a relation relationId:"+b+", subject:"+d+", object:"+e+", predicate:"+g)},revert:i.command.factory.relationCreateCommand.bind(null,b,d,e,g)}},relationChangePredicateCommand:function(b,c){var d=f.annotationData.relations[b].pred;return{execute:function(){f.annotationData.relations[b].pred=c,h.renderer.relation.changePredicate(b,c),h.domUtil.selector.relation.select(b),a("change predicate of relation, relationId:"+b+", subject:"+f.annotationData.relations[b].subj+", object:"+f.annotationData.relations[b].obj+", predicate:"+d+", newPredicate:"+c)},revert:i.command.factory.relationChangePredicateCommand.bind(null,b,d)}}}}()}}(),L=function(){var a;return{editHandler:function(){return{replicate:function(){h.domUtil.selector.span.isSelectOne()?i.command.invoke([i.command.factory.spanReplicateCommand(f.annotationData.getSpan(h.domUtil.selector.span.getSelecteds()[0]))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=h.domUtil.selector.span.getSelecteds().map(function(a){return i.command.factory.entityCreateCommand(a,h.viewModel.typeContainer.entity.getDefaultType())});i.command.invoke(a)},setEntityType:function(){var b=$(this).attr("label");return a(b),!1},newLabel:function(){if(h.domUtil.selector.entity.hasSelecteds()||h.domUtil.selector.relation.hasSelecteds()){var b=prompt("Please enter a new label","");b&&a(b)}},removeSelectedElements:function(){var a=function(){var a=function(a){return a.reduce(function(a,b){return-1===a.indexOf(b)&&a.push(b),a},[])},b=[],c=[],d=[];return{addSpanId:function(a){b.push(a)},addEntityId:function(a){c.push(a)},addRelations:function(a){d=d.concat(a)},getAll:function(){return a(d).map(i.command.factory.relationRemoveCommand).concat(a(c).map(function(a){return i.command.factory.entityRemoveCommand(a)}),a(b).map(i.command.factory.spanRemoveCommand))}}}(),b=function(b){a.addEntityId(b),a.addRelations(f.annotationData.getAssosicatedRelations(b))};h.domUtil.selector.span.getSelecteds().forEach(function(c){a.addSpanId(c),f.annotationData.getSpan(c).getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),h.domUtil.selector.entity.getSelecteds().forEach(function(a){b(a)}),a.addRelations(h.domUtil.selector.relation.getSelecteds()),h.domUtil.selector.relation.emptyRelationIdsSelected(),i.command.invoke(a.getAll())},copyEntities:function(){h.viewModel.clipBoard=function(){return h.domUtil.selector.span.getSelecteds().map(function(a){return f.annotationData.getSpan(a).getTypes().map(function(a){return a.entities}).reduce(function(a,b){return a.concat(b)})}).reduce(function(a,b){return a.concat(b)},[])}().concat(h.domUtil.selector.entity.getSelecteds()).reduce(function(a,b){return a.indexOf(b)<0&&a.push(b),a},[])},pasteEntities:function(){var a=h.domUtil.selector.span.getSelecteds().map(function(a){return h.viewModel.clipBoard.map(function(b){return i.command.factory.entityCreateCommand(a,f.annotationData.entities[b].type)})}).reduce(function(a,b){return a.concat(b)},[]);i.command.invoke(a)}}}(),viewHandler:function(){var d={},e=function(){var c=function(a,b,c){var d=a();if(d.length>0){var e=d.map(function(a){return b(a,c)});i.command.invoke(e)}};return{relationEdit:function(){var e=function(a){if(0===h.domUtil.selector.entity.getSelecteds().length)h.domUtil.manipulate.selectOnly(a.target);else{var b=h.domUtil.selector.entity.getSelecteds()[0],c=$(a.target).attr("title");b===c?h.domUtil.selector.entity.deselect(b):(h.domUtil.selector.entity.select(c),window.setTimeout(function(){if(i.command.invoke([i.command.factory.relationCreateCommand(f.annotationData.getNewRelationId(),b,c,h.viewModel.typeContainer.relation.getDefaultType())]),a.ctrlKey)h.domUtil.selector.entity.deselect(c);else{if(a.shiftKey)return h.domUtil.manipulate.dismissBrowserSelection(),h.domUtil.selector.entity.deselect(b),h.domUtil.selector.entity.select(c),!1;h.domUtil.selector.entity.deselect(b),h.domUtil.selector.entity.deselect(c)}},50))}};b.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("selectChanged",".textae-editor__entity").off("mouseup",".textae-editor__entity").on("mouseup",".textae-editor__entity",e),d.typeContainer=h.viewModel.typeContainer.relation,a=c.bind(null,h.domUtil.selector.relation.getSelecteds,i.command.factory.relationChangePredicateCommand),H=G},noRelationEdit:function(){var e=function(a){if(a.ctrlKey)h.domUtil.manipulate.toggle(a.target);else{var b=$(a.target).parent();h.domUtil.manipulate.selectOnly(1===b.children().length?b.prev().add(b.children()):a.target)}return!1};b.on("mouseup",".textae-editor__body",z).on("mouseup",".textae-editor__span",A).on("mouseup",".textae-editor__type-label",C).on("mouseup",".textae-editor__entity-pane",D).on("selectChanged",".textae-editor__entity",F).off("mouseup",".textae-editor__entity").on("mouseup",".textae-editor__entity",e),d.typeContainer=h.viewModel.typeContainer.entity,a=c.bind(null,h.domUtil.selector.entity.getSelecteds,i.command.factory.entityChangeTypeCommand),H=null}}}(),g=function(){var a=function(){i.userEvent.viewHandler.hidePallet(),h.domUtil.manipulate.unselect()},b={toTerm:function(){a(),e.noRelationEdit(),h.viewModel.viewMode.setTerm(),h.renderer.helper.redraw(),g=c.termCentric},toInstance:function(){a(),e.noRelationEdit(),h.viewModel.viewMode.setInstance(),h.renderer.helper.redraw(),g=c.instanceRelation},toRelation:function(){a(),e.relationEdit(),h.viewModel.viewMode.setRelation(),h.renderer.helper.redraw(),g=c.relationEdit}},c={termCentric:{name:"Term Centric",onInstance:b.toInstance,onRelation:b.toRelation},instanceRelation:{name:"Instance / Relation",onRelation:b.toRelation,offInstance:b.toTerm},relationEdit:{name:"Relation Edit",offRelation:b.toInstance,offInstance:b.toTerm}};return{init:function(){b.toTerm()}}}();return{init:function(){g.init()},showPallet:function(a){var b=function(a){return function(){i.userEvent.viewHandler.hidePallet(),a.call(this)}},c=function(a){return a.getSortedNames().map(function(c){var d=$("<td>").append(function(){var d=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:c}).change(b(function(){return a.setDefaultType($(this).attr("label")),!1}));return c===a.getDefaultType()&&d.attr({title:"default type",checked:"checked"}),d}()),e=$("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",c).text(c),f=$("<td>"),g=a.getUri(c);return g&&f.append($("<a>").attr({href:g,target:"_blank"}).append($("<span>").addClass("textae-editor__entity-pallet__link"))),$("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":a.getColor(c)}).append([d,e,f])})},e=function(a){var c=$(".textae-editor__entity-pallet");return 0===c.length?(c=$("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__entity-pallet__entity-type__label",b(a)).hide(),$("body").append(c)):(c.find("table").empty(),c.css("width","auto")),c}(i.userEvent.editHandler.setEntityType);e.find("table").append(c(d.typeContainer)),e.outerHeight()+"px"===e.css("max-height")?e.css("overflow-y","scroll"):e.css("overflow-y",""),e.css(1===arguments.length?{top:a.top,left:a.left}:{top:10,left:20}),e.show()},hidePallet:function(){$(".textae-editor__entity-pallet").hide()},redraw:function(){h.renderer.helper.redraw()},cancelSelect:function(){return window.getSelection().isCollapsed?(h.domUtil.manipulate.unselect(),i.userEvent.viewHandler.hidePallet(),void b.tool.cancel()):(h.domUtil.manipulate.dismissBrowserSelection(),!0)},selectLeftSpan:function(){if(h.domUtil.selector.span.isSelectOne()){var a=f.annotationData.getSpan(h.domUtil.selector.span.getSelecteds()[0]);h.domUtil.manipulate.unselect(),a.left&&h.domUtil.selector.span.select(a.left.id)}},selectRightSpan:function(){if(h.domUtil.selector.span.isSelectOne()){var a=f.annotationData.getSpan(h.domUtil.selector.span.getSelecteds()[0]);h.domUtil.manipulate.unselect(),a.right&&h.domUtil.selector.span.select(a.right.id)}},showSettingDialog:function(){var a=$("<div>").addClass("textae-editor__setting-dialog");a.append($("<div>").append("<label>Line Height:").append($("<input>").attr({type:"number",step:1,min:3,max:10,value:4}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){var a=$(this).val();window.setTimeout(function(){i.userEvent.viewHandler.changeLineHeight(a)})}),a.append($("<div>").append("<label>Instance/Relation View:").append($("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view"))).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?g.onInstance():g.offInstance()});var d=c.getDialog(b.editorId,"textae.dialog.setting","Chage Settings",a,!0);d.find(".textae-editor__setting-dialog__term-centric-view").prop({checked:h.viewModel.viewMode.isTerm()?null:"checked"}),d.open()},changeLineHeight:function(a){h.renderer.helper.changeLineHeight(a),$(window).trigger("resize")},toggleRelationEditMode:function(){h.viewModel.modeAccordingToButton["relation-edit-mode"].value()?g.offRelation():g.onRelation()}}}()}}();return{init:function(){b.on("mousedown",function(a){return a.shiftKey?!1:void 0}),b.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",J).on("selectChanged",".textae-editor__span",E).on("selectChanged",".textae-editor__entity",F),b.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bind("click",I)}),i.command.init(function(){h.viewModel.buttonStateHelper.enabled("write",this.hasAnythingToSave()),h.viewModel.buttonStateHelper.enabled("undo",this.hasAnythingToUndo()),h.viewModel.buttonStateHelper.enabled("redo",this.hasAnythingToRedo()),window.onbeforeunload=this.hasAnythingToSave()?function(){return"There is a change that has not been saved. If you leave now, you will lose it."}:null}),i.userEvent.viewHandler.init()},command:K,userEvent:L}}(this);return this.api={start:function(){i.init(),h.init(),f.init()},handleKeyInput:function(a){var b={A:d.showAccess,C:i.userEvent.editHandler.copyEntities,D:i.userEvent.editHandler.removeSelectedElements,DEL:i.userEvent.editHandler.removeSelectedElements,E:i.userEvent.editHandler.createEntity,Q:i.userEvent.viewHandler.showPallet,R:i.userEvent.editHandler.replicate,S:d.showSave,V:i.userEvent.editHandler.pasteEntities,W:i.userEvent.editHandler.newLabel,X:i.command.redo,Y:i.command.redo,Z:i.command.undo,ESC:i.userEvent.viewHandler.cancelSelect,LEFT:i.userEvent.viewHandler.selectLeftSpan,RIGHT:i.userEvent.viewHandler.selectRightSpan};b[a]&&b[a]()},handleButtonClick:function(a){var b={"textae.control.button.read.click":d.showAccess,"textae.control.button.write.click":d.showSave,"textae.control.button.undo.click":i.command.undo,"textae.control.button.redo.click":i.command.redo,"textae.control.button.replicate.click":i.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":h.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":i.userEvent.viewHandler.toggleRelationEditMode,"textae.control.button.entity.click":i.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":i.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":function(){i.userEvent.viewHandler.showPallet(a.point)},"textae.control.button.delete.click":i.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":i.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":i.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":i.userEvent.viewHandler.showSettingDialog};b[a.name]()},redraw:i.userEvent.viewHandler.redraw},this},e=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=function(a){this.buttonClick({name:e.eventName,point:{top:a.clientY-this.get(0).offsetTop,left:a.clientX-this.get(0).offsetLeft}})}.bind(this);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b,c){var d=f[b].instance;c?a.push(d):a.unpush(d)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateButtonPushState=e,this},f=function(){{var a={control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:c.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),about:c.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>今ご覧になっているTextAEはPubAnnotationで管理しているアノテーションのビューアもしくはエディタです。</p><p>PubAnnotationではPubMedのアブストラクトにアノテーションを付けることができます。</p><p>現在はEntrez Gene IDによる自動アノテーションおよびそのマニュアル修正作業が可能となっています。今後は自動アノテーションの種類を増やす計画です。</p><p>間違ったアノテーションも目に付くと思いますが、それを簡単に直して自分のプロジェクトにセーブできるのがポイントです。</p><p>自分のアノテーションを作成するためにはPubAnnotation上で自分のプロジェクトを作る必要があります。作成したアノテーションは後で纏めてダウンロードしたり共有することができます。</p><p>まだ開発中のサービスであり、実装すべき機能が残っています。ユーザの皆様の声を大事にして開発していきたいと考えておりますので、ご意見などございましたら教えていただければ幸いです。</p>")}}),hideAll:function(){a.infoModals.help.hide(),a.infoModals.about.hide()}}},b={handleKeyInput:function(b){"H"===b?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(b),"ESC"===b&&a.infoModals.hideAll())},handleButtonClick:function(b){switch(b.name){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(b)}},handleEditor:{select:function(b){a.editors.select(b)},"public":{cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b){a.control.updateAllButtonEnableState(b)},pushReplicateAuto:function(b){a.control.updateReplicateAutoButtonPushState(b)},push:function(b,c){a.control.updateButtonPushState(b,c)}}}};!function(){var c=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},c=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},d=!0,e=function(a){d&&b.handleKeyInput(c(a.keyCode))};$(document).on("keyup",e),$("body").on("dialogopen",".ui-dialog",function(){d=!1}).on("dialogclose",".ui-dialog",function(){d=!0})},d=function(){$(window).on("resize",function(){var b;return function(){b&&window.clearTimeout(b),b=window.setTimeout(function(){a.editors.forEach(function(a){a.api.redraw()})},200)}}())};$(function(){c(),d()})}()}return{setControl:function(c){$.extend(c,{buttonClick:function(a){b.handleButtonClick(a)}}),a.control=c},pushEditor:function(c){a.editors.push(c),$.extend(c,{editorId:a.editors.getNewId(),tool:$.extend({selectMe:b.handleEditor.select.bind(null,c)},b.handleEditor.public)})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return f.pushEditor(a),d.apply(a),a.api.start(),a}),f.selectFirstEditor();else if(this.hasClass("textae-control")){var a=e.apply(this);return f.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);